<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêang l·ª±a B√°nh...</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f7f8; color: #fff; margin: 0; }
    header { background: #f5cf8e; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 20px; }
    nav { display: flex; gap: 12px; flex-wrap: wrap; }
    nav button { background: #f9f7f8;; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
    nav button:hover { background: black; }
    .container { padding: 20px; }
    .movie-detail { display: flex; gap: 20px; flex-wrap: wrap; }
    .movie-poster img { width: 100%; max-width: 300px; aspect-ratio: 2/3; object-fit: cover; border-radius: 8px; }
    .movie-info { flex: 1; min-width: 250px; }
    .movie-info h2 { margin: 0 0 10px; font-size: 20px; }
    .movie-info p { margin: 5px 0; font-size: 14px; color: #fce1d4; }
    .movie-info .buttons { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    .movie-info .buttons button { background: #f5cf8e; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .movie-info .buttons button:hover { background: black; }
    .episode-list { margin-top: 40px; }
    .episode-list h2 { font-size: 18px; margin-bottom: 10px; }
    .episode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .episode-card { background: #f5cf8e; border-radius: 8px; text-align: center; padding: 10px; cursor: pointer; transition: background .2s; }
    .episode-card:hover { background: black; }
    .episode-card p { margin: 0; font-size: 14px; }
    .embed-links { margin-top: 20px; display: none; }
    .embed-links.active { display: block; }
    .embed-links h3 { font-size: 16px; margin-bottom: 10px; }
    .embed-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    .embed-btn { background: #cac9ca; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 14px; transition: background .2s; }
    .embed-btn:hover { background: black; }
  </style>
</head>
<body>
  <header>
    <h1>B√°nh ƒêang ƒê∆∞·ª£c Giao...üöÄ</h1>
    <nav>
      <button onclick="window.location.href='index.html'">Ti·ªám B√°nh</button>
    </nav>
  </header>

  <div class="container">
    <div id="movieDetail" class="movie-detail"></div>
    <div id="episodeList" class="episode-list">
      <h2>B·∫£ng Kh√°ch Order B√°nh m√¨ü•ñ</h2>
      <div id="episodes"></div>
    </div>
    <div id="embedLinks" class="embed-links">
      <h3>B√°nh M√¨ Kh√°cü•ñ</h3>
      <div id="embedList" class="embed-grid"></div>
    </div>
  </div>

<script>
  const API_BASES = {
    source1: "https://ophim1.com/v1/api",
    source2: "https://phimapi.com",
    source3: "https://phim.nguonc.com/api"
  };
  const movieDetail = document.getElementById("movieDetail");
  const episodes = document.getElementById("episodes");
  const embedLinks = document.getElementById("embedLinks");
  const embedList = document.getElementById("embedList");

  const urlParams = new URLSearchParams(window.location.search);
  const slug = urlParams.get("slug");
  const source = urlParams.get("source") || "source1";

  // Chu·∫©n h√≥a d·ªØ li·ªáu phim
  function normalizeMovieDetails(movie, source, extraEpisodes = []) {
    if (source === "source1") {
      return {
        name: movie.name,
        thumb_url: movie.thumb_url,
        year: movie.year || "N/A",
        category: movie.category?.map(cat => cat.name).join(", ") || "",
        country: movie.country?.map(c => c.name).join(", ") || "",
        director: movie.director?.join(", ") || "",
        actor: movie.actor?.join(", ") || "",
        time: movie.time || "N/A",
        episode_current: movie.episode_current || "N/A",
        quality: movie.quality || "N/A",
        lang: movie.lang || "N/A",
        content: movie.content || "Kh√¥ng c√≥ m√¥ t·∫£.",
        servers: movie.episodes || []
      };
    } else if (source === "source2") {
      return {
        name: movie.name || movie.title,
        thumb_url: movie.poster_url || movie.thumb_url || "",
        year: movie.year || "N/A",
        category: movie.category?.map(cat => cat.name).join(", ") || "",
        country: movie.country?.map(c => c.name).join(", ") || "",
        director: movie.director?.join(", ") || "",
        actor: movie.actor?.join(", ") || "",
        time: movie.time || "N/A",
        episode_current: movie.episode_current || movie.status || "N/A",
        quality: movie.quality || "N/A",
        lang: movie.lang || movie.language || "N/A",
        content: movie.content || "Kh√¥ng c√≥ m√¥ t·∫£.",
        servers: extraEpisodes || []
      };
    } else if (source === "source3") {
      return {
        name: movie.name,
        thumb_url: movie.poster_url || "",
        year: movie.category?.[3]?.list?.[0]?.name || "N/A",
        category: movie.category?.[2]?.list?.map(cat => cat.name).join(", ") || "",
        country: movie.category?.[4]?.list?.[0]?.name || "",
        director: movie.director || "",
        actor: movie.casts || "",
        time: movie.time || "N/A",
        episode_current: movie.current_episode || "N/A",
        quality: movie.quality || "N/A",
        lang: movie.language || "N/A",
        content: movie.description || "Kh√¥ng c√≥ m√¥ t·∫£.",
        servers: movie.episodes || []
      };
    }
  }

  async function fetchMovieDetails() {
    if (!slug) {
      movieDetail.innerHTML = "<p>‚ùå Kh√¥ng t√¨m th·∫•y slug phim.</p>";
      return;
    }

    try {
      let url = source === "source1"
        ? `${API_BASES.source1}/phim/${slug}`
        : source === "source2"
          ? `${API_BASES.source2}/phim/${slug}`
          : `${API_BASES.source3}/film/${slug}`;

      const res = await fetch(url);
      const json = await res.json();

      let movie, extraEpisodes = [];
      if (source === "source1") {
        movie = json.data?.item;
      } else if (source === "source2") {
        movie = json.movie;
        extraEpisodes = json.episodes || [];
      } else {
        movie = json.movie;
      }

      if (!movie) {
        movieDetail.innerHTML = "<p>‚ùå Kh√¥ng t√¨m th·∫•y phim.</p>";
        return;
      }

      const normalized = normalizeMovieDetails(movie, source, extraEpisodes);

      // L·∫•y t·∫≠p ƒë·∫ßu ti√™n cho n√∫t Xem ngay
      let firstEp;
      if (normalized.servers?.length) {
        const server = normalized.servers[0];
        firstEp = (server.server_data || server.items || [])[0];
      }
      const firstM3u8 = firstEp?.m3u8 || firstEp?.link_m3u8 || "";
      const firstEmbed = firstEp?.embed || firstEp?.link_embed || "";

      const cdnImage = source === "source1" ? json.data?.APP_DOMAIN_CDN_IMAGE || "https://ophim1.com" : "";

      // Th√¥ng tin phim + n√∫t
      movieDetail.innerHTML = `
        <div class="movie-poster">
          <img src="${source === "source1" ? `${cdnImage}/uploads/movies/${normalized.thumb_url}` : normalized.thumb_url || 'https://via.placeholder.com/300x450'}" alt="${normalized.name}">
        </div>
        <div class="movie-info">
          <h2>${normalized.name}</h2>
          <p><strong>NƒÉm:</strong> ${normalized.year}</p>
          <p><strong>Th·ªÉ lo·∫°i:</strong> ${normalized.category}</p>
          <p><strong>Qu·ªëc gia:</strong> ${normalized.country}</p>
          <p><strong>ƒê·∫°o di·ªÖn:</strong> ${normalized.director}</p>
          <p><strong>Di·ªÖn vi√™n:</strong> ${normalized.actor}</p>
          <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${normalized.time}</p>
          <p><strong>Tr·∫°ng th√°i:</strong> ${normalized.episode_current}</p>
          <p><strong>Ch·∫•t l∆∞·ª£ng:</strong> ${normalized.quality}</p>
          <p><strong>Ng√¥n ng·ªØ:</strong> ${normalized.lang}</p>
          <p><strong>N·ªôi dung:</strong> ${normalized.content}</p>
          <div class="buttons">
            ${firstM3u8 
              ? `<button onclick="window.location.href='watch.html?slug=${slug}&source=${source}&m3u8=${encodeURIComponent(firstM3u8)}&ep=${encodeURIComponent(firstEp?.name || "T·∫≠p 1")}&embed=${encodeURIComponent(firstEmbed || "")}'">ƒÇn B√°nh M√¨ + 5k Ship :)) ùêñùêÑùêãùêÇùêéùêåùêÑ</button>` 
              : firstEmbed 
                ? `<button onclick="window.location.href='watch.html?slug=${slug}&source=${source}&embed=${encodeURIComponent(firstEmbed)}&ep=${encodeURIComponent(firstEp?.name || "T·∫≠p 1")}'">ƒÇn B√°nh M√¨ + Giao</button>` 
                : ""
            }
            <button id="toggleEmbed">Ch·ªçn B√°nh Kh√°c V√† Ra Kh·ªèi Ti·ªámüõ∞Ô∏è</button>
          </div>
        </div>
      `;

      // Danh s√°ch t·∫≠p theo server
      episodes.innerHTML = "";
      normalized.servers.forEach((server, sIndex) => {
        const serverBlock = document.createElement("div");
        serverBlock.innerHTML = `<h3>${server.server_name || "Server " + (sIndex+1)}</h3>`;
        
        const grid = document.createElement("div");
        grid.className = "episode-grid";
        
        (server.server_data || server.items || []).forEach((ep, i) => {
          const epCard = document.createElement("div");
          epCard.className = "episode-card";
          epCard.innerHTML = `<p>${ep.name || "T·∫≠p " + (i+1)}</p>`;
          epCard.onclick = () => {
            const linkM3u8 = ep.m3u8 || ep.link_m3u8;
            const linkEmbed = ep.embed || ep.link_embed;
            if (linkM3u8) {
              window.location.href = `watch.html?slug=${slug}&source=${source}&m3u8=${encodeURIComponent(linkM3u8)}&ep=${encodeURIComponent(ep.name || i+1)}&embed=${encodeURIComponent(linkEmbed || "")}`;
            } else if (linkEmbed) {
              window.location.href = `watch.html?slug=${slug}&source=${source}&embed=${encodeURIComponent(linkEmbed)}&ep=${encodeURIComponent(ep.name || i+1)}`;
            }
          };
          grid.appendChild(epCard);
        });
        
        serverBlock.appendChild(grid);
        episodes.appendChild(serverBlock);
      });

      // Embed ngo√†i
      document.getElementById("toggleEmbed").onclick = () => {
        embedLinks.classList.toggle("active");
        if (embedLinks.classList.contains("active")) {
          embedList.innerHTML = "";
          normalized.servers.forEach((server, sIndex) => {
            (server.server_data || server.items || []).forEach((ep, i) => {
              const link = ep.embed || ep.link_embed;
              if (link) {
                const btn = document.createElement("button");
                btn.className = "embed-btn";
                btn.textContent = `${server.server_name || "Server"} - ${ep.name || "T·∫≠p " + (i+1)}`;
                btn.onclick = () => window.open(link, "_blank");
                embedList.appendChild(btn);
              }
            });
          });
          if (!embedList.innerHTML) embedList.innerHTML = "<p>Kh√¥ng c√≥ ngu·ªìn ngo√†i.</p>";
        }
      };

    } catch (e) {
      console.error("‚ùå L·ªói:", e);
      movieDetail.innerHTML = "<p>Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu phim.</p>";
    }
  }

  fetchMovieDetails();
</script>
</body>
</html>
