<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xem phim</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #201a1a; color: #d37b0a; margin: 0; padding: 20px; }
    h1 { font-size: 25px; margin-bottom: 38px; text-align: center; }
    #playerWrapper { max-width: 900px; margin: auto; }
    iframe, video { width: 100%; height: 400px; border-radius: 8px; background: black; }
    .tabs, .controls, .back-links { margin: 15px auto; text-align: center; }
    button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 14px; font-size: 14px; }
    .tabs button { background: #333; color: #fff; margin: 0 5px; }
    .tabs button.active { background: #64411c; }
    .controls button { background: #3e1b1aad; color: white; margin: 4px; }
    .controls button:hover { background: #503517; }
    .back-links button { background: #444; color: #fff; margin: 5px; }
    .back-links button:hover { background: #503517; }
    .server-block { max-width: 900px; margin: 20px auto; background: #1b1b1b; border-radius: 6px; padding: 10px; }
    .server-block h3 { margin: 5px 0 10px; font-size: 16px; color: #4da6ff; }
    .episode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
    .episode-card { background: #2a2a2a; padding: 6px; text-align: center; border-radius: 4px; }
    .episode-card:hover { background: #444; }
    .episode-card.active { background: #503517; font-weight: bold; }
  </style>
</head>
<body>
  <h1 id="movieTitle">Đang xem phim...</h1>

  <div id="playerWrapper">
    <video id="player" playsinline controls></video>
  </div>

  <div class="tabs">
    <button id="mainTab">Nguồn Website Giao Bánh</button>
    <button id="embedTab">Nguồn Bên Ngoài Giao Bánh</button>
  </div>

  <div class="controls">
    <button id="prevEp">⏮ </button>
    <button id="rewind">◀ Lùi </button>
    <button id="forward">▶ Tiến </button>
    <button id="nextEp">⏭ </button>
  </div>

  <div id="servers"></div>

  <div class="back-links">
    <button onclick="window.location.href='detail.html?slug=' + slug + '&source=' + source">Quay lại Nơi Giao Bánh</button>
    <button onclick="window.location.href='index.html'">Quay lại Tiệm Bánh Mì</button>
  </div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const slug = urlParams.get("slug");
  const source = urlParams.get("source") || "source1";
  let currentEp = decodeURIComponent(urlParams.get("ep") || "");
  let m3u8 = decodeURIComponent(urlParams.get("m3u8") || "");
  let embed = decodeURIComponent(urlParams.get("embed") || "");

  const API_BASES = {
    source1: "https://ophim1.com/v1/api",
    source2: "https://phimapi.com",
    source3: "https://phim.nguonc.com/api"
  };

  let player;

  function initPlayer(src) {
    document.getElementById("playerWrapper").innerHTML = `<video id="player" playsinline controls></video>`;
    const video = document.getElementById("player");
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(src);
      hls.attachMedia(video);
    } else {
      video.src = src;
    }
    player = new Plyr(video);
  }

  function loadEmbed(link) {
    document.getElementById("playerWrapper").innerHTML = `<iframe src="${link}" allowfullscreen></iframe>`;
  }

  function updateTabs(mode) {
    document.getElementById("mainTab").classList.toggle("active", mode === "m3u8");
    document.getElementById("embedTab").classList.toggle("active", mode === "embed");
  }

  function highlightEpisode(epId) {
    document.querySelectorAll(".episode-card").forEach(card => {
      card.classList.toggle("active", card.dataset.ep === epId);
    });
  }

  async function fetchEpisodes() {
    try {
      let url = source === "source1" 
        ? `${API_BASES.source1}/phim/${slug}` 
        : source === "source2" 
          ? `${API_BASES.source2}/phim/${slug}` 
          : `${API_BASES.source3}/film/${slug}`;

      const res = await fetch(url);
      const json = await res.json();

      let movie, servers = [];
      if (source === "source1") {
        movie = json.data?.item || {};
        servers = movie.episodes || [];
      } else if (source === "source2") {
        movie = json.movie || {};
        servers = json.episodes || [];
      } else {
        movie = json.movie || {};
        servers = movie.episodes || [];
      }

      document.getElementById("movieTitle").textContent = `${movie.name || "Phim"} - ${currentEp || "Tập ?"}`;

      // render servers
      const serversContainer = document.getElementById("servers");
      serversContainer.innerHTML = "";
      servers.forEach(server => {
        const block = document.createElement("div");
        block.className = "server-block";
        block.innerHTML = `<h3>#${server.server_name || "Server"}</h3>`;
        const grid = document.createElement("div");
        grid.className = "episode-grid";
        (server.server_data || server.items || []).forEach((ep, idx) => {
          const card = document.createElement("div");
          card.className = "episode-card";
          card.dataset.ep = ep.name || `Tập ${idx+1}`;
          card.textContent = ep.name || `Tập ${idx+1}`;
          card.onclick = () => {
            const linkM3u8 = ep.m3u8 || ep.link_m3u8;
            const linkEmbed = ep.embed || ep.link_embed;
            if (linkM3u8) {
              window.location.href = `watch.html?slug=${slug}&source=${source}&m3u8=${encodeURIComponent(linkM3u8)}&ep=${encodeURIComponent(card.dataset.ep)}&embed=${encodeURIComponent(linkEmbed || "")}`;
            } else if (linkEmbed) {
              window.location.href = `watch.html?slug=${slug}&source=${source}&embed=${encodeURIComponent(linkEmbed)}&ep=${encodeURIComponent(card.dataset.ep)}`;
            }
          };
          grid.appendChild(card);
        });
        block.appendChild(grid);
        serversContainer.appendChild(block);
      });

      highlightEpisode(currentEp);

      // init default player
      if (m3u8) { initPlayer(m3u8); updateTabs("m3u8"); }
      else if (embed) { loadEmbed(embed); updateTabs("embed"); }

      // tab switching
      document.getElementById("mainTab").onclick = () => { if (m3u8) { initPlayer(m3u8); updateTabs("m3u8"); } };
      document.getElementById("embedTab").onclick = () => { if (embed) { loadEmbed(embed); updateTabs("embed"); } };

      // Prev/Next episode
      const epNodes = [...document.querySelectorAll(".episode-card")];
      const currentIndex = epNodes.findIndex(c => c.dataset.ep === currentEp);
      document.getElementById("prevEp").onclick = () => { if (currentIndex > 0) epNodes[currentIndex - 1].click(); };
      document.getElementById("nextEp").onclick = () => { if (currentIndex < epNodes.length - 1) epNodes[currentIndex + 1].click(); };

      // Rewind / Forward
      document.getElementById("rewind").onclick = () => player?.rewind(10);
      document.getElementById("forward").onclick = () => player?.forward(10);

    } catch (e) {
      console.error("Lỗi tải tập:", e);
    }
  }

  fetchEpisodes();
</script>
</body>
</html>
