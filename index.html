<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phim Nh√† B√°nh M√¨</title>
  <style>
    body { font-family: Arial, sans-serif; background: rgb(34, 33, 33); color: #fff; margin: 0; }
    header { background: #75462f; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    header h1 { margin: 0; font-size: 20px; }
    nav { display: flex; gap: 12px; flex-wrap: wrap; }
    nav select, nav button, nav input { background: #222; color: #e0921d; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
    nav input { flex: 1; min-width: 200px; }
    .container { padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
    .card { background: #75462f; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform .2s; position: relative; }
    .card:hover { transform: scale(1.05); }
    .card img { width: 100%; height: 240px; object-fit: cover; display: block; }
    .year-tag { position: absolute; top: 8px; left: 8px; background: #a3491f; color: #fff; padding: 2px 6px; font-size: 12px; border-radius: 4px; }
    .card h3 { margin: 8px; font-size: 14px; }
    .card p { margin: 0 8px 10px; font-size: 12px; color: black; }
    .pagination { margin: 20px 0; text-align: center; }
    .pagination button { margin: 4px 5px; padding: 2px 8px; border: none; border-radius: 5px; background: #444; color: #fff; cursor: pointer; }
    .pagination button.active { background: #75462f; }
    .toggle-btn { margin-bottom: 1px; padding: 2px 12px; background: #693810; border-radius: 4px; cursor: pointer; border: none; color: #fff; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <h1>ü•ñ B√°nh m√¨ N√≥ng ƒê√¢yyy...</h1>
    <nav>
      <select id="sourceSelect">
        <option value="source1">ü•ñ N√≥ng Gi√≤n</option>
        <option value="source2">ü•ñ ƒê·∫∑c Ru·ªôt</option>
        <option value="source3">ü•ñ B√°nh m√¨...</option>
      </select>
      <select id="genreSelect"></select>
      <select id="countrySelect"></select>
      <select id="yearSelect"></select>
      <select id="languageSelect"></select>
      <button id="filterBtn">‚õè L·ªçc</button>
      <input id="searchInput" type="text" placeholder="T√¨m phim...">
      <button id="searchBtn">üîçÔ∏é</button>
    </nav>
  </header>

  <div class="container">
    <h2 id="pageTitle">ü•ñ B√°nh Ra L√≤...</h2>
    <div id="movies" class="grid"></div>
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- Container ph·ª• cho H√†n Qu·ªëc -->
  <div class="container" id="koreanContainer">
    <button class="toggle-btn" onclick="toggleSection('koreanMovies')">·∫®n/Hi·ªán B√°nh H√†n Qu·ªëc</button>
    <h2>B√°nh H√†n Qu·ªëc</h2>
    <div id="koreanMovies" class="grid"></div>
  </div>

  <!-- Container ph·ª• cho Trung Qu·ªëc -->
  <div class="container" id="chinaContainer">
    <button class="toggle-btn" onclick="toggleSection('moviesChina')">·∫®n/Hi·ªán B√°nh Trung Qu·ªëc</button>
    <h2>B√°nh Trung Qu·ªëc</h2>
    <div id="moviesChina" class="grid"></div>
  </div>

<script>
const API_BASES = {
  source1: "https://ophim1.com/v1/api",
  source2: "https://phimapi.com",
  source3: "https://phim.nguonc.com/api"
};
const IMG_BASES = {
  source1: "",
  source2: "https://img.phimapi.com",
  source3: "https://phim.nguonc.com"
};

const moviesEl = document.getElementById("movies");
const paginationEl = document.getElementById("pagination");
const sourceSelect = document.getElementById("sourceSelect");
const genreSelect = document.getElementById("genreSelect");
const countrySelect = document.getElementById("countrySelect");
const yearSelect = document.getElementById("yearSelect");
const languageSelect = document.getElementById("languageSelect");
const filterBtn = document.getElementById("filterBtn");
const searchInput = document.getElementById("searchInput");
const koreanMoviesEl = document.getElementById("koreanMovies");
const chinaMoviesEl = document.getElementById("moviesChina");
const koreanContainer = document.getElementById("koreanContainer");
const chinaContainer = document.getElementById("chinaContainer");

// toggle m·ªü/thu
function toggleSection(id) {
  const section = document.getElementById(id);
  section.classList.toggle("hidden");
}

// danh s√°ch th·ªÉ lo·∫°i, qu·ªëc gia, nƒÉm, ng√¥n ng·ªØ
const genres = ["hanh-dong","hai-huoc","tinh-cam","tam-ly","co-trang","vo-thuat","chien-tranh","kinh-di","than-thoai","phieu-luu","hoat-hinh","phim-18","vien-tuong","tai-lieu","bi-an","the-thao","am-nhac","gia-dinh","hoc-duong","hinh-su","khoa-hoc","chinh-kich"];
const countries = ["trung-quoc","han-quoc","nhat-ban","thai-lan","au-my","dai-loan","hong-kong","an-do","anh","phap","canada","quoc-gia-khac","duc","tay-ban-nha","tho-nhi-ky","ha-lan","indonesia","nga","mexico","ba-lan","uc","thuy-dien","malaysia","brazil","philippines","bo-dao-nha","y","dan-mach","uae","na-uy","thuy-si","chau-phi","nam-phi","ukraina","a-rap-xe-ut","bi","ireland","colombia","phan-lan","viet-nam","chile","hy-lap","nigeria","argentina","singapore","new-zealand"];
const years = Array.from({ length: 30 }, (_, i) => 2029 - i);
const languages = ["phim-moi","phim-bo","phim-le","tv-shows","hoat-hinh","phim-vietsub","phim-thuyet-minh","phim-long-tieng","long-tieng","thuyet-minh","subteam","phim-bo-dang-chieu","phim-bo-hoan-thanh","phim-sap-chieu","phim-chieu-rap"];

function populateSelect(select, items, label) {
  select.innerHTML = `<option value="">${label}</option>`;
  items.forEach(item => {
    select.innerHTML += `<option value="${item}">${item}</option>`;
  });
}
populateSelect(genreSelect, genres, "üòé Th·ªÉ lo·∫°i");
populateSelect(countrySelect, countries, "‚≠êÔ∏è Qu·ªëc gia");
populateSelect(yearSelect, years, "üìÖ NƒÉm");
populateSelect(languageSelect, languages, "ü§è Ng√¥n ng·ªØ/Danh s√°ch");

// chu·∫©n h√≥a d·ªØ li·ªáu phim
function normalizeMovieData(movie, source, cdnImage) {
  let thumb = movie.thumb_url || movie.poster_url || "";
  if (source === "source1" && thumb && !thumb.startsWith("http")) {
    thumb = `${cdnImage}/uploads/movies/${thumb.replace(/^\/+/, "")}`;
  }
  if (source === "source2" && thumb && !thumb.startsWith("http")) {
    thumb = `${IMG_BASES.source2}/${thumb.replace(/^\/+/, "")}`;
  }
  if (source === "source3" && thumb && !thumb.startsWith("http")) {
    thumb = `${IMG_BASES.source3}/${thumb.replace(/^\/+/, "")}`;
  }
  return {
    name: movie.name || movie.title,
    thumb_url: thumb,
    year: movie.year || "N/A",
    slug: movie.slug,
    episode_current: movie.episode_current || movie.episode_total || movie.status || movie.current_episode || "",
    quality: movie.quality || "",
    lang: movie.lang || movie.language || ""
  };
}

// render phim ra grid
function renderMovieCard(container, normalized, source) {
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <span class="year-tag">${normalized.year}</span>
    <img src="${normalized.thumb_url}" alt="${normalized.name}" loading="lazy">
    <h3>${normalized.name}</h3>
    <p>${normalized.episode_current} ${normalized.quality} ${normalized.lang}</p>
  `;
  card.addEventListener("click", () => {
    window.location.href = `detail.html?slug=${normalized.slug}&source=${source}`;
  });
  container.appendChild(card);
}

// fetchMovies ch√≠nh
async function fetchMovies({ page = 1, mode = "genre", search = "" } = {}) {
  const source = sourceSelect.value;
  const genre = genreSelect.value;
  const country = countrySelect.value;
  const year = yearSelect.value;
  const language = languageSelect.value;
  const limit = 10;
  let url = "";

  if (source === "source1") {
    if (search) url = `${API_BASES.source1}/tim-kiem?keyword=${encodeURIComponent(search)}&page=${page}&limit=${limit}`;
    else if (mode === "genre") url = `${API_BASES.source1}/the-loai/${genre||"hanh-dong"}?page=${page}&limit=${limit}`;
    else if (mode === "language") url = `${API_BASES.source1}/danh-sach/${language||"phim-moi"}?page=${page}&limit=${limit}`;
    if (!search && country) url += `&country=${country}`;
    if (!search && year) url += `&year=${year}`;
  } else if (source === "source2") {
    if (search) url = `${API_BASES.source2}/v1/api/tim-kiem?keyword=${encodeURIComponent(search)}&page=${page}&limit=${limit}`;
    else if (mode === "genre") url = `${API_BASES.source2}/v1/api/the-loai/${genre||"hanh-dong"}?page=${page}&limit=${limit}`;
    else if (mode === "language") url = `${API_BASES.source2}/danh-sach/${language||"phim-moi-cap-nhat"}?page=${page}&limit=${limit}`;
    if (!search && country) url += `&country=${country}`;
    if (!search && year) url += `&year=${year}`;
  } else if (source === "source3") {
    if (search) url = `${API_BASES.source3}/films/search?keyword=${encodeURIComponent(search)}&page=${page}&limit=${limit}`;
    else if (mode === "genre") url = `${API_BASES.source3}/films/the-loai/${genre||"hanh-dong"}?page=${page}&limit=${limit}`;
    else if (mode === "language") url = `${API_BASES.source3}/films/${language||"phim-moi-cap-nhat"}?page=${page}&limit=${limit}`;
    if (!search && country) url = `${API_BASES.source3}/films/quoc-gia/${country}?page=${page}&limit=${limit}`;
    if (!search && year) url = `${API_BASES.source3}/films/nam-phat-hanh/${year}?page=${page}&limit=${limit}`;
  }

  try {
    moviesEl.innerHTML = "‚è≥ ƒêang t·∫£i phim...";
    const res = await fetch(url);
    const json = await res.json();
    let data = [];
    let totalPages = 1;
    let cdnImage = "";

    if (source === "source1") {
      data = json.data?.items || [];
      totalPages = json.data?.params?.pagination?.totalPages || 60;
      cdnImage = json.data?.APP_DOMAIN_CDN_IMAGE || "";
    } else if (source === "source2") {
      data = json.data?.items || json.data?.movies || [];
      totalPages = json.data?.params?.pagination?.totalPages || 60;
    } else if (source === "source3") {
      data = json.data || json.items || [];
      totalPages = json.totalPages || 60;
    }

    if (!data.length) {
      moviesEl.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y phim.</p>";
      return;
    }

    moviesEl.innerHTML = "";
    data.forEach(movie => {
      const normalized = normalizeMovieData(movie, source, cdnImage);
      renderMovieCard(moviesEl, normalized, source);
    });

    paginationEl.innerHTML = "";
    for (let i = 1; i <= Math.min(totalPages, 2); i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === page) btn.classList.add("active");
      btn.addEventListener("click", () => fetchMovies({ page: i, mode, search }));
      paginationEl.appendChild(btn);
    }
  } catch (err) {
    console.error("L·ªói t·∫£i phim:", err);
    moviesEl.innerHTML = "<p>L·ªói t·∫£i d·ªØ li·ªáu phim.</p>";
  }
}

// load phim theo qu·ªëc gia
async function fetchCountryMovies(container, countrySlug) {
  const source = sourceSelect.value;
  let url = "";
  const limit = 40;

  if (source === "source1") url = `${API_BASES.source1}/quoc-gia/${countrySlug}?page=1&limit=${limit}`;
  else if (source === "source2") url = `${API_BASES.source2}/v1/api/quoc-gia/${countrySlug}?page=1&limit=${limit}`;
  else if (source === "source3") url = `${API_BASES.source3}/films/quoc-gia/${countrySlug}?page=1&limit=${limit}`;

  try {
    container.innerHTML = "‚è≥ ƒêang t·∫£i...";
    const res = await fetch(url);
    const json = await res.json();
    let data = [];

    if (source === "source1") data = json.data?.items || [];
    else if (source === "source2") data = json.data?.items || json.data?.movies || [];
    else if (source === "source3") data = json.data || json.items || [];

    container.innerHTML = "";
    data.forEach(movie => {
      const normalized = normalizeMovieData(movie, source, json.data?.APP_DOMAIN_CDN_IMAGE || "");
      renderMovieCard(container, normalized, source);
    });
  } catch (err) {
    console.error("L·ªói t·∫£i phim:", err);
    container.innerHTML = "<p>L·ªói t·∫£i d·ªØ li·ªáu.</p>";
  }
}

// event
filterBtn.addEventListener("click", () => {
  fetchMovies({ mode: languageSelect.value ? "language" : "genre" });
  koreanContainer.classList.add("hidden");
  chinaContainer.classList.add("hidden");
});
searchInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    fetchMovies({ search: searchInput.value.trim() });
    koreanContainer.classList.add("hidden");
    chinaContainer.classList.add("hidden");
  }
});
sourceSelect.addEventListener("change", () => {
  fetchMovies({ mode: "genre" });
  fetchCountryMovies(koreanMoviesEl, "han-quoc");
  fetchCountryMovies(chinaMoviesEl, "trung-quoc");
  koreanContainer.classList.remove("hidden");
  chinaContainer.classList.remove("hidden");
});

// load m·∫∑c ƒë·ªãnh
fetchMovies({ mode: "genre" });
fetchCountryMovies(koreanMoviesEl, "han-quoc");
fetchCountryMovies(chinaMoviesEl, "trung-quoc");
</script>
</body>
</html>
