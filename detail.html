<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Phim Hay - Chi tiết phim">
    <meta name="keywords" content="phim Hàn, phim bộ, phim lẻ, xem phim online">
    <meta name="author" content="Phim Hay">
    <title>Phim Hay - Chi tiết phim</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --primary-color: #ff1a1a;
            --primary-hover: #cc0000;
            --bg-dark: #141414;
            --bg-section: #221F1F;
            --text-gray: #B3B3B3;
            --text-white: #FFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-dark);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            gap: 15px;
        }

        .logo {
            max-height: 35px;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-menu a {
            color: var(--text-white);
            text-decoration: none;
            font-size: 1em;
            padding: 8px 15px;
            transition: color 0.3s ease;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }

        .movie-details {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }

        .movie-poster-container {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .movie-poster {
            width: 100%;
        }

        .movie-poster img {
            width: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        .watch-btn {
            display: inline-block;
            background: var(--primary-color);
            color: var(--text-white);
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 1.1em;
            text-align: center;
            transition: background 0.3s ease;
        }

        .watch-btn:hover {
            background: var(--primary-hover);
        }

        .movie-info {
            flex: 1;
        }

        .movie-info h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .movie-info p {
            font-size: 1.1em;
            color: var(--text-gray);
            margin-bottom: 10px;
        }

        .movie-info p strong {
            color: var(--text-white);
        }

        .related-movies {
            margin-top: 40px;
        }

        .related-movies h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .related-movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .related-movie {
            text-align: center;
        }

        .related-movie img {
            width: 100%;
            border-radius: 8px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .related-movie img:hover {
            transform: scale(1.05);
        }

        .related-movie p {
            font-size: 0.9em;
            color: var(--text-white);
            margin-top: 10px;
        }

        .episode-list {
            margin-top: 20px;
        }

        .episode-list h3 {
            font-size: 1.4em;
            color: var(--text-white);
            margin-bottom: 10px;
        }

        .episode-list ul {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .episode-list li {
            list-style: none;
        }

        .episode-list a {
            display: inline-block;
            padding: 10px 15px;
            background: var(--primary-color);
            color: var(--text-white);
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s ease;
            font-size: 1em;
        }

        .episode-list a:hover {
            background: var(--primary-hover);
        }

        @media (max-width: 768px) {
            .movie-details {
                flex-direction: column;
                align-items: center;
            }

            .movie-poster-container {
                flex: 0 0 auto;
                max-width: 300px;
                width: 100%;
            }

            .movie-info {
                text-align: center;
            }

            .movie-info h1 {
                font-size: 2em;
            }

            .watch-btn {
                font-size: 1em;
                padding: 8px 15px;
                width: 100%;
                max-width: 300px;
            }

            .related-movies-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 8px 10px;
            }

            .logo {
                max-height: 25px;
            }

            .nav-menu a {
                font-size: 0.85em;
                padding: 4px 8px;
            }

            .main-content {
                padding: 80px 15px 30px;
            }

            .movie-info h1 {
                font-size: 1.5em;
            }

            .movie-info p {
                font-size: 1em;
            }

            .related-movies-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://pngimg.com/d/free_PNG90750.png" alt="Phim Hay" class="logo">
            <div class="nav-menu">
                <a href="index.html">Trang chủ</a>
                <a href="phim-han.html">Phim Hàn</a>
                <a href="phim-trung.html">Phim Trung</a>
                <a href="phim-viet.html">Phim Việt</a>
                <a href="phim-my.html">Phim Mỹ</a>
                <a href="truyen-hinh.html">Truyền hình</a>
                <a href="hoat-hinh.html">Hoạt hình</a>
                <a href="khac.html">Khác</a>
            </div>
        </div>
    </header>
    <main class="main-content">
        <section class="movie-details">
            <div class="movie-poster-container">
                <div class="movie-poster">
                    <img id="movie-poster" src="poster-not-found.jpg" alt="Poster phim">
                </div>
                <a href="#" class="watch-btn" id="watch-btn">Xem phim</a>
            </div>
            <div class="movie-info">
                <h1 id="movie-title">Đang tải...</h1>
                <p><strong>Thể loại:</strong> <span id="movie-categories">Đang tải...</span></p>
                <p><strong>Quốc gia:</strong> <span id="movie-countries">Đang tải...</span></p>
                <p><strong>Năm:</strong> <span id="movie-year">Đang tải...</span></p>
                <p><strong>Thời lượng:</strong> <span id="movie-time">Đang tải...</span></p>
                <p><strong>Chất lượng:</strong> <span id="movie-quality">Đang tải...</span></p>
                <p><strong>Ngôn ngữ:</strong> <span id="movie-lang">Đang tải...</span></p>
                <p><strong>Đạo diễn:</strong> <span id="movie-directors">Đang tải...</span></p>
                <p><strong>Diễn viên:</strong> <span id="movie-actors">Đang tải...</span></p>
                <p><strong>Nội dung:</strong> <span id="movie-content">Đang tải...</span></p>
            </div>
        </section>
        <section class="related-movies" id="related-movies">
            <h2>Phim liên quan</h2>
            <div class="related-movies-grid" id="related-movies-grid"></div>
        </section>
    </main>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        const apiSource = urlParams.get('apiSource');
        const isCustom = apiSource === 'custom';
        const movieName = urlParams.get('name');
        const poster = urlParams.get('poster');
        const quality = urlParams.get('quality');
        const content = urlParams.get('content');
        const actors = urlParams.get('actors');
        const directors = urlParams.get('directors');
        const countries = urlParams.get('countries');
        const episodesParam = urlParams.get('episodes');
        const customEpisodesParam = urlParams.get('customEpisodes');
        const episodeTotal = parseInt(urlParams.get('episode_total')) || 1;
        const movieType = urlParams.get('type');

        const moviePoster = document.getElementById('movie-poster');
        const movieTitle = document.getElementById('movie-title');
        const movieCategories = document.getElementById('movie-categories');
        const movieCountries = document.getElementById('movie-countries');
        const movieYear = document.getElementById('movie-year');
        const movieTime = document.getElementById('movie-time');
        const movieQuality = document.getElementById('movie-quality');
        const movieLang = document.getElementById('movie-lang');
        const movieDirectors = document.getElementById('movie-directors');
        const movieActors = document.getElementById('movie-actors');
        const movieContent = document.getElementById('movie-content');
        const watchBtn = document.getElementById('watch-btn');
        const relatedMoviesGrid = document.getElementById('related-movies-grid');

        function normalizeMovieData(data, apiSource) {
            const movie = data.movie;
            let categories = [], countries = [], year = movie.year, episodes = [], servers = [];

            if (apiSource === 'ophim1') {
                categories = movie.category?.map(c => c.name) || [];
                countries = movie.country?.map(c => c.name) || [];
                servers = data.episodes?.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: (server.server_data || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    }))
                })) || [];
            } else if (apiSource === 'phimapi') {
                categories = movie.category?.map(c => c.name) || [];
                countries = movie.country?.map(c => c.name) || [];
                servers = data.episodes?.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: (server.server_data || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    }))
                })) || [];
            } else if (apiSource === 'phimnguonc') {
                if (movie.category && typeof movie.category === 'object') {
                    Object.values(movie.category).forEach(group => {
                        if (group.group.name === 'Thể loại') {
                            categories = group.list.map(item => item.name);
                        } else if (group.group.name === 'Quốc gia') {
                            countries = group.list.map(item => item.name);
                        } else if (group.group.name === 'Năm') {
                            year = group.list[0]?.name || year;
                        }
                    });
                }
                servers = data.movie.episodes?.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: (server.items || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.m3u8 || '',
                        link_embed: ep.embed || '',
                        link_video: ep.link_video || ''
                    }))
                })) || [];
            }

            episodes = servers.flatMap(server => server.server_data);

            return {
                id: movie._id || movie.id,
                name: movie.name,
                slug: movie.slug,
                origin_name: movie.origin_name || movie.original_name,
                poster_url: movie.poster_url || movie.thumb_url || 'poster-not-found.jpg',
                content: movie.content || movie.description || 'Không có nội dung',
                type: movie.type || (movie.total_episodes > 1 ? 'series' : 'movie'),
                status: movie.status || movie.current_episode || 'unknown',
                episode_total: parseInt((movie.total_episodes || movie.episode_total || '1').toString().replace('Tập', '').trim()) || 1,
                time: movie.time || 'Không rõ',
                quality: movie.quality || 'HD',
                lang: movie.lang || movie.language || 'Vietsub',
                year: year || 'Không rõ',
                actors: Array.isArray(movie.actor) ? movie.actor.join(', ') : (movie.casts || 'Không có thông tin'),
                directors: Array.isArray(movie.director) ? movie.director.join(', ') : (movie.director || 'Không có thông tin'),
                categories: categories.join(', '),
                countries: countries.join(', '),
                created: movie.created?.time || movie.created || 'Không rõ',
                modified: movie.modified?.time || movie.modified || 'Không rõ',
                episodes,
                servers,
            };
        }

        async function fetchMovieData() {
            let movieData = {};
            let episodes = [];
            let customEpisodes = [];

            if (isCustom) {
                episodes = episodesParam ? JSON.parse(decodeURIComponent(episodesParam)) : [];
                customEpisodes = customEpisodesParam ? JSON.parse(decodeURIComponent(customEpisodesParam)) : episodes;
                movieData = {
                    name: movieName,
                    poster_url: poster || 'poster-not-found.jpg',
                    quality: quality || 'HD',
                    content: content || 'Không có nội dung',
                    actors: actors || 'Không có thông tin',
                    directors: directors || 'Không có thông tin',
                    countries: countries || 'Không rõ',
                    episodes,
                    episode_total: episodeTotal,
                    type: movieType || (episodes.length > 1 ? 'series' : 'movie'),
                    slug: slug,
                    servers: [{
                        server_name: 'Server Custom',
                        server_data: episodes
                    }],
                    categories: 'Không rõ',
                    year: 'Không rõ',
                    time: 'Không rõ',
                    lang: 'Vietsub'
                };
            } else {
                const apiUrl = apiSource === 'ophim1' ? `https://ophim1.com/phim/${slug}`
                    : apiSource === 'phimapi' ? `https://phimapi.com/phim/${slug}`
                    : `https://phim.nguonc.com/api/film/${slug}`;
                try {
                    const response = await fetch(apiUrl, { mode: 'cors' });
                    const data = await response.json();
                    if (data.status === true || data.status === 'success') {
                        movieData = normalizeMovieData(data, apiSource);
                        episodes = movieData.episodes;
                    }
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu phim:', error);
                }
            }

            // Cập nhật thông tin phim
            moviePoster.src = movieData.poster_url || 'poster-not-found.jpg';
            movieTitle.textContent = movieData.name || 'Không xác định';
            movieCategories.textContent = movieData.categories || 'Không rõ';
            movieCountries.textContent = movieData.countries || 'Không rõ';
            movieYear.textContent = movieData.year || 'Không rõ';
            movieTime.textContent = movieData.time || 'Không rõ';
            movieQuality.textContent = movieData.quality || 'HD';
            movieLang.textContent = movieData.lang || 'Vietsub';
            movieDirectors.textContent = movieData.directors || 'Không có thông tin';
            movieActors.textContent = movieData.actors || 'Không có thông tin';
            movieContent.textContent = movieData.content || 'Không có nội dung';

            // Cập nhật nút Xem phim
            const firstEpisode = episodes[0] || { name: 'Tập 1', link_m3u8: '', link_embed: '', link_video: '' };
            const linkType = firstEpisode.link_m3u8 ? 'm3u8' : firstEpisode.link_embed ? 'embed' : 'video';
            const linkUrl = firstEpisode.link_m3u8 || firstEpisode.link_embed || firstEpisode.link_video || '';
            watchBtn.href = `watch.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(firstEpisode.name)}&type=${linkType}&url=${encodeURIComponent(linkUrl)}&name=${encodeURIComponent(movieData.name)}${isCustom ? `&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}` : ''}`;

            // Hiển thị phim liên quan hoặc danh sách tập
            if (apiSource === 'phimnguonc') {
                relatedMoviesGrid.classList.remove('related-movies-grid');
                relatedMoviesGrid.innerHTML = `
                    <div class="episode-list">
                        <h3>Danh sách tập</h3>
                        <ul>
                            ${episodes.map(ep => `
                                <li>
                                    <a href="watch.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=${ep.link_m3u8 ? 'm3u8' : ep.link_embed ? 'embed' : 'video'}&url=${encodeURIComponent(ep.link_m3u8 || ep.link_embed || ep.link_video)}&name=${encodeURIComponent(movieData.name)}">
                                        ${ep.name}
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else if (isCustom) {
                relatedMoviesGrid.classList.remove('related-movies-grid');
                relatedMoviesGrid.innerHTML = `
                    <div class="episode-list">
                        <h3>Danh sách tập</h3>
                        <ul>
                            ${episodes.map(ep => `
                                <li>
                                    <a href="watch.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=${ep.link_m3u8 ? 'm3u8' : ep.link_embed ? 'embed' : 'video'}&url=${encodeURIComponent(ep.link_m3u8 || ep.link_embed || ep.link_video)}&name=${encodeURIComponent(movieData.name)}&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}">
                                        ${ep.name}
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else {
                const relatedApiUrl = apiSource === 'ophim1' ? `https://ophim1.com/danh-sach/phim-moi?page=1`
                    : apiSource === 'phimapi' ? `https://phimapi.com/danh-sach/phim-moi?page=1`
                    : `https://phim.nguonc.com/api/list/film?page=1`;
                try {
                    const response = await fetch(relatedApiUrl, { mode: 'cors' });
                    const data = await response.json();
                    const relatedMovies = (data.items || data.data || []).slice(0, 6).filter(m => m.slug !== slug);
                    relatedMoviesGrid.innerHTML = relatedMovies.map(movie => `
                        <div class="related-movie">
                            <a href="detail.html?slug=${encodeURIComponent(movie.slug)}&apiSource=${encodeURIComponent(apiSource)}">
                                <img src="${movie.poster_url || movie.thumb_url || 'poster-not-found.jpg'}" alt="${movie.name}">
                                <p>${movie.name}</p>
                            </a>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Lỗi khi tải phim liên quan:', error);
                    relatedMoviesGrid.innerHTML = '<p>Không có phim liên quan.</p>';
                }
            }
        }

        fetchMovieData();
    </script>
</body>
</html>