<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Xem phim</title>
  <link href="https://cdn.plyr.io/3.7.8/plyr.css" rel="stylesheet" />
  <style>
  body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #1a191f;
  color: #fff;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* HEADER */
header {
  background: #212026;
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

.Top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 1200px;
}

.Logo {
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  margin-bottom: 6px;
  transition: color 0.2s;
}

.Logo:hover { color: #de1212; }

.MenuBtn {
  font-size: 22px;
  cursor: pointer;
  padding: 8px;
  min-width: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  transition: background 0.2s;
}

.MenuBtn:hover { background: rgba(255, 255, 255, 0.2); }

.MenuDropdown {
  position: absolute;
  top: 100%;
  left: 0;
  width: 220px;
  background: #2b2b32;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
  opacity: 0;
  transition: opacity 0.2s;
  max-height: 300px;
  overflow-y: auto;
}

.MenuBtn.active .MenuDropdown { display: block; opacity: 1; }

.MenuDropdown h3 {
  margin: 10px 0 5px 10px;
  font-size: 14px;
  border-bottom: 1px solid #444;
  padding-bottom: 5px;
  color: #bdbdbd;
}

.MenuDropdown button {
  display: block;
  width: 100%;
  margin: 5px 0;
  padding: 8px;
  border: none;
  background: #444;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  text-align: left;
  transition: background 0.2s;
}

.MenuDropdown button:hover { background: #555; }

/* SEARCH */
.Search {
  display: flex;
  align-items: center;
  position: relative;
}

.Search input {
  width: 0;
  opacity: 0;
  transition: all 0.3s ease;
  padding: 8px;
  border: none;
  border-radius: 6px;
  outline: none;
  background: #2a292f;
  color: #fff;
  font-size: 14px;
}

.Search.active input {
  width: 180px;
  opacity: 1;
}

.Search button {
  margin-left: 8px;
  background: #de1212;
  border: none;
  padding: 8px 12px;
  color: #fff;
  cursor: pointer;
  border-radius: 6px;
  font-size: 14px;
  transition: background 0.2s;
}

.Search button:hover { background: #b00d0d; }

/* MAIN */
main {
  max-width: 1200px;
  margin: 20px auto;
  padding: 20px;
}

.breadcrumbs {
  font-size: 14px;
  margin-bottom: 20px;
  color: #bdbdbd;
}

.breadcrumbs a {
  color: #de1212;
  text-decoration: none;
  transition: color 0.2s;
}

.breadcrumbs a:hover { color: #b00d0d; text-decoration: underline; }

.movie-info { margin-bottom: 20px; }

.movie-info h1 { font-size: 24px; margin: 0 0 10px; }

.movie-info p { font-size: 16px; color: #bdbdbd; }

/* PLAYER */
.player-container {
  width: 900px;           /* c·ªë ƒë·ªãnh chi·ªÅu r·ªông */
  height: 500px;          /* c·ªë ƒë·ªãnh chi·ªÅu cao */
  margin: 0 auto 20px;    /* cƒÉn gi·ªØa ngang, margin d∆∞·ªõi 20px */
  background: #000;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.player-container video,
.player-container iframe {
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 10px;
}

/* SUBTITLE UPLOAD */
.subtitle-upload {
  margin: 10px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.subtitle-upload label { font-size: 14px; color: #bdbdbd; }

.subtitle-upload input[type="file"] {
  padding: 8px;
  background: #2a292f;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
}

/* EPISODES */
.episodes h3 { font-size: 18px; margin: 20px 0 10px; color: #fff; }

.episode-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
}

.episode-grid button {
  background: #444;
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s, transform 0.1s;
  text-align: center;
}

.episode-grid button {
  background: linear-gradient(145deg, #555, #333); /* gradient nh·∫π cho c·∫£m gi√°c n·ªïi */
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 10px; /* bo tr√≤n nhi·ªÅu h∆°n */
  cursor: pointer;
  font-size: 14px;
  text-align: center;
  transition: all 0.3s ease; /* smooth transition cho m·ªçi hi·ªáu ·ª©ng */
  box-shadow: 0 4px 6px rgba(0,0,0,0.3); /* ƒë·ªï b√≥ng nh·∫π */
}

.episode-grid button:hover {
  background: linear-gradient(145deg, #ff4d4d, #de1212); /* ƒë·ªïi m√†u khi hover */
  transform: scale(1.05); /* ph√≥ng to nh·∫π */
  box-shadow: 0 6px 10px rgba(0,0,0,0.4); /* ƒë·ªï b√≥ng r√µ h∆°n khi hover */
}

.episode-grid button.active {
  background: linear-gradient(145deg, #de1212, #ff4d4d);
  box-shadow: 0 6px 10px rgba(0,0,0,0.5);
}


/* RESPONSIVE */
@media (max-width: 1023px) {
  .Search.active input { width: 120px; }
  .player-container {
    width: 100%;
    height: calc(100vw * 500 / 900); /* gi·ªØ t·ªâ l·ªá 900x500 */
  }
}

@media (max-width: 480px) {
  .Search.active input { width: 100px; }
  .movie-info h1 { font-size: 20px; }
  .movie-info p { font-size: 14px; }
  .episode-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
}

@media (max-width: 360px) {
  .episode-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
}

  </style>
</head>
<body>
  <header>
    <div class="Logo" onclick="location.href='index.html'">üé¨ B√°nh M√¨ üé¨</div>
    <div class="Top">
      <div class="MenuBtn" id="menuBtn">‚ò∞
        <div class="MenuDropdown">
          <!-- Menu dropdown c√≥ th·ªÉ th√™m n·ªôi dung t·ª´ index.html n·∫øu c·∫ßn -->
        </div>
      </div>
      <div class="Search" id="searchBox">
        <input id="searchInput" placeholder="Nh·∫≠p t√™n phim..." />
        <button id="searchBtn">T√¨m</button>
      </div>
    </div>
  </header>
  <main>
    <div class="breadcrumbs" id="breadcrumbs"></div>
    <div class="movie-info" id="movieInfo"></div>
    <div class="player-container" id="playerContainer"></div>
    <div class="subtitle-upload" id="subtitleUpload">
      <label for="subtitleInput">T·∫£i l√™n ph·ª• ƒë·ªÅ (.srt, .vtt):</label>
      <input type="file" id="subtitleInput" accept=".srt,.vtt" />
    </div>
    <div class="episodes" id="episodes">
      <h3>Danh s√°ch t·∫≠p</h3>
      <div class="episode-grid" id="episodeList"></div>
    </div>
  </main>
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
<script>
  // Config sources v√† labels
  const sources = [
    { name: "üçû B√°nh M√¨ 01", base: "https://ophim1.com/v1/api", type: "ophim" },
    { name: "üçû B√°nh M√¨ 02", base: "https://phimapi.com/v1/api", type: "phimapi" },
    { name: "üçû B√°nh M√¨ 03", base: "https://phim.nguonc.com/api", type: "nguonc" }
  ];

  const labels = {
    "hanh-dong": "H√†nh ƒê·ªông", "phieu-luu": "Phi√™u L∆∞u", "hoat-hinh": "Ho·∫°t H√¨nh", "hai": "H√†i",
    "hinh-su": "H√¨nh S·ª±", "tai-lieu": "T√†i Li·ªáu", "chinh-kich": "Ch√≠nh K·ªãch", "gia-dinh": "Gia ƒê√¨nh",
    "gia-tuong": "Gi·∫£ T∆∞·ªüng", "lich-su": "L·ªãch S·ª≠", "kinh-di": "Kinh D·ªã", "nhac": "Nh·∫°c",
    "bi-an": "B√≠ ·∫®n", "lang-man": "L√£ng M·∫°n", "khoa-hoc-vien-tuong": "Khoa H·ªçc Vi·ªÖn T∆∞·ªüng",
    "gay-can": "G√¢y C·∫•n", "chien-tranh": "Chi·∫øn Tranh", "tam-ly": "T√¢m L√Ω", "tinh-cam": "T√¨nh C·∫£m",
    "co-trang": "C·ªï Trang", "mien-tay": "Mi·ªÅn T√¢y", "phim-18": "Phim 18+",
    "au-my": "√Çu M·ªπ", "anh": "Anh", "trung-quoc": "Trung Qu·ªëc", "indonesia": "Indonesia",
    "viet-nam": "Vi·ªát Nam", "phap": "Ph√°p", "hong-kong": "H·ªìng K√¥ng", "han-quoc": "H√†n Qu·ªëc",
    "nhat-ban": "Nh·∫≠t B·∫£n", "thai-lan": "Th√°i Lan", "dai-loan": "ƒê√†i Loan", "nga": "Nga",
    "ha-lan": "H√† Lan", "philippines": "Philippines", "an-do": "·∫§n ƒê·ªô", "quoc-gia-khac": "Qu·ªëc gia kh√°c",
    "duc": "ƒê·ª©c", "tay-ban-nha": "T√¢y Ban Nha", "tho-nhi-ky": "Th·ªï Nhƒ© K·ª≥", "mexico": "Mexico",
    "ba-lan": "Ba Lan", "uc": "√öc", "thu·ªµ-den": "Th·ª•y ƒêi·ªÉn", "malaysia": "Malaysia",
    "brazil": "Brazil", "bo-dao-nha": "B·ªì ƒê√†o Nha", "y": "√ù", "dan-mach": "ƒêan M·∫°ch",
    "uae": "UAE", "na-uy": "Na Uy", "thu·ªµ-si": "Th·ª•y Sƒ©", "chau-phi": "Ch√¢u Phi",
    "nam-phi": "Nam Phi", "ukraina": "Ukraina", "a-rap-xe-ut": "·∫¢ R·∫≠p X√™ √öt", "bi": "B·ªâ",
    "ireland": "Ireland", "colombia": "Colombia", "phan-lan": "Ph·∫ßn Lan", "chile": "Chile",
    "hy-lap": "Hy L·∫°p", "nigeria": "Nigeria", "argentina": "Argentina", "singapore": "Singapore",
    "phim-moi": "Phim m·ªõi", "phim-bo": "Phim b·ªô", "phim-le": "Phim l·∫ª", "shows": "TV Shows",
    "hoat-hinh": "Ho·∫°t h√¨nh", "phim-vietsub": "Phim vietsub", "phim-thuyet-minh": "Phim thuy·∫øt minh",
    "phim-long-tieng": "Phim l·ªìng ti·∫øng", "phim-bo-dang-chieu": "Phim b·ªô ƒëang chi·∫øu",
    "phim-bo-da-hoan-thanh": "Phim b·ªô ƒë√£ ho√†n th√†nh", "phim-sap-chieu": "Phim s·∫Øp chi·∫øu",
    "subteam": "Subteam", "phim-chieu-rap": "Phim chi·∫øu r·∫°p"
  };

  // Reverse labels
  const reverseLabels = {};
  for (const key in labels) {
    reverseLabels[labels[key]] = key;
  }

  // Query params
  const params = new URLSearchParams(location.search);
  const slug = params.get("slug");
  const source = params.get("src") ? decodeURIComponent(params.get("src")) : null;
  const srcConf = sources.find(s => s.name === source);
  const ep = params.get("ep") ? decodeURIComponent(params.get("ep")) : null;
  let isEmbed = params.get("isEmbed") === "true";
  const name = params.get("name") ? decodeURIComponent(params.get("name")) : "";
  const category = params.get("category") || "";
  const region = params.get("region") || "";
  const year = params.get("year") || "";
  const type = params.get("type") || "";
  const search = params.get("search") || "";
  const epName = params.get("epName") || "T·∫≠p ƒëang xem";

  // Force isEmbed based on ep link
  if (ep.toLowerCase().endsWith('.m3u8') || ep.includes('index.m3u8')) {
    isEmbed = false;
  } else if (ep.includes('embed') || ep.includes('share')) {
    isEmbed = true;
  }

  // DOM refs
  const playerContainer = document.getElementById("playerContainer");
  const movieInfo = document.getElementById("movieInfo");
  const breadcrumbs = document.getElementById("breadcrumbs");
  const episodeList = document.getElementById("episodeList");
  const subtitleUpload = document.getElementById("subtitleUpload");
  const subtitleInput = document.getElementById("subtitleInput");
  const searchBox = document.getElementById("searchBox");
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const menuBtn = document.getElementById("menuBtn");

  // Helpers
  function slugify(text) {
    if (!text) return "";
    return text.toString().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/ƒë/g, "d").replace(/ƒê/g, "D")
      .replace(/[^a-z0-9\s-]/g, "")
      .trim().replace(/\s+/g, "-");
  }

  function fixImagePath(img, src) {
    if (!img) return "";
    if (img.startsWith("http")) return img;
    if (src.type === "ophim") return `https://img.ophim.live/uploads/movies${img.startsWith("/") ? img : "/" + img}`;
    if (src.type === "phimapi") return `https://phimimg.com${img.startsWith("/") ? img : "/" + img}`;
    if (src.type === "nguonc") return img;
    return img.startsWith("/") ? img : "/" + img;
  }

  async function tryUrls(urls) {
    for (const u of urls) {
      try {
        const res = await fetch(u, { method: "GET" });
        if (!res.ok) {
          console.warn(`Request failed for ${u}: ${res.status}`);
          continue;
        }
        const json = await res.json();
        console.log(`API response from ${u}:`, json);
        if (json.data?.item || json.movie || json.data) {
          return { url: u, data: json };
        }
      } catch (e) {
        console.error(`Fetch error for ${u}:`, e);
      }
    }
    console.warn("No valid response from any URL");
    return null;
  }

  async function fetchEpisodes(slug, srcConf) {
    let epUrl;
    if (srcConf.type === "nguonc") epUrl = `${srcConf.base}/film/${slug}/episodes`;
    else epUrl = `${srcConf.base}/phim/${slug}/episodes`;
    try {
      const res = await fetch(epUrl);
      if (!res.ok) return [];
      const data = await res.json();
      return data.episodes || data.data?.episodes || [];
    } catch (e) {
      console.error("Episodes fetch error:", e);
      return [];
    }
  }

  // Load player
  function loadPlayer() {
    console.log("Loading player with:", { ep, isEmbed, epName }); // Debug
    if (!ep) {
      playerContainer.innerHTML = "<p class='small-note'>Kh√¥ng t√¨m th·∫•y link video.</p>";
      subtitleUpload.style.display = "none";
      return;
    }

    if (isEmbed) {
      // Embed mode (iframe)
      playerContainer.innerHTML = `<iframe src="${ep}" allowfullscreen allow="autoplay"></iframe>`;
      subtitleUpload.style.display = "none"; // ·∫®n upload ph·ª• ƒë·ªÅ cho embed
    } else {
      // M3U8 mode (Plyr + hls.js)
      playerContainer.innerHTML = `
        <video id="videoPlayer" playsinline controls>
          <source src="${ep}" type="application/x-mpegURL" />
        </video>
      `;
      subtitleUpload.style.display = "flex"; // Hi·ªán upload ph·ª• ƒë·ªÅ cho m3u8
      const player = new Plyr("#videoPlayer", {
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'fullscreen'],
        settings: ['captions', 'quality', 'speed'],
        captions: { active: true, update: true }
      });

      // Load hls.js for M3U8
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(ep);
        hls.attachMedia(document.getElementById("videoPlayer"));
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          console.log("HLS manifest parsed, playing video");
          player.play().catch(err => console.error("Play error:", err));
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.error("HLS error:", data);
          if (data.fatal) {
            playerContainer.innerHTML = "<p class='small-note'>L·ªói khi t·∫£i video M3U8. Vui l√≤ng th·ª≠ l·∫°i.</p>";
          }
        });
      } else if (document.getElementById("videoPlayer").canPlayType('application/vnd.apple.mpegurl')) {
        console.log("Using native HLS support");
        document.getElementById("videoPlayer").src = ep;
        document.getElementById("videoPlayer").play().catch(err => console.error("Native play error:", err));
      } else {
        playerContainer.innerHTML = "<p class='small-note'>Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t video M3U8.</p>";
      }
    }
  }

  // Handle subtitle upload
  subtitleInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file || !/\.(srt|vtt)$/i.test(file.name)) {
      alert("Vui l√≤ng ch·ªçn file ph·ª• ƒë·ªÅ ƒë·ªãnh d·∫°ng .srt ho·∫∑c .vtt");
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const subtitleUrl = URL.createObjectURL(file);
      const video = document.getElementById("videoPlayer");
      if (video && !isEmbed) {
        const existingTracks = video.getElementsByTagName("track");
        for (let track of existingTracks) {
          video.removeChild(track); // X√≥a ph·ª• ƒë·ªÅ c≈©
        }
        const track = document.createElement("track");
        track.kind = "captions";
        track.label = "Ph·ª• ƒë·ªÅ t·∫£i l√™n";
        track.srclang = "vi";
        track.src = subtitleUrl;
        track.default = true;
        video.appendChild(track);
        const player = Plyr.setup(video)[0];
        player.toggleCaptions(true);
        console.log("Subtitle loaded:", subtitleUrl);
      }
    };
    reader.readAsDataURL(file);
  });

  // Load movie info
  function loadMovieInfo() {
    movieInfo.innerHTML = `
      <h1>${name || "Phim"}</h1>
      <p>T·∫≠p ƒëang xem: ${epName}</p>
    `;
  }

  // Load breadcrumbs
  function loadBreadcrumbs() {
    const catSlug = category || "";
    const countrySlug = region || "";
    breadcrumbs.innerHTML = `
      <a href="index.html">Trang ch·ªß</a> > 
      ${catSlug ? `<a href="index.html?category=${catSlug}">${labels[catSlug] || catSlug}</a> > ` : ""}
      ${countrySlug ? `<a href="index.html?region=${countrySlug}">${labels[countrySlug] || countrySlug}</a> > ` : ""}
      ${year ? `<a href="index.html?year=${year}">${year}</a> > ` : ""}
      <a href="detail.html?slug=${encodeURIComponent(slug)}&src=${encodeURIComponent(source)}${category ? '&category=' + encodeURIComponent(category) : ''}${region ? '&region=' + encodeURIComponent(region) : ''}${year ? '&year=' + encodeURIComponent(year) : ''}${type ? '&type=' + encodeURIComponent(type) : ''}${search ? '&search=' + encodeURIComponent(search) : ''}">${name || "Phim"}</a> > Xem
    `;
  }

  // Load episodes
  async function loadEpisodes() {
    if (!slug || !source || !srcConf) {
      episodeList.innerHTML = "<p class='small-note'>Kh√¥ng t√¨m th·∫•y phim.</p>";
      return;
    }

    let url;
    if (srcConf.type === "nguonc") url = `${srcConf.base}/film/${slug}`;
    else url = `${srcConf.base}/phim/${slug}`;

    try {
      const res = await tryUrls([url]);
      if (!res) throw new Error("No valid response");
      const data = res.data;
      const item = data.data?.item || data.movie || data.data;

      if (!item) {
        episodeList.innerHTML = "<p class='small-note'>Kh√¥ng t√¨m th·∫•y phim.</p>";
        return;
      }

      let episodes = [];
      if (Array.isArray(item.episodes)) {
        episodes = item.episodes;
      } else if (Array.isArray(item.episode)) {
        episodes = item.episode;
      } else if (item.data && Array.isArray(item.data.episodes)) {
        episodes = item.data.episodes;
      } else if (item.server_data && Array.isArray(item.server_data)) {
        episodes = item.server_data;
      } else if (item.episodes && typeof item.episodes === 'object') {
        episodes = Object.values(item.episodes).filter(arr => Array.isArray(arr));
      }

      if (episodes.length === 0) {
        episodes = await fetchEpisodes(slug, srcConf);
      }

      episodeList.innerHTML = "";
      if (episodes.length === 0) {
        episodeList.innerHTML = "<p class='small-note'>Phim hi·ªán ch∆∞a c√≥ t·∫≠p n√†o. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
        return;
      }

    episodes.forEach((server, serverIdx) => {
  let serverName = server.server_name || server.name || `Server ${serverIdx + 1}`;

  // G·∫Øn nh√£n thuy·∫øt minh/l·ªìng ti·∫øng/vietsub
  if (serverName.toLowerCase().includes('thuy·∫øt minh') || serverName.toLowerCase().includes('tm') || item.language?.toLowerCase().includes('thuy·∫øt minh')) {
    serverName += ' (TM)';
  } else if (serverName.toLowerCase().includes('l·ªìng ti·∫øng') || serverName.toLowerCase().includes('lt') || item.language?.toLowerCase().includes('l·ªìng ti·∫øng')) {
    serverName += ' (LT)';
  } else if (serverName.toLowerCase().includes('vietsub') || item.language?.toLowerCase().includes('vietsub')) {
    serverName += ' (VS)';
  }

  const serverData = Array.isArray(server.items) ? server.items :
                     Array.isArray(server.server_data) ? server.server_data :
                     Array.isArray(server.episodes) ? server.episodes : [];

  serverData.forEach((epItem, idx) => {
    const m3u8 = epItem.link_m3u8 || epItem.link || epItem.m3u8 || "";
    const embed = epItem.embed || epItem.link_embed || "";
    const currentEpName = epItem.name || epItem.title || `T·∫≠p ${idx + 1}`;

    const queryParams = new URLSearchParams({
      slug: slug,
      src: source,
      name: item.name || item.title || '',
      epName: currentEpName, // t√™n hi·ªÉn th·ªã
      category: category,
      region: region,
      year: year,
      type: type,
      search: search
    });

    // Button cho "B√°nh m√¨" (thay M3U8)
    if (m3u8) {
      const paramsBanhMi = new URLSearchParams(queryParams.toString());
      paramsBanhMi.set('ep', m3u8);
      paramsBanhMi.set('isEmbed', false);
      const btn = document.createElement("button");
      btn.textContent = `${serverName}: ${currentEpName} (B√°nh m√¨)`; // ƒë·ªïi t√™n hi·ªÉn th·ªã
      btn.onclick = () => location.href = `watch.html?${paramsBanhMi.toString()}`;
      if (m3u8 === ep && !isEmbed) btn.classList.add("active");
      episodeList.appendChild(btn);
    }

    // Button cho "B√°nh m√¨ VIP" (thay Embed)
    if (embed) {
      const paramsBanhMiVIP = new URLSearchParams(queryParams.toString());
      paramsBanhMiVIP.set('ep', embed);
      paramsBanhMiVIP.set('isEmbed', true);
      const btn = document.createElement("button");
      btn.textContent = `${serverName}: ${currentEpName} (B√°nh m√¨ VIP)`;
      btn.onclick = () => location.href = `watch.html?${paramsBanhMiVIP.toString()}`;
      if (embed === ep && isEmbed) btn.classList.add("active");
      episodeList.appendChild(btn);
    }
  



if (embed) {
  const paramsEmbed = new URLSearchParams(queryParams.toString());
  paramsEmbed.set('ep', embed);
  paramsEmbed.set('isEmbed', true);
  const btn = document.createElement("button");
  btn.textContent = `${serverName}: ${currentEpName} (Vip)`;
  btn.onclick = () => location.href = `watch.html?${paramsEmbed.toString()}`;
  if (embed === ep && isEmbed) btn.classList.add("active");
  episodeList.appendChild(btn);
}

        });
      });
    } catch (err) {
      console.error("Episodes fetch error:", err);
      episodeList.innerHTML = "<p class='small-note'>Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·∫≠p.</p>";
    }
  }

  // Search handler
  searchBtn.addEventListener("click", () => {
    const q = searchInput.value.trim();
    if (!q) {
      searchBox.classList.toggle("active");
      searchInput.focus();
      return;
    }
    location.href = `index.html?search=${encodeURIComponent(q)}`;
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") searchBtn.click();
  });

  // Menu toggle
  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    menuBtn.classList.toggle("active");
  });

  document.addEventListener("click", () => {
    menuBtn.classList.remove("active");
  });

  // Quick filter handler
  function quickFilter(value, type = "category") {
    menuBtn.classList.remove("active");
    const query = new URLSearchParams({ [type]: value }).toString();
    location.href = `index.html?${query}`;
  }

  // Load on DOM content loaded
  window.addEventListener("DOMContentLoaded", () => {
    loadPlayer();
    loadMovieInfo();
    loadBreadcrumbs();
    loadEpisodes();
  });
</script>
</body>
</html>