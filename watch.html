<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem Phim</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Netflix Sans', Arial, sans-serif; }
        body { background: #141414; color: #fff; }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.95);
            padding: 15px 30px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
        }
        .logo { font-size: 28px; font-weight: bold; color: #e50914; cursor: pointer; }
        .back-btn {
            background: #e50914;
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        .back-btn:hover { background: #b20710; transform: scale(1.05); }

        /* Container */
        .container { max-width: 1200px; margin: 80px auto 50px; padding: 0 20px; }

        /* Player */
        #playerWrapper { max-width: 900px; margin: auto; border-radius: 10px; overflow: hidden; }
        video, iframe { width: 100%; height: 500px; border-radius: 8px; background: #000; border: 2px solid #e50914; }

        /* Tabs & controls */
        .tabs, .controls { text-align: center; margin: 15px auto; max-width: 900px; }
        .tabs button, .controls button {
            background: #2e2e3f;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 14px;
            margin: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .tabs button.active { background: #e50914; }
        .tabs button:hover, .controls button:hover { background: #b20710; }

        /* Servers */
        .server-block { max-width: 900px; margin: 20px auto; background: #222; border-radius: 6px; padding: 10px; }
        .server-block h3 { font-size: 16px; margin-bottom: 10px; color: #e50914; }
        .episode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .episode-card {
            background: #2e2e3f;
            padding: 6px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #fff;
            text-decoration: none;
            transition: 0.2s;
        }
        .episode-card:hover { background: #e50914; }
        .episode-card.active { background: #e50914; font-weight: bold; color: #fff; }

        /* Episode info */
        #episodeInfo { text-align: center; font-size: 16px; margin-bottom: 10px; color: #e50914; font-weight: bold; }

        /* Sub upload */
        #subUpload { display: block; margin: 10px auto; color: #fff; }

        @media (max-width: 720px) {
            video, iframe { height: 200px; }
            .episode-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo" onclick="window.location.href='index.html'">Bánh Mì 02</div>
        <button class="back-btn" onclick="window.location.href='detail.html?slug=' + encodeURIComponent(slug)">Chi tiết phim</button>
    </div>

    <div class="container">
        <h1 id="movieTitle">Đang tải phim...</h1>
        <p id="episodeInfo">Tập ? / ?</p>

        <div id="playerWrapper">
            <video id="player" playsinline controls></video>
        </div>

        <input type="file" id="subUpload" accept=".vtt" />

        <div class="tabs">
            <button id="mainTab" style="display: none;">Nguồn chính</button>
            <button id="embedTab" style="display: none;">Nguồn ngoài</button>
        </div>

        <div class="controls">
            <button id="prevEp">Tập trước</button>
            <button id="rewind">Lùi 10s</button>
            <button id="forward">Tiến 10s</button>
            <button id="nextEp">Tập sau</button>
        </div>

        <div id="servers"></div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get("slug");
        let currentEpSlug = decodeURIComponent(urlParams.get("episode") || "");
        let currentM3U8 = decodeURIComponent(urlParams.get("m3u8") || "");
        let currentEmbed = decodeURIComponent(urlParams.get("embed") || "");
        const API = "https://phimapi.com";
        let player;
        let allEpisodes = [];

        function initPlayer(src, sub1, sub2) {
            const wrapper = document.getElementById("playerWrapper");
            wrapper.innerHTML = `<video id="player" playsinline controls></video>`;
            const video = document.getElementById("player");

            if (!src) {
                wrapper.innerHTML = "<p style='color: #e50914; text-align: center;'>Nguồn video không hợp lệ.</p>";
                return;
            }

            let hls;
            if (Hls.isSupported() && src.includes(".m3u8")) {
                hls = new Hls({
                    maxBufferLength: 30, // Tăng buffer để giảm lỗi stalled
                    maxMaxBufferLength: 60,
                    backBufferLength: 10,
                    maxRetry: 5, // Thử lại 5 lần nếu lỗi
                    retryDelay: 1000 // Chờ 1 giây trước khi thử lại
                });
                hls.loadSource(src);
                hls.attachMedia(video);
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.details === 'bufferStalledError') {
                        console.log("Buffer stalled, retrying...");
                        hls.recoverMediaError(); // Thử khôi phục
                        if (hls.maxRetryAttempts > 0) {
                            hls.maxRetryAttempts--;
                        } else {
                            wrapper.innerHTML = "<p style='color: #e50914; text-align: center;'>Lỗi tải video m3u8: Buffer stalled, không thể khôi phục.</p>";
                        }
                    } else {
                        wrapper.innerHTML = "<p style='color: #e50914; text-align: center;'>Lỗi tải video m3u8: " + data.details + "</p>";
                    }
                });
            } else if (src) {
                video.src = src;
            } else {
                wrapper.innerHTML = "<p style='color: #e50914; text-align: center;'>Không hỗ trợ định dạng video.</p>";
                return;
            }

            if (sub1) {
                const t1 = document.createElement("track");
                t1.kind = "subtitles";
                t1.label = "Sub 1";
                t1.srclang = "vi";
                t1.src = sub1;
                t1.default = true;
                video.appendChild(t1);
            }
            if (sub2) {
                const t2 = document.createElement("track");
                t2.kind = "subtitles";
                t2.label = "Sub 2";
                t2.srclang = "en";
                t2.src = sub2;
                video.appendChild(t2);
            }

            player = new Plyr(video, { captions: { active: true, update: true } });

            const uploadInput = document.getElementById("subUpload");
            uploadInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file && file.name.endsWith(".vtt")) {
                    const url = URL.createObjectURL(file);
                    const track = document.createElement("track");
                    track.kind = "subtitles";
                    track.label = file.name;
                    track.srclang = "vi";
                    track.src = url;
                    video.appendChild(track);
                    player.captions.active = true;
                }
            };
        }

        function loadEmbed(link) {
            if (!link || !link.startsWith("http")) {
                document.getElementById("playerWrapper").innerHTML = "<p style='color: #e50914; text-align: center;'>Nguồn embed không hợp lệ.</p>";
                return;
            }
            document.getElementById("playerWrapper").innerHTML = `<iframe src="${link}" allowfullscreen></iframe>`;
            player = null;
        }

        function updateTabs(mode) {
            document.getElementById("mainTab").classList.toggle("active", mode === "m3u8");
            document.getElementById("embedTab").classList.toggle("active", mode === "embed");
            document.getElementById("mainTab").style.display = currentM3U8 ? "inline-block" : "none";
            document.getElementById("embedTab").style.display = currentEmbed ? "inline-block" : "none";
        }

        function highlightEpisode(epSlug) {
            document.querySelectorAll(".episode-card").forEach(c => c.classList.toggle("active", c.dataset.slug === epSlug));
        }

        async function fetchEpisodes() {
            try {
                const res = await fetch(`${API}/phim/${slug}`, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) {
                    document.getElementById("movieTitle").textContent = "Lỗi tải phim";
                    document.getElementById("servers").innerHTML = "<p style='color: #e50914; text-align: center;'>Không thể tải danh sách tập phim.</p>";
                    return;
                }
                const json = await res.json();
                const movie = json.movie || {};
                document.getElementById("movieTitle").textContent = movie.name || "Phim không xác định";

                const servers = json.episodes || [];
                const serversContainer = document.getElementById("servers");
                serversContainer.innerHTML = "";
                allEpisodes = [];

                if (!servers.length) {
                    serversContainer.innerHTML = "<p style='color: #e50914; text-align: center;'>Không có tập phim nào.</p>";
                    return;
                }

                servers.forEach(server => {
                    const block = document.createElement("div");
                    block.className = "server-block";
                    block.innerHTML = `<h3>${server.server_name || "Máy chủ không tên"}</h3>`;
                    const grid = document.createElement("div");
                    grid.className = "episode-grid";

                    server.server_data.forEach(ep => {
                        allEpisodes.push({
                            slug: ep.slug,
                            name: ep.name,
                            m3u8: ep.link_m3u8 || "",
                            embed: ep.link_embed || "",
                            sub1: null,
                            sub2: null
                        });
                        const card = document.createElement("a");
                        card.className = "episode-card";
                        card.dataset.slug = ep.slug;
                        card.textContent = ep.name;
                        card.href = `watch.html?slug=${encodeURIComponent(slug)}&episode=${encodeURIComponent(ep.slug)}&m3u8=${encodeURIComponent(ep.link_m3u8 || "")}&embed=${encodeURIComponent(ep.link_embed || "")}`;
                        grid.appendChild(card);
                    });

                    block.appendChild(grid);
                    serversContainer.appendChild(block);
                });

                if (!currentEpSlug && allEpisodes.length) currentEpSlug = allEpisodes[0].slug;
                const currentEp = allEpisodes.find(e => e.slug === currentEpSlug) || allEpisodes[0];

                highlightEpisode(currentEpSlug);
                document.getElementById("episodeInfo").textContent = `${currentEp.name} / ${allEpisodes.length}`;

                if (currentM3U8) {
                    initPlayer(currentM3U8, currentEp.sub1, currentEp.sub2);
                    updateTabs("m3u8");
                } else if (currentEmbed) {
                    loadEmbed(currentEmbed);
                    updateTabs("embed");
                } else {
                    document.getElementById("playerWrapper").innerHTML = "<p style='color: #e50914; text-align: center;'>Không có nguồn video nào khả dụng.</p>";
                }

                document.getElementById("mainTab").onclick = () => {
                    if (currentM3U8) {
                        initPlayer(currentM3U8, currentEp.sub1, currentEp.sub2);
                        updateTabs("m3u8");
                    }
                };
                document.getElementById("embedTab").onclick = () => {
                    if (currentEmbed) {
                        loadEmbed(currentEmbed);
                        updateTabs("embed");
                    }
                };

                const epNodes = [...document.querySelectorAll(".episode-card")];
                const currentIndex = epNodes.findIndex(c => c.dataset.slug === currentEpSlug);
                document.getElementById("prevEp").onclick = () => {
                    if (currentIndex > 0) epNodes[currentIndex - 1].click();
                };
                document.getElementById("nextEp").onclick = () => {
                    if (currentIndex < epNodes.length - 1) epNodes[currentIndex + 1].click();
                };
                document.getElementById("rewind").onclick = () => {
                    if (player) player.currentTime -= 10;
                };
                document.getElementById("forward").onclick = () => {
                    if (player) player.currentTime += 10;
                };
            } catch (e) {
                console.error("Lỗi:", e);
                document.getElementById("movieTitle").textContent = "Lỗi tải phim";
                document.getElementById("servers").innerHTML = "<p style='color: #e50914; text-align: center;'>Không thể tải danh sách tập phim.</p>";
            }
        }

        fetchEpisodes();
    </script>
</body>
</html>