<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xem Phim</title>

  <!-- Preload HLS.js -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/hls.js@1.6.13" as="script">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.13"></script>

  <style>
    :root{
      --main-color: #0a84ff;
      --main-color-hover: #0066cc;
      --bg-dark: #0a0a14;
      --card-bg: #1a1a2e;
      --card-border: #2a2a4a;
      --text-color: #ffffff;
      --text-secondary: #b0b0c0;
      --border-color: rgba(255,255,255,.1);
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --shadow-lg: 0 20px 50px rgba(0,0,0,.6);
      --success: #4ade80;
      --warning: #fbbf24;
      --error: #f87171;
      --gradient-primary: linear-gradient(135deg, #0a84ff, #0066cc);
      --gradient-dark: linear-gradient(135deg, #1a1a2e, #0a0a14);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-color);
      overflow-x: hidden;
      line-height: 1.6;
    }
    
    a {
      text-decoration: none;
      color: inherit;
    }
    
    img {
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
    }
    
    .bg-blur {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(20px) brightness(0.25);
      z-index: -2;
      opacity: 0;
      transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .bg-blur.loaded {
      opacity: 1;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, transparent 30%, rgba(10,10,20,0.9) 100%);
      z-index: -1;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      position: relative;
      z-index: 10;
    }
    
    #player-area {
      width: 100%;
      margin: 25px auto;
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      aspect-ratio: 16/9;
      position: relative;
      border: 2px solid var(--card-border);
      transition: all 0.3s ease;
    }
    
    #player-area:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), 0 0 30px rgba(10, 132, 255, 0.2);
    }
    
    #player-area video, #player-area iframe {
      width: 100%;
      height: 100%;
      border: none;
      object-fit: contain;
      background: #000;
    }
    
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.9);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255,255,255,0.1);
      border-top: 5px solid var(--main-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      position: relative;
    }
    
    .spinner::after {
      content: '';
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid transparent;
      border-top: 3px solid var(--main-color);
      animation: spinReverse 1.5s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes spinReverse {
      to { transform: rotate(-360deg); }
    }
    
    .title-bar {
      margin: 20px auto 25px;
      padding: 20px 25px;
      text-align: center;
      font-weight: 700;
      font-size: 1.4rem;
      color: var(--text-color);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    
    .title-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(10, 132, 255, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .title-bar:hover::before {
      left: 100%;
    }
    
    .bar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px auto;
      max-width: 100%;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--card-border);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover {
      background: rgba(10, 132, 255, 0.15);
      border-color: var(--main-color);
      color: var(--text-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(10, 132, 255, 0.2);
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn.active {
      background: var(--gradient-primary);
      color: #fff;
      border-color: var(--main-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(10, 132, 255, 0.3);
    }
    
    .source-btn {
      position: relative;
    }
    
    .source-btn .dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--main-color);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      overflow: hidden;
      display: none;
      z-index: 10;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .source-btn:hover .dropdown {
      display: block;
      animation: fadeIn 0.2s ease;
    }
    
    .dropdown button {
      width: 100%;
      padding: 12px 18px;
      background: transparent;
      color: var(--text-color);
      border: none;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .dropdown button:hover {
      background: rgba(10, 132, 255, 0.2);
    }
    
    .ep-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 14px;
      padding: 22px 15px;
      margin: 0 auto 30px;
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border: 1px solid var(--card-border);
    }
    
    .ep-btn {
      min-width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      color: var(--text-secondary);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 3px 10px rgba(0,0,0,.2);
    }
    
    .ep-btn:hover {
      background: var(--main-color);
      border-color: var(--main-color);
      color: #fff;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 5px 15px rgba(10, 132, 255, 0.3);
    }
    
    .ep-btn.active {
      background: var(--gradient-primary);
      border-color: var(--main-color);
      color: #fff;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
    }
    
    .plot-container {
      margin: 0 auto 35px;
      padding: 22px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      color: var(--text-secondary);
      line-height: 1.8;
      font-size: 16px;
      overflow-y: auto;
      max-height: 280px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    
    .plot-container h3 {
      color: var(--main-color);
      margin-bottom: 15px;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .back-btn {
      display: block;
      margin: 35px auto 50px;
      padding: 18px 30px;
      background: var(--gradient-primary);
      color: #fff;
      text-align: center;
      border-radius: var(--radius);
      font-weight: 700;
      font-size: 18px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 25px rgba(10, 132, 255, 0.4);
      max-width: 100%;
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .back-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 30px rgba(10, 132, 255, 0.6);
    }
    
    .back-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .back-btn:hover::before {
      left: 100%;
    }
    
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card-bg);
      color: var(--text-color);
      padding: 16px 30px;
      border: 1px solid var(--main-color);
      border-radius: var(--radius-sm);
      font-size: 16px;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9999;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #toast.show {
      visibility: visible;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    #popup-confirm {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    #popup-confirm.show {
      visibility: visible;
      opacity: 1;
    }
    
    #popup-box {
      background: var(--card-bg);
      padding: 30px;
      border: 1px solid var(--main-color);
      border-radius: var(--radius);
      color: var(--text-color);
      width: 90%;
      max-width: 450px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(15px);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    
    #popup-confirm.show #popup-box {
      transform: scale(1);
    }
    
    .popup-btn {
      padding: 14px 28px;
      margin: 12px 10px;
      min-width: 110px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 16px;
    }
    
    .popup-yes {
      background: var(--gradient-primary);
      color: #fff;
    }
    
    .popup-yes:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
    }
    
    .popup-no {
      background: #333;
      color: #fff;
      border: 1px solid var(--card-border);
    }
    
    .popup-no:hover {
      background: #444;
      transform: scale(1.05);
    }
    
    .sub {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      font-size: 18px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      font-weight: 600;
      line-height: 1.5;
      pointer-events: none;
      background: rgba(0,0,0,.7);
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      display: inline-block;
      max-width: 80%;
      backdrop-filter: blur(5px);
    }
    
    .upload input[type="file"] {
      display: none;
    }
    
    .upload {
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .upload::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
      background-size: 200% 100%;
      animation: shine 3s infinite;
    }
    
    @keyframes shine {
      0% { background-position: -100% 0; }
      100% { background-position: 100% 0; }
    }
    
    .error-msg {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.9);
      color: var(--error);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      border-radius: var(--radius);
      backdrop-filter: blur(5px);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media(max-width: 768px) {
      .main-container {
        padding: 0 1rem;
      }
      
      #player-area {
        margin: 18px 0;
      }
      
      .title-bar {
        margin: 16px 0;
        font-size: 1.2rem;
        padding: 16px 20px;
      }
      
      .bar {
        gap: 12px;
      }
      
      .btn {
        padding: 10px 20px;
        font-size: 14px;
        min-width: 80px;
      }
      
      .ep-grid {
        gap: 12px;
        padding: 18px 12px;
        grid-template-columns: repeat(auto-fill, minmax(52px, 1fr));
      }
      
      .ep-btn {
        height: 50px;
        font-size: 14px;
      }
      
      .back-btn {
        margin: 28px 0 40px;
        font-size: 16px;
        padding: 16px 25px;
      }
      
      .plot-container {
        padding: 18px;
        font-size: 15px;
        max-height: 240px;
      }
      
      #popup-box {
        padding: 25px;
        max-width: 90%;
      }
    }
    
    @media(max-width: 480px) {
      .ep-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
      }
      
      .ep-btn {
        height: 46px;
        font-size: 13px;
        min-width: 46px;
      }
      
      .btn {
        font-size: 13px;
        padding: 9px 16px;
        min-width: 70px;
      }
      
      .back-btn {
        font-size: 15px;
        padding: 14px 20px;
      }
      
      .title-bar {
        font-size: 1.1rem;
        padding: 14px 18px;
      }
      
      #toast {
        font-size: 14px;
        padding: 14px 25px;
        max-width: 90%;
      }
    }
  </style>
</head>
<body>

  <div class="bg-blur" id="bg"></div>
  <div class="overlay"></div>

  <div class="main-container">
    <div class="title-bar" id="title-bar">Tên Phim: Đang tải... | Tập: 1</div>
    <div id="player-area">
      <div class="loading-overlay"><div class="spinner"></div></div>
      <video id="hls-video" playsinline controls preload="none" style="display:none"></video>
      <iframe id="embed-frame" style="display:none" allowfullscreen allow="autoplay" loading="lazy"></iframe>
      <div class="error-msg" id="error-msg" style="display:none">Lỗi phát nguồn này</div>
    </div>

    <div class="bar" id="source-mode-bar"></div>
    <div class="bar" id="server-select"></div>

    <div class="bar" id="ctl-bar">
      <button class="btn" onclick="prevEp()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 19 2 12 11 5 11 19"></polygon>
          <polygon points="22 19 13 12 22 5 22 19"></polygon>
        </svg>
        Trước
      </button>
      <button class="btn" onclick="seek(-40)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 20V4M6 16L2 12L6 8M18 16L22 12L18 8"></path>
        </svg>
        -40s
      </button>
      <button class="btn" onclick="seek(40)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 4V20M6 8L2 12L6 16M18 8L22 12L18 16"></path>
        </svg>
        +40s
      </button>
      <button class="btn" onclick="nextEp()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="5 4 15 12 5 20 5 4"></polygon>
          <polygon points="19 5 19 19 12 12 19 5"></polygon>
        </svg>
        Sau
      </button>
      <label class="btn upload">
        <input type="file" id="vi-sub" accept=".vtt,.srt" hidden>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        Vi Sub
      </label>
      <label class="btn upload">
        <input type="file" id="en-sub" accept=".vtt,.srt" hidden>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        En Sub
      </label>
    </div>

    <div class="ep-grid" id="ep-grid"></div>

    <div class="plot-container" id="plot-container">
      <h3>Cốt truyện</h3>
      <p id="plot-text">Đang tải nội dung phim...</p>
    </div>

    <button class='back-btn' onclick="window.location.href='/'">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 10px;">
        <path d="M19 12H5M12 19l-7-7 7-7"></path>
      </svg>
      Quay lại Trang Chủ
    </button>
  </div>

  <div id="toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
    </svg>
    Thông báo
  </div>

  <div id="popup-confirm">
    <div id="popup-box">
      <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--main-color)" stroke-width="1.5" style="margin: 0 auto 20px;">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v-4"></path>
        <path d="M12 8h.01"></path>
      </svg>
      <h3 style="margin-bottom: 15px; color: var(--main-color);">Tập tiếp theo</h3>
      <p style="margin-bottom: 25px; color: var(--text-secondary);">Bạn có muốn chuyển sang tập kế tiếp không?</p>
      <button class="popup-btn popup-yes">Có</button>
      <button class="popup-btn popup-no">Không</button>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const slug = params.get('slug');
  let srcCode = params.get('source') || 'bx';
  const srcMap = { ax: 'Ophim', bx: 'Phimapi', cx: 'Nguonc' };
  let srcName = srcMap[srcCode] || 'Phimapi';

  const API = {
    Ophim: `https://ophim1.com/v1/api/phim/${slug}`,
    Phimapi: `https://phimapi.com/phim/${slug}`,
    Nguonc: `https://phim.nguonc.com/api/film/${slug}`
  };

  const playerArea = document.getElementById('player-area');
  const videoEl = document.getElementById('hls-video');
  const embedFrame = document.getElementById('embed-frame');
  const loading = playerArea.querySelector('.loading-overlay');
  const errorMsg = document.getElementById('error-msg');
  const titleBar = document.getElementById('title-bar');
  const popup = document.getElementById('popup-confirm');
  const popupYes = popup.querySelector('.popup-yes');
  const popupNo = popup.querySelector('.popup-no');
  const toastEl = document.getElementById('toast');
  const bgBlur = document.getElementById('bg');
  const plotText = document.getElementById('plot-text');
  const sourceModeBar = document.getElementById('source-mode-bar');

  let hls = null;
  let servers = [], episodes = [], curSrv = 0, curEp = 0;
  let movie = '', poster = '', cdn = '', plot = '';
  let mode = 'm3u8';
  let viSub = '', enSub = '';
  let warned = false;
  let timeUpdateHandler = null;
  let popupTimeout = null;

  function showToast(m) {
    toastEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
      </svg>
      ${m}
    `;
    toastEl.classList.add('show');
    clearTimeout(toastEl.timeout);
    toastEl.timeout = setTimeout(() => toastEl.classList.remove('show'), 3000);
  }

  function showEndPopup() {
    if (warned || curEp >= episodes.length - 1) return;
    warned = true;
    popup.classList.add('show');
    clearTimeout(popupTimeout);
    popupTimeout = setTimeout(() => {
      if (warned) { popup.classList.remove('show'); warned = false; }
    }, 10000);
  }

  popupYes.onclick = () => { 
    clearTimeout(popupTimeout); 
    popup.classList.remove('show'); 
    warned = false; 
    nextEp(); 
  };
  
  popupNo.onclick = () => { 
    clearTimeout(popupTimeout); 
    popup.classList.remove('show'); 
    warned = true; 
  };

  function epFromUrl() { 
    const e = params.get('e'); 
    return e ? Math.max(0, parseInt(e) - 1) : 0; 
  }

  function updateUrl(ep, src = srcName) {
    curEp = ep;
    srcCode = Object.entries(srcMap).find(([k, v]) => v === src)?.[0] || 'bx';
    history.replaceState(null, '', `?slug=${slug}&source=${srcCode}&e=${ep + 1}`);
  }

  function getPoster(m) {
    let u = m.poster_url || m.thumb_url || m.poster || '';
    if (srcName === 'Ophim' && u && !u.includes('/uploads/movies/')) {
      const n = u.split('/').pop().replace(/-poster\.jpg|-thumb\.jpg/g, '');
      u = `${cdn || 'https://img.ophim.live'}/uploads/movies/${n}-thumb.jpg`;
    }
    return u.includes('http') ? u : null;
  }

  const movieCache = new Map();
  async function loadMovie() {
    if (movieCache.has(srcName)) {
      const cached = movieCache.get(srcName);
      movie = cached.movie; poster = cached.poster; plot = cached.plot; servers = cached.servers;
      plotText.innerHTML = plot.replace(/\n/g, '<br>');
      if (poster) loadPoster(poster);
      renderServerBar();
      renderSourceModeBar();
      return true;
    }

    try {
      const r = await fetch(API[srcName], { cache: 'force-cache' });
      if (!r.ok) throw new Error('API lỗi');
      const d = await r.json();

      let m = {}, epsList = [];
      if (srcName === 'Nguonc') { m = d.movie; epsList = m.episodes || []; }
      else if (srcName === 'Phimapi') { m = d.movie; epsList = d.episodes || []; }
      else { m = d.data.item; epsList = m.episodes || []; cdn = d.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live'; }

      movie = m.name || m.title || 'Không rõ';
      poster = getPoster(m);
      plot = m.content || m.description || m.plot || 'Chưa có cốt truyện.';

      plotText.innerHTML = plot.replace(/\n/g, '<br>');
      if (poster) loadPoster(poster);

      servers = epsList.map(g => ({
        name: g.server_name || `Server ${servers.length + 1}`,
        data: (g.server_data || g.items || []).map(ep => ({
          name: ep.name || `Tập ${ep.slug?.split('-').pop() || ''}`,
          link_m3u8: srcName === 'Nguonc' ? '' : (ep.link_m3u8 || ep.m3u8 || ''),
          link_embed: ep.link_embed || ep.embed || ''
        })).filter(ep => ep.link_embed || (srcName !== 'Nguonc' && ep.link_m3u8))
      })).filter(s => s.data.length > 0);

      if (servers.length === 0) {
        errorMsg.textContent = 'Không có tập nào';
        errorMsg.style.display = 'flex';
        loading.style.display = 'none';
        return false;
      }

      movieCache.set(srcName, { movie, poster, plot, servers });
      renderServerBar();
      renderSourceModeBar();
      return true;
    } catch (e) {
      console.error(e);
      errorMsg.textContent = 'Lỗi tải phim';
      errorMsg.style.display = 'flex';
      loading.style.display = 'none';
      return false;
    }
  }

  function loadPoster(url) {
    const img = new Image();
    img.onload = () => {
      bgBlur.style.backgroundImage = `url(${url})`;
      bgBlur.classList.add('loaded');
      document.querySelector('.overlay').style.display = 'block';
    };
    img.onerror = () => { bgBlur.style.display = 'none'; };
    img.src = url;
  }

  function renderSourceModeBar() {
    sourceModeBar.innerHTML = '';
    const sourceDiv = document.createElement('div');
    sourceDiv.className = 'source-btn';
    sourceDiv.innerHTML = `
      <button class="btn active" id="current-source">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
        ${srcCode.toUpperCase()}
      </button>
      <div class="dropdown">
        <button onclick="changeSource('ax')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          AX (Ophim)
        </button>
        <button onclick="changeSource('bx')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          BX (Phimapi)
        </button>
        <button onclick="changeSource('cx')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          CX (Nguonc)
        </button>
      </div>
    `;
    sourceModeBar.appendChild(sourceDiv);

    const hasM3u8 = episodes.some(e => e.link_m3u8);
    const hasEmbed = episodes.some(e => e.link_embed);

    if (srcName === 'Nguonc') {
      mode = 'embed';
      if (hasEmbed) {
        const b = document.createElement('button');
        b.className = 'btn active';
        b.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
          Embed
        `;
        b.onclick = () => showToast('Nguồn C chỉ hỗ trợ Embed');
        sourceModeBar.appendChild(b);
      }
    } else {
      if (hasM3u8) {
        const b = document.createElement('button');
        b.className = 'btn';
        b.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
          </svg>
          M3U8
        `;
        if (mode === 'm3u8') b.classList.add('active');
        b.onclick = () => { mode = 'm3u8'; play(curEp); };
        sourceModeBar.appendChild(b);
      }
      if (hasEmbed) {
        const b = document.createElement('button');
        b.className = 'btn';
        b.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
          Embed
        `;
        if (mode === 'embed') b.classList.add('active');
        b.onclick = () => { mode = 'embed'; play(curEp); };
        sourceModeBar.appendChild(b);
      }
    }
  }

  function renderServerBar() {
    const bar = document.getElementById('server-select');
    bar.innerHTML = '';
    servers.forEach((s, i) => {
      const b = document.createElement('button');
      b.className = 'btn';
      b.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
          <line x1="8" y1="21" x2="16" y2="21"></line>
          <line x1="12" y1="17" x2="12" y2="21"></line>
        </svg>
        ${s.name} (${s.data.length})
      `;
      if (i === curSrv) b.classList.add('active');
      b.onclick = () => switchServer(i);
      bar.appendChild(b);
    });
  }

  function renderGrid() {
    const g = document.getElementById('ep-grid');
    g.innerHTML = '';
    episodes.forEach((_, i) => {
      const b = document.createElement('div');
      b.className = 'ep-btn';
      b.textContent = i + 1;
      if (i === curEp) b.classList.add('active');
      b.onclick = () => play(i);
      g.appendChild(b);
    });
  }

  function markEp(i) {
    document.querySelectorAll('.ep-btn').forEach((b, k) => b.classList.toggle('active', k === i));
  }

  function resetPlayer() {
    if (hls) { hls.destroy(); hls = null; }
    if (timeUpdateHandler) { videoEl.removeEventListener('timeupdate', timeUpdateHandler); timeUpdateHandler = null; }
    videoEl.pause(); videoEl.src = ''; videoEl.style.display = 'none';
    embedFrame.src = ''; embedFrame.style.display = 'none';
    playerArea.querySelectorAll('.sub').forEach(el => el.remove());
    playerArea.querySelectorAll('track').forEach(t => t.remove());
    loading.style.display = 'flex';
    errorMsg.style.display = 'none';
    warned = false;
    clearTimeout(popupTimeout);
    delete videoEl._skipTimes;
  }

  function playEmbed(url) {
    resetPlayer();
    embedFrame.src = url;
    embedFrame.style.display = 'block';
    embedFrame.onload = () => loading.style.display = 'none';
  }

  function playHLS(m3u8) {
    resetPlayer();
    videoEl.style.display = 'block';

    if (Hls.isSupported()) {
      hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 15,
        maxBufferLength: 10,
        maxMaxBufferLength: 15,
        liveSyncDurationCount: 1,
        startLevel: 0,
        capLevelToPlayerSize: true,
        xhrSetup: (xhr) => { xhr.withCredentials = false; }
      });
      hls.loadSource(m3u8);
      hls.attachMedia(videoEl);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        loading.style.display = 'none';
        videoEl.play().catch(() => {});
      });
      hls.on(Hls.Events.ERROR, (e, d) => {
        if (d.fatal) showToast('Lỗi HLS - Đổi server');
      });
    } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
      videoEl.src = m3u8;
      videoEl.addEventListener('loadedmetadata', () => {
        loading.style.display = 'none';
        videoEl.play().catch(() => {});
      });
    } else {
      showToast('Không hỗ trợ HLS');
      return;
    }

    if (viSub) {
      const t = document.createElement('track');
      t.kind = 'captions'; t.label = 'Tiếng Việt'; t.srclang = 'vi'; t.src = viSub; t.default = true;
      videoEl.appendChild(t);
    }
    if (enSub) {
      const t = document.createElement('track');
      t.kind = 'captions'; t.label = 'English'; t.srclang = 'en'; t.src = enSub;
      videoEl.appendChild(t);
    }

    // TỰ ĐỘNG TUA MỞ ĐẦU - LUÔN LUÔN, MỌI TẬP
    videoEl._skipTimes = [
      { start: 30, end: 70, skip: 40 },
      { start: 900, end: 940, skip: 40 }
    ];

    timeUpdateHandler = () => {
      const t = videoEl.currentTime;
      const d = videoEl.duration;
      if (d && !videoEl.seeking) {
        const wasPlaying = !videoEl.paused;

        for (const rule of videoEl._skipTimes) {
          if (t >= rule.start && t < rule.end) {
            videoEl.currentTime = t + rule.skip;
            showToast('Tự động tua mở đầu');
            if (wasPlaying) videoEl.play().catch(() => {});
            break;
          }
        }
      }

      if (!warned && d && t >= d - 120 && curEp < episodes.length - 1) showEndPopup();

      let vi = '', en = '';
      Array.from(videoEl.textTracks).forEach(tr => {
        if (tr.activeCues?.[0]) {
          if (tr.label === 'Tiếng Việt') vi = tr.activeCues[0].text;
          if (tr.label === 'English') en = tr.activeCues[0].text;
        }
      });
      playerArea.querySelectorAll('.sub').forEach(el => el.remove());
      if (vi) playerArea.insertAdjacentHTML('beforeend', `<div class="sub vi">${vi}</div>`);
      if (en) playerArea.insertAdjacentHTML('beforeend', `<div class="sub en">${en}</div>`);
    };
    videoEl.addEventListener('timeupdate', timeUpdateHandler);

    videoEl.addEventListener('ended', () => {
      if (curEp < episodes.length - 1 && !warned) nextEp();
    });
  }

  function play(i) {
    if (i < 0 || i >= episodes.length) return;
    curEp = i;
    markEp(i);
    updateUrl(i);
    titleBar.textContent = `${movie} | Tập ${i + 1}`;

    const ep = episodes[i];
    const m3u8 = ep.link_m3u8?.trim();
    const embed = ep.link_embed?.trim();

    if (!m3u8 && !embed) {
      errorMsg.textContent = 'Không có link';
      errorMsg.style.display = 'flex';
      loading.style.display = 'none';
      return;
    }

    if (srcName === 'Nguonc') {
      if (embed) playEmbed(embed);
      else { errorMsg.textContent = 'Nguồn C chỉ hỗ trợ Embed'; errorMsg.style.display = 'flex'; loading.style.display = 'none'; }
    } else {
      if (mode === 'embed' && embed) playEmbed(embed);
      else if (mode === 'm3u8' && m3u8) playHLS(m3u8);
      else if (embed) playEmbed(embed);
      else if (m3u8) playHLS(m3u8);
      else { errorMsg.textContent = 'Lỗi nguồn'; errorMsg.style.display = 'flex'; loading.style.display = 'none'; }
    }
  }

  function switchServer(i) {
    if (i < 0 || i >= servers.length) return;
    curSrv = i;
    episodes = servers[i].data;
    renderGrid();
    renderSourceModeBar();
    document.querySelectorAll('#server-select .btn').forEach((b, k) => b.classList.toggle('active', k === i));
    curEp = Math.min(curEp, episodes.length - 1);
    play(curEp);
  }

  function seek(s) {
    if (videoEl.style.display !== 'none' && !isNaN(videoEl.duration)) {
      videoEl.currentTime = Math.max(0, Math.min(videoEl.currentTime + s, videoEl.duration));
    }
  }

  function prevEp() { if (curEp > 0) play(curEp - 1); else showToast('Tập đầu'); }
  function nextEp() { if (curEp < episodes.length - 1) play(curEp + 1); else showToast('Hết tập'); }

  document.getElementById('vi-sub').onchange = e => {
    const f = e.target.files[0];
    if (f) { viSub = URL.createObjectURL(f); showToast('Vi Sub đã được tải lên'); if (mode === 'm3u8' && srcName !== 'Nguonc') play(curEp); }
  };
  document.getElementById('en-sub').onchange = e => {
    const f = e.target.files[0];
    if (f) { enSub = URL.createObjectURL(f); showToast('En Sub đã được tải lên'); if (mode === 'm3u8' && srcName !== 'Nguonc') play(curEp); }
  };

  window.changeSource = async function(code) {
    if (code === srcCode) return;
    srcCode = code;
    srcName = srcMap[code];
    resetPlayer();
    loading.style.display = 'flex';
    if (await loadMovie()) {
      curSrv = 0;
      switchServer(0);
      updateUrl(curEp);
    }
  };

  async function init() {
    if (!slug) {
      errorMsg.textContent = 'Thiếu slug';
      errorMsg.style.display = 'flex';
      return;
    }
    curEp = epFromUrl();
    loading.style.display = 'flex';
    if (await loadMovie() && servers.length > 0) {
      switchServer(0);
    }
  }
  init();
</script>
</body>
</html>