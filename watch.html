<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Phim Hay - Xem phim online miễn phí">
    <meta name="keywords" content="phim Hàn, phim bộ, phim lẻ, xem phim online, phim chất lượng cao">
    <meta name="author" content="Phim Hay">
    <title>Phim Hay - Xem phim</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" media="print" onload="this.media='all'">
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --primary-color: #e50914;
            --primary-hover: #b20710;
            --bg-dark: #181818;
            --bg-section: #222;
            --text-white: #fff;
            --text-gray: #b3b3b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --active-bg: #000;
            --active-text: #fff;
            --sub1-color: #ffffff;
            --sub2-color: #ffd700;
        }

        [data-theme="light"] {
            --bg-dark: #f4f4f4;
            --bg-section: #e0e0e0;
            --text-white: #333;
            --text-gray: #666;
            --active-bg: #ddd;
            --active-text: #333;
            --sub1-color: #000000;
            --sub2-color: #d4a017;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
            overflow-x: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-dark);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            flex-wrap: wrap;
        }

        .logo {
            max-height: 50px;
            transition: var(--transition);
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 500px;
            min-width: 200px;
            position: relative;
        }

        .search-bar input {
            padding: 12px 40px 12px 15px;
            border: none;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            font-size: 1em;
            width: 100%;
            transition: var(--transition);
        }

        .search-bar input:focus {
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            box-shadow: 0 0 5px var(--primary-color);
        }

        .search-bar i {
            position: absolute;
            right: 15px;
            color: var(--text-gray);
            font-size: 1.2em;
            cursor: pointer;
        }

        .search-bar .clear-search {
            right: 35px;
            display: none;
        }

        .search-bar .clear-search.visible {
            display: block;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-section);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestions.visible {
            display: block;
        }

        .search-suggestions div {
            padding: 10px 15px;
            color: var(--text-white);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-suggestions div:hover {
            background: var(--primary-color);
        }

        .nav-menu {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .nav-menu a {
            color: var(--text-white);
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .nav-menu a:hover {
            background-color: var(--primary-hover);
            color: var(--text-white);
        }

        .nav-menu a.active {
            background-color: var(--primary-color);
            color: var(--text-white);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-white);
            font-size: 1.5em;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--primary-color);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            flex: 1;
        }

        .video-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .video-info h2 {
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .video-info p {
            font-size: 1.2em;
            color: var(--text-gray);
        }

        .video-container {
            width: 100%;
            margin: 0 auto 25px;
            background: #000;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .video-player {
            width: 100%;
            aspect-ratio: 16/9;
            display: block;
        }

        .video-player.plyr--video {
            background: #000;
        }

        .video-player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-section);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .control-btn, .nav-btn {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn:hover, .nav-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .subtitle-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 25px 0;
            flex-wrap: wrap;
            position: relative;
        }

        .subtitle-section input[type="file"] {
            display: none;
        }

        .subtitle-section label {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: var(--text-white);
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .subtitle-section label:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
            transform: translateY(-2px);
        }

        .subtitle-section label[for="sub1"] {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .subtitle-section label[for="sub1"]:hover {
            background: linear-gradient(135deg, #0056b3, #007bff);
        }

        .subtitle-section label[for="sub2"] {
            background: linear-gradient(135deg, #ffca28, #d4a017);
        }

        .subtitle-section label[for="sub2"]:hover {
            background: linear-gradient(135deg, #d4a017, #ffca28);
        }

        .subtitle-section button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: var(--text-white);
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtitle-section button:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
            transform: translateY(-2px);
        }

        .subtitle-section button#toggle-sub-btn {
            background: linear-gradient(135deg, #17a2b8, #117a8b);
        }

        .subtitle-section button#toggle-sub-btn:hover {
            background: linear-gradient(135deg, #117a8b, #17a2b8);
        }

        #subtitle-message {
            position: absolute;
            top: -35px;
            background: var(--success-color);
            color: var(--text-white);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            width: max-content;
            max-width: 280px;
        }

        .subtitle-section.error #subtitle-message {
            background: var(--error-color);
        }

        #subtitle-message.show {
            opacity: 1;
        }

        .episode-list {
            margin: 30px 0;
        }

        .episode-list h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
        }

        .episode-list h3 {
            font-size: 1.3em;
            margin: 12px 0 8px;
            color: var(--text-white);
        }

        .episode-list ul {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
        }

        .episode-list li {
            list-style: none;
        }

        .episode-list a {
            display: inline-block;
            padding: 8px 14px;
            background: var(--primary-color);
            color: var(--text-white);
            text-decoration: none;
            border-radius: 4px;
            transition: var(--transition);
            font-size: 0.95em;
            min-width: 50px;
            text-align: center;
        }

        .episode-list a:hover {
            background: var(--primary-hover);
        }

        .episode-list a.active {
            background: var(--active-bg);
            color: var(--active-text);
            font-weight: 500;
        }

        video::-webkit-media-text-track-display {
            font-size: 1em;
        }

        video::cue(.sub1) {
            color: var(--sub1-color);
            background: rgba(0, 0, 0, 0.7);
            font-size: 1em;
            font-weight: normal;
            line-height: 1.4;
            text-align: center;
        }

        video::cue(.sub2) {
            color: var(--sub2-color);
            background: rgba(224, 255, 85, 0.966);
            font-size: 0.9em;
            font-weight: normal;
            line-height: 1.4;
            text-align: center;
        }

        footer {
            background: var(--bg-section);
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .footer-btn {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .footer-text {
            font-size: 0.9em;
            color: var(--text-gray);
        }

        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .scroll-top:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .scroll-top.visible {
            display: flex;
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            padding: 10px;
            font-size: 1em;
        }

        /* Desktop */
        @media (min-width: 1025px) {
            .header-content { gap: 20px; }
            .search-bar { max-width: 500px; }
            .nav-menu a { font-size: 1em; padding: 10px 15px; }
            .main-content { padding: 110px 20px 50px; }
            .video-info h2 { font-size: 2.2em; }
            .video-info p { font-size: 1.3em; }
            .video-controls { gap: 15px; padding: 15px; }
            .control-btn, .nav-btn { padding: 12px 20px; font-size: 1em; }
            .subtitle-section label, .subtitle-section button { padding: 12px 24px; font-size: 1em; }
            .episode-list h2 { font-size: 2em; }
            .episode-list a { padding: 10px 16px; font-size: 1em; min-width: 60px; }
            .video-container { width: 820px; max-width: 820px; height: calc(820px * 9 / 16); }
            .video-player { width: 820px; height: calc(820px * 9 / 16); }
            .video-player iframe { width: 820px; height: calc(820px * 9 / 16); }
        }

        /* Tablet */
        @media (max-width: 1024px) {
            .header-content { gap: 15px; }
            .search-bar { max-width: 400px; }
            .video-info h2 { font-size: 1.8em; }
            .video-info p { font-size: 1.1em; }
            .control-btn, .nav-btn { padding: 10px 14px; font-size: 0.9em; }
            .subtitle-section label, .subtitle-section button { padding: 10px 20px; font-size: 0.9em; }
            .episode-list a { padding: 8px 12px; font-size: 0.9em; min-width: 50px; }
            #subtitle-message { top: -40px; font-size: 0.85em; max-width: 250px; }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header { padding: 10px 15px; }
            .header-content { flex-direction: column; align-items: stretch; gap: 10px; }
            .logo { max-height: 40px; align-self: center; }
            .search-bar { max-width: 100%; min-width: unset; }
            .search-bar input { font-size: 0.9em; padding: 8px 35px 8px 12px; }
            .nav-menu { justify-content: center; gap: 8px; }
            .nav-menu a { font-size: 0.85em; padding: 6px 10px; }
            .theme-toggle { font-size: 1.2em; padding: 6px; }
            .main-content { padding: 100px 10px 30px; }
            .video-container { margin-bottom: 20px; }
            .video-info h2 { font-size: 1.6em; }
            .video-info p { font-size: 1em; }
            .video-controls { gap: 10px; padding: 10px; }
            .control-btn, .nav-btn { padding: 8px 12px; font-size: 0.85em; }
            .subtitle-section { flex-direction: column; gap: 10px; }
            .subtitle-section label, .subtitle-section button { padding: 10px 20px; font-size: 0.9em; width: 100%; text-align: center; border-radius: 25px; }
            .episode-list { margin: 20px 0; }
            .episode-list h2 { font-size: 1.6em; }
            .episode-list h3 { font-size: 1.2em; }
            .episode-list a { padding: 6px 10px; font-size: 0.85em; min-width: 45px; }
            #subtitle-message { top: auto; bottom: -45px; font-size: 0.8em; max-width: 200px; }
            .footer-buttons { flex-direction: column; gap: 10px; }
            .footer-btn { padding: 8px 12px; font-size: 0.85em; width: 100%; justify-content: center; }
            .scroll-top { width: 40px; height: 40px; bottom: 10px; right: 10px; }
        }

        /* Small mobile */
        @media (max-width: 480px) {
            .header { padding: 8px 10px; }
            .logo { max-height: 35px; }
            .search-bar input { font-size: 0.85em; padding: 7px 30px 7px 10px; }
            .search-bar i { font-size: 1em; }
            .nav-menu a { font-size: 0.8em; padding: 5px 8px; }
            .main-content { padding: 90px 8px 20px; }
            .video-info h2 { font-size: 1.4em; }
            .video-info p { font-size: 0.9em; }
            .control-btn, .nav-btn { padding: 7px 10px; font-size: 0.8em; }
            .subtitle-section label, .subtitle-section button { padding: 10px 20px; font-size: 0.85em; border-radius: 20px; }
            .episode-list a { padding: 5px 8px; font-size: 0.8em; min-width: 40px; }
            #subtitle-message { font-size: 0.75em; max-width: 180px; }
        }
    </style>
</head>
<body>
    <header class="header" role="banner">
        <div class="header-content">
            <img src="https://www.freeiconspng.com/uploads/star-icon-11.png" alt="Phim Hay" class="logo" loading="lazy">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Tìm kiếm phim..." aria-label="Tìm kiếm phim">
                <i class="fas fa-times clear-search" id="clear-search" aria-label="Xóa tìm kiếm"></i>
                <i class="fas fa-search" aria-label="Tìm kiếm"></i>
                <div class="search-suggestions" id="search-suggestions"></div>
            </div>
            <nav class="nav-menu" aria-label="Điều hướng chính">
                <a href="index.html" class="active">Trang chủ</a>
                <a href="phim-han.html">Phim Hàn</a>
                <a href="phim-trung.html">Phim Trung</a>
                <a href="phim-viet.html">Phim Việt</a>
                <a href="phim-my.html">Phim Mỹ</a>
                <a href="truyen-hinh.html">Truyền hình</a>
                <a href="hoat-hinh.html">Hoạt hình</a>
                <a href="netflix.html">Netflix</a>
                <a href="ykhoa.html">Y Khoa</a>
                <button class="theme-toggle" id="theme-toggle" aria-label="Chuyển đổi giao diện">
                    <i class="fas fa-moon"></i>
                </button>
            </nav>
        </div>
    </header>
    <main class="main-content" role="main">
        <section class="video-info" aria-labelledby="movie-title">
            <h2 id="movie-title">Đang tải...</h2>
            <p id="episode-title">Đang tải...</p>
        </section>
        <div class="video-container">
            <div id="player-container" class="video-player"></div>
        </div>
        <div class="video-controls">
            <button class="control-btn" id="prev-episode-btn" aria-label="Tập trước"><i class="fas fa-step-backward"></i> Tập trước</button>
            <button class="control-btn" id="rewind-btn" aria-label="Tua lùi 10 giây"><i class="fas fa-backward"></i> -10s</button>
            <button class="control-btn" id="forward-btn" aria-label="Tua tới 10 giây"><i class="fas fa-forward"></i> +10s</button>
            <button class="control-btn" id="next-episode-btn" aria-label="Tập sau"><i class="fas fa-step-forward"></i> Tập sau</button>
        </div>
        <div class="video-controls">
            <button class="nav-btn" id="back-to-detail-btn" aria-label="Quay lại chi tiết"><i class="fas fa-arrow-left"></i> Chi tiết</button>
            <button class="nav-btn" id="back-to-home-btn" aria-label="Quay lại trang chủ"><i class="fas fa-home"></i> Trang chủ</button>
        </div>
        <div class="subtitle-section" aria-label="Quản lý phụ đề">
            <label for="sub1"><i class="fas fa-closed-captioning"></i> Phụ đề 1 (Trắng)</label>
            <input type="file" id="sub1" accept=".vtt,.srt">
            <label for="sub2"><i class="fas fa-closed-captioning"></i> Phụ đề 2 (Vàng)</label>
            <input type="file" id="sub2" accept=".vtt,.srt">
            <button id="load-sub-btn"><i class="fas fa-upload"></i> Tải phụ đề</button>
            <button id="toggle-sub-btn"><i class="fas fa-eye"></i> Tắt phụ đề</button>
            <div id="subtitle-message" role="alert"></div>
        </div>
        <section class="episode-list" id="server1-list" aria-label="Danh sách tập Server 1">
            <h2>Server 1</h2>
            <div>
                <h3>Bánh mì sơ cấp</h3>
                <ul id="server1-m3u8"></ul>
                <h3>Bánh mì trung cấp</h3>
                <ul id="server1-embed"></ul>
                <h3>Bánh mì happy</h3>
                <ul id="server1-video"></ul>
            </div>
        </section>
        <section class="episode-list" id="server2-list" aria-label="Danh sách tập Server 2">
            <h2>Server 2</h2>
            <div>
                <h3>Bánh mì sơ cấp</h3>
                <ul id="server2-m3u8"></ul>
                <h3>Bánh mì trung cấp</h3>
                <ul id="server2-embed"></ul>
                <h3>Bánh mì happy</h3>
                <ul id="server2-video"></ul>
            </div>
        </section>
        <section class="episode-list" id="custom-list" aria-label="Danh sách tập tùy chỉnh">
            <h2>Tùy chỉnh</h2>
            <div>
                <h3>Website</h3>
                <ul id="custom-m3u8"></ul>
                <h3>Bên ngoài Website</h3>
                <ul id="custom-embed"></ul>
                <h3>Random bánh mì</h3>
                <ul id="custom-video"></ul>
            </div>
        </section>
    </main>
    <footer role="contentinfo">
        <div class="footer-buttons">
            <button class="footer-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" aria-label="Lên đầu trang">
                <i class="fas fa-arrow-up"></i> Lên đầu
            </button>
            <button class="footer-btn" aria-label="Liên hệ">
                <i class="fas fa-info-circle"></i> Liên hệ
            </button>
        </div>
        <p class="footer-text">© 2025 Phim Nhà Bánh Mì.</p>
    </footer>
    <button class="scroll-top" id="scroll-top" aria-label="Lên đầu trang">
        <i class="fas fa-arrow-up"></i>
    </button>
    <script>
        // Hàm sanitization tham số URL
        const sanitizeParam = (param) => {
            if (!param) return '';
            return param.replace(/[<>"]/g, '');
        };

        class MoviePlayer {
            constructor() {
                this.elements = {
                    playerContainer: document.getElementById('player-container'),
                    movieTitle: document.getElementById('movie-title'),
                    episodeTitle: document.getElementById('episode-title'),
                    prevEpisodeBtn: document.getElementById('prev-episode-btn'),
                    nextEpisodeBtn: document.getElementById('next-episode-btn'),
                    rewindBtn: document.getElementById('rewind-btn'),
                    forwardBtn: document.getElementById('forward-btn'),
                    backToDetailBtn: document.getElementById('back-to-detail-btn'),
                    backToHomeBtn: document.getElementById('back-to-home-btn'),
                    sub1Input: document.getElementById('sub1'),
                    sub2Input: document.getElementById('sub2'),
                    loadSubBtn: document.getElementById('load-sub-btn'),
                    toggleSubBtn: document.getElementById('toggle-sub-btn'),
                    subtitleMessage: document.getElementById('subtitle-message'),
                    server1List: document.getElementById('server1-list'),
                    server1M3u8: document.getElementById('server1-m3u8'),
                    server1Embed: document.getElementById('server1-embed'),
                    server1Video: document.getElementById('server1-video'),
                    server2List: document.getElementById('server2-list'),
                    server2M3u8: document.getElementById('server2-m3u8'),
                    server2Embed: document.getElementById('server2-embed'),
                    server2Video: document.getElementById('server2-video'),
                    customList: document.getElementById('custom-list'),
                    customM3u8: document.getElementById('custom-m3u8'),
                    customEmbed: document.getElementById('custom-embed'),
                    customVideo: document.getElementById('custom-video'),
                    searchInput: document.getElementById('search-input'),
                    clearSearch: document.getElementById('clear-search'),
                    searchSuggestions: document.getElementById('search-suggestions'),
                    scrollTop: document.getElementById('scroll-top'),
                    themeToggle: document.getElementById('theme-toggle')
                };

                this.urlParams = new URLSearchParams(window.location.search);
                this.state = {
                    slug: sanitizeParam(decodeURIComponent(this.urlParams.get('slug') || '')),
                    apiSource: sanitizeParam(decodeURIComponent(this.urlParams.get('apiSource') || '')),
                    episodeName: sanitizeParam(decodeURIComponent(this.urlParams.get('episode') || '')),
                    linkType: sanitizeParam(this.urlParams.get('type') || ''),
                    linkUrl: sanitizeParam(decodeURIComponent(this.urlParams.get('url') || '')),
                    movieName: sanitizeParam(decodeURIComponent(this.urlParams.get('name') || '')),
                    isCustom: this.urlParams.get('apiSource') === 'custom',
                    customEpisodes: this.parseCustomEpisodes(this.urlParams.get('customEpisodes')),
                    player: null,
                    videoElement: null,
                    allEpisodes: [],
                    blobUrls: [],
                    movieData: null,
                    subtitlesEnabled: true
                };

                this.CACHE_KEY = 'movie_player_cache';
                this.CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 1 ngày
                this.MAX_CACHE_SIZE = 50; // Giới hạn số lượng phim trong cache
            }

            async init() {
                this.setupEventListeners();
                this.loadTheme();
                this.adjustMainContentPadding();
                await this.loadMovieData();
            }

            setupEventListeners() {
                this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
                window.addEventListener('scroll', () => {
                    this.elements.scrollTop.classList.toggle('visible', window.scrollY > 300);
                });
                this.elements.scrollTop.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                window.addEventListener('resize', () => this.adjustMainContentPadding());
                this.elements.searchInput.addEventListener('input', () => this.handleSearchInput());
                this.elements.searchInput.addEventListener('keypress', (e) => this.handleSearchKeypress(e));
                this.elements.clearSearch.addEventListener('click', () => this.clearSearch());
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.dataset.theme = savedTheme;
                this.elements.themeToggle.innerHTML = `<i class="fas fa-${savedTheme === 'light' ? 'moon' : 'sun'}"></i>`;
            }

            toggleTheme() {
                const currentTheme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
                document.body.dataset.theme = currentTheme;
                this.elements.themeToggle.innerHTML = `<i class="fas fa-${currentTheme === 'light' ? 'moon' : 'sun'}"></i>`;
                localStorage.setItem('theme', currentTheme);
            }

            adjustMainContentPadding() {
                const headerHeight = document.querySelector('.header')?.offsetHeight || 0;
                document.querySelector('.main-content').style.paddingTop = `${headerHeight + 20}px`;
            }

            handleSearchInput() {
                const searchTerm = this.elements.searchInput.value.trim();
                this.elements.clearSearch.classList.toggle('visible', searchTerm.length > 0);
                if (!searchTerm) {
                    this.elements.searchSuggestions.classList.remove('visible');
                }
            }

            handleSearchKeypress(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.elements.searchInput.value.trim();
                    if (searchTerm) {
                        window.location.href = `index.html?search=${encodeURIComponent(searchTerm)}`;
                    }
                }
            }

            clearSearch() {
                this.elements.searchInput.value = '';
                this.elements.clearSearch.classList.remove('visible');
                this.elements.searchSuggestions.classList.remove('visible');
            }

            parseCustomEpisodes(param) {
                if (!param) return [];
                try {
                    const episodes = JSON.parse(decodeURIComponent(param));
                    return episodes.map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    }));
                } catch (error) {
                    console.error('Lỗi khi parse customEpisodes:', error);
                    return [];
                }
            }

            showSubtitleMessage(message, isError = false) {
                this.elements.subtitleMessage.textContent = message;
                this.elements.subtitleMessage.classList.toggle('error', isError);
                this.elements.subtitleMessage.classList.add('show');
                setTimeout(() => this.elements.subtitleMessage.classList.remove('show'), 3000);
            }

            validateSubtitleFile(file) {
                if (!file) return false;
                return ['.vtt', '.srt'].some(ext => file.name.toLowerCase().endsWith(ext));
            }

            convertSrtToVtt(srtContent) {
                let vttContent = 'WEBVTT\n\n';
                const lines = srtContent.trim().split(/\r?\n/);
                let i = 0;

                while (i < lines.length) {
                    if (lines[i].trim() === '') { i++; continue; }
                    if (/^\d+$/.test(lines[i].trim())) {
                        i++;
                        if (i < lines.length && lines[i].includes('-->')) {
                            vttContent += `${lines[i].replace(/,/g, '.')} align:middle\n`;
                            i++;
                            let subtitleText = '';
                            while (i < lines.length && lines[i].trim() !== '' && !/^\d+$/.test(lines[i].trim())) {
                                subtitleText += lines[i] + '\n';
                                i++;
                            }
                            if (subtitleText.trim()) {
                                vttContent += subtitleText.trim().replace(/\n/g, ' ') + '\n\n';
                            }
                        } else {
                            i++;
                        }
                    } else {
                        i++;
                    }
                }
                return vttContent;
            }

            processVttFile(vttContent) {
                let newVttContent = 'WEBVTT\n\n';
                const lines = vttContent.trim().split(/\r?\n/);
                let i = 1;

                while (i < lines.length) {
                    if (lines[i].includes('-->')) {
                        newVttContent += `${lines[i]} align:middle\n`;
                        i++;
                        let subtitleText = '';
                        while (i < lines.length && lines[i].trim() !== '') {
                            subtitleText += lines[i] + '\n';
                            i++;
                        }
                        if (subtitleText.trim()) {
                            newVttContent += subtitleText.trim().replace(/\n/g, ' ') + '\n\n';
                        }
                    } else {
                        i++;
                    }
                }
                return newVttContent;
            }

            mergeSubtitles(sub1Content, sub2Content) {
                let vttContent = 'WEBVTT\n\n';
                const parseTimestamps = (block) => {
                    const match = block.match(/(\d{2}:\d{2}:\d{2}\.\d{3}) --> (\d{2}:\d{2}:\d{2}\.\d{3})/);
                    if (!match) return null;
                    return {
                        start: match[1],
                        end: match[2],
                        text: block.split('\n').slice(1).join(' ').trim() || ' '
                    };
                };

                const sub1Lines = sub1Content.trim().split('\n\n').filter(block => block.includes('-->')).map(parseTimestamps).filter(Boolean);
                const sub2Lines = sub2Content.trim().split('\n\n').filter(block => block.includes('-->')).map(parseTimestamps).filter(Boolean);

                const merged = [];
                sub1Lines.forEach((sub1, i) => {
                    const sub2 = sub2Lines[i] || { start: sub1.start, end: sub1.end, text: ' ' };
                    merged.push({ time: `${sub1.start} --> ${sub1.end}`, sub1: sub1.text, sub2: sub2.text });
                });
                sub2Lines.slice(sub1Lines.length).forEach((sub2, i) => {
                    merged.push({ time: `${sub2.start} --> ${sub2.end}`, sub1: ' ', sub2: sub2.text });
                });

                merged.forEach(({ time, sub1, sub2 }) => {
                    vttContent += `${time} line:10% align:middle\n<c.sub1>${sub1}</c>\n`;
                    vttContent += `${time} line:20% align:middle\n<c.sub2>${sub2}</c>\n\n`;
                });

                return vttContent;
            }

            clearSubtitleTracks() {
                if (this.state.videoElement) {
                    this.state.videoElement.querySelectorAll('track').forEach(track => track.remove());
                    this.state.blobUrls.forEach(url => URL.revokeObjectURL(url));
                    this.state.blobUrls = [];
                }
            }

            async processSubtitleFiles(sub1File, sub2File) {
                if (!this.state.videoElement) {
                    this.showSubtitleMessage('Không có video để tải phụ đề.', true);
                    return false;
                }

                const files = [sub1File, sub2File].filter(file => file);
                if (!files.length) {
                    this.showSubtitleMessage('Vui lòng chọn ít nhất một file phụ đề.', true);
                    return false;
                }

                for (const file of files) {
                    if (!this.validateSubtitleFile(file)) {
                        this.showSubtitleMessage(`File ${file.name} không hợp lệ. Chỉ hỗ trợ .vtt hoặc .srt!`, true);
                        return false;
                    }
                }

                const track = document.createElement('track');
                track.kind = 'subtitles';
                track.label = 'Phụ đề song ngữ';
                track.srclang = 'vi';

                try {
                    const readFile = file => new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(file.name.toLowerCase().endsWith('.vtt')
                            ? this.processVttFile(reader.result)
                            : this.convertSrtToVtt(reader.result));
                        reader.onerror = () => reject(new Error(`Lỗi khi đọc file ${file.name}`));
                        reader.readAsText(file);
                    });

                    const sub1Content = sub1File ? await readFile(sub1File) : 'WEBVTT\n\n';
                    const sub2Content = sub2File ? await readFile(sub2File) : 'WEBVTT\n\n';
                    const mergedContent = this.mergeSubtitles(sub1Content, sub2Content);

                    if (!mergedContent.includes('WEBVTT')) {
                        throw new Error('Nội dung phụ đề không hợp lệ');
                    }

                    const vttBlob = new Blob([mergedContent], { type: 'text/vtt' });
                    const blobUrl = URL.createObjectURL(vttBlob);
                    this.state.blobUrls.push(blobUrl);
                    track.src = blobUrl;
                    this.state.videoElement.appendChild(track);

                    await new Promise((resolve, reject) => {
                        track.addEventListener('load', resolve, { once: true });
                        track.addEventListener('error', () => reject(new Error('Không thể tải track')), { once: true });
                    });

                    const textTrack = this.state.videoElement.textTracks[this.state.videoElement.textTracks.length - 1];
                    textTrack.mode = this.state.subtitlesEnabled ? 'showing' : 'disabled';
                    this.showSubtitleMessage('Phụ đề song ngữ đã được tải.');
                    return true;
                } catch (error) {
                    this.showSubtitleMessage(`Lỗi khi tải phụ đề: ${error.message}`, true);
                    return false;
                }
            }

            normalizeMovieData(data, apiSource) {
                const movie = data.movie || data;
                let categories = [], countries = [], year = movie.year || 'Không rõ', episodes = [], servers = [];

                if (apiSource === 'ophim1' || apiSource === 'phimapi') {
                    categories = movie.category?.map(c => c.name) || [];
                    countries = movie.country?.map(c => c.name) || [];
                    servers = data.episodes?.map((server, index) => ({
                        server_name: server.server_name || `Server ${index + 1}`,
                        server_data: (server.server_data || []).map(ep => ({
                            name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                            link_m3u8: ep.link_m3u8 || '',
                            link_embed: ep.link_embed || '',
                            link_video: ep.link_video || ''
                        }))
                    })) || [];
                } else if (apiSource === 'phimnguonc') {
                    if (movie.category && typeof movie.category === 'object') {
                        Object.values(movie.category).forEach(group => {
                            if (group.group?.name === 'Thể loại') categories = group.list?.map(item => item.name) || [];
                            else if (group.group?.name === 'Quốc gia') countries = group.list?.map(item => item.name) || [];
                            else if (group.group?.name === 'Năm') year = group.list?.[0]?.name || year;
                        });
                    }
                    servers = movie.episodes?.map((server, index) => ({
                        server_name: server.server_name || `Server ${index + 1}`,
                        server_data: (server.items || []).map(ep => ({
                            name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                            link_m3u8: '',
                            link_embed: ep.embed || '',
                            link_video: ep.link_video || ep.m3u8 || ''
                        }))
                    })) || [];
                } else if (apiSource === 'custom') {
                    servers = [{
                        server_name: 'Server Custom',
                        server_data: (data.episodes || []).map(ep => ({
                            name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                            link_m3u8: ep.link_m3u8 || '',
                            link_embed: ep.link_embed || '',
                            link_video: ep.link_video || ''
                        }))
                    }];
                }

                episodes = servers.flatMap(server => server.server_data);
                const uniqueEpisodes = [...new Map(episodes.map(ep => [
                    `${ep.name}|${ep.link_m3u8 || ''}|${ep.link_embed || ''}|${ep.link_video || ''}`,
                    ep
                ])).values()];

                return {
                    name: movie.name || 'Không xác định',
                    slug: movie.slug || '',
                    poster_url: movie.poster_url || movie.thumb_url || '',
                    content: movie.content || movie.description || 'Không có nội dung',
                    actors: Array.isArray(movie.actor) ? movie.actor.join(', ') : (typeof movie.actor === 'string' ? movie.actor : (movie.casts || 'Không có thông tin')),
                    directors: Array.isArray(movie.director) ? movie.director.join(', ') : (typeof movie.director === 'string' ? movie.director : (movie.director || 'Không có thông tin')),
                    countries: countries.join(', ') || 'Không rõ',
                    categories: categories.join(', ') || 'Không rõ',
                    year,
                    time: movie.time || 'Không rõ',
                    quality: movie.quality || 'HD',
                    lang: movie.lang || movie.language || 'Vietsub',
                    status: movie.status || movie.current_episode || 'unknown',
                    episodes: uniqueEpisodes,
                    episode_total: parseInt((movie.episode_total || uniqueEpisodes.length || '1').toString().replace('Tập', '').trim()) || 1,
                    type: movie.type || (uniqueEpisodes.length > 1 ? 'series' : 'movie'),
                    servers
                };
            }

            async fetchMovieData(slug, apiSource, retries = 2) {
                const apiUrls = {
                    ophim1: `https://ophim1.com/phim/${slug}`,
                    phimapi: `https://phimapi.com/phim/${slug}`,
                    phimnguonc: `https://phim.nguonc.com/api/film/${slug}`
                };
                const url = apiUrls[apiSource];
                if (!url) return null;

                const cached = JSON.parse(localStorage.getItem(this.CACHE_KEY) || '{}');
                const now = Date.now();
                if (cached[slug] && (now - cached[slug].timestamp) < this.CACHE_EXPIRY) {
                    return cached[slug].data;
                }

                try {
                    const response = await fetch(url, { mode: 'cors', cache: 'no-cache' });
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    const data = await response.json();
                    if ((data.status === true || data.status === 'success') && data.movie) {
                        const normalizedData = this.normalizeMovieData(data, apiSource);
                        cached[slug] = { data: normalizedData, timestamp: now };

                        const keys = Object.keys(cached);
                        if (keys.length > this.MAX_CACHE_SIZE) {
                            const oldestKey = keys.sort((a, b) => cached[a].timestamp - cached[b].timestamp)[0];
                            delete cached[oldestKey];
                        }

                        localStorage.setItem(this.CACHE_KEY, JSON.stringify(cached));
                        return normalizedData;
                    }
                    return null;
                } catch (error) {
                    if (retries > 0) return this.fetchMovieData(slug, apiSource, retries - 1);
                    console.error(`Lỗi khi tải dữ liệu từ ${url}:`, error);
                    return null;
                }
            }

            async loadMovieData() {
                let movieData = {};

                if (this.state.isCustom && this.state.customEpisodes.length > 0) {
                    movieData = {
                        name: this.state.movieName || 'Không xác định',
                        poster_url: 'https://via.placeholder.com/200x300',
                        quality: 'HD',
                        content: 'Không có nội dung',
                        actors: 'Không có thông tin',
                        directors: 'Không có thông tin',
                        countries: 'Không rõ',
                        categories: 'Không rõ',
                        year: 'Không rõ',
                        time: 'Không rõ',
                        lang: 'Vietsub',
                        status: 'unknown',
                        episodes: this.state.customEpisodes,
                        episode_total: this.state.customEpisodes.length,
                        type: this.state.customEpisodes.length > 1 ? 'series' : 'movie',
                        slug: this.state.slug,
                        servers: [{ server_name: 'Server Custom', server_data: this.state.customEpisodes }]
                    };
                } else {
                    movieData = await this.fetchMovieData(this.state.slug, this.state.apiSource);
                    if (!movieData) {
                        this.elements.playerContainer.innerHTML = '<p class="error-message">Lỗi khi tải dữ liệu phim.</p>';
                        this.elements.movieTitle.textContent = 'Lỗi tải phim';
                        this.elements.episodeTitle.textContent = 'Không xác định';
                        return;
                    }
                    if (this.state.customEpisodes.length > 0) {
                        movieData.servers.push({
                            server_name: 'Server Custom',
                            server_data: this.state.customEpisodes
                        });
                        movieData.episodes = movieData.episodes.concat(this.state.customEpisodes);
                    }
                }

                this.state.movieData = movieData;
                this.setupPlayer();
                this.renderEpisodeLists();
                this.setupEpisodeNavigation();
                this.setupSubtitleHandling();
            }

            setupPlayer() {
                let { episodeName, linkType, linkUrl } = this.state;
                const { movieData, movieName } = this.state;

                if (!episodeName || !linkUrl) {
                    const firstEpisode = movieData.servers[0]?.server_data.find(ep => ep.link_m3u8 || ep.link_video || ep.link_embed) || this.state.customEpisodes[0];
                    if (firstEpisode) {
                        episodeName = firstEpisode.name;
                        if (firstEpisode.link_m3u8 && this.state.apiSource !== 'phimnguonc') {
                            linkType = 'm3u8';
                            linkUrl = firstEpisode.link_m3u8;
                        } else if (firstEpisode.link_video && this.state.isCustom) {
                            linkType = 'video';
                            linkUrl = firstEpisode.link_video;
                        } else {
                            linkType = 'embed';
                            linkUrl = firstEpisode.link_embed;
                        }
                    }
                }

                if (!linkUrl) {
                    this.elements.playerContainer.innerHTML = '<p class="error-message">Không có link video khả dụng.</p>';
                    this.elements.movieTitle.textContent = movieName || movieData.name || 'Không xác định';
                    this.elements.episodeTitle.textContent = `Tập: ${episodeName || 'Tập 1'}`;
                    this.elements.rewindBtn.disabled = true;
                    this.elements.forwardBtn.disabled = true;
                    return;
                }

                this.state.episodeName = episodeName;
                this.state.linkType = linkType;
                this.state.linkUrl = linkUrl;

                this.elements.movieTitle.textContent = movieName || movieData.name || 'Không xác định';
                this.elements.episodeTitle.textContent = `Tập: ${episodeName || 'Tập 1'}`;

                if (linkType === 'm3u8' && this.state.apiSource !== 'phimnguonc') {
                    this.elements.playerContainer.innerHTML = '<video id="video-player" class="video-player" controls crossorigin playsinline preload="metadata"></video>';
                    this.state.videoElement = document.getElementById('video-player');
                    try {
                        if (Hls.isSupported()) {
                            const hls = new Hls({
                                autoStartLoad: false,
                                maxBufferLength: 30,
                                maxMaxBufferLength: 60,
                                startLevel: -1,
                                capLevelToPlayerSize: true
                            });
                            hls.loadSource(linkUrl);
                            hls.attachMedia(this.state.videoElement);
                            hls.on(Hls.Events.ERROR, () => this.showSubtitleMessage('Lỗi khi tải video.', true));
                            hls.on(Hls.Events.MANIFEST_PARSED, () => hls.startLoad());
                            this.state.player = new Plyr(this.state.videoElement, {
                                controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'fullscreen'],
                                captions: { active: true, update: true },
                                quality: { default: 'auto', options: ['auto', 1080, 720, 480] }
                            });
                        } else if (this.state.videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                            this.state.videoElement.src = linkUrl;
                            this.state.player = new Plyr(this.state.videoElement, {
                                controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'fullscreen'],
                                captions: { active: true, update: true },
                                quality: { default: 'auto', options: ['auto', 1080, 720, 480] }
                            });
                        } else {
                            throw new Error('Trình duyệt không hỗ trợ HLS');
                        }
                        this.elements.rewindBtn.disabled = false;
                        this.elements.forwardBtn.disabled = false;
                    } catch (error) {
                        this.elements.playerContainer.innerHTML = '<p class="error-message">Lỗi khi tải video HLS.</p>';
                        this.elements.rewindBtn.disabled = true;
                        this.elements.forwardBtn.disabled = true;
                    }
                } else if (linkType === 'video' && this.state.isCustom) {
                    this.elements.playerContainer.innerHTML = '<video id="video-player" class="video-player" controls playsinline preload="metadata"></video>';
                    this.state.videoElement = document.getElementById('video-player');
                    try {
                        this.state.videoElement.src = linkUrl;
                        this.state.player = new Plyr(this.state.videoElement, {
                            controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'fullscreen'],
                            captions: { active: true, update: true }
                        });
                        this.state.videoElement.addEventListener('error', () => this.showSubtitleMessage('Lỗi khi tải video.', true));
                        this.elements.rewindBtn.disabled = false;
                        this.elements.forwardBtn.disabled = false;
                    } catch (error) {
                        this.elements.playerContainer.innerHTML = '<p class="error-message">Lỗi khi tải video.</p>';
                        this.elements.rewindBtn.disabled = true;
                        this.elements.forwardBtn.disabled = true;
                    }
                } else if (linkType === 'embed') {
                    this.elements.playerContainer.innerHTML = `<iframe id="video-player" class="video-player" src="${linkUrl}" allow="autoplay; fullscreen"></iframe>`;
                    this.state.player = new Plyr(document.getElementById('video-player'), {
                        controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen']
                    });
                    this.elements.rewindBtn.disabled = true;
                    this.elements.forwardBtn.disabled = true;
                } else {
                    this.elements.playerContainer.innerHTML = '<p class="error-message">Không có link video khả dụng.</p>';
                    this.elements.rewindBtn.disabled = true;
                    this.elements.forwardBtn.disabled = true;
                }
            }

            renderEpisodeLists() {
                const { movieData, slug, apiSource, episodeName, linkType, linkUrl, movieName, customEpisodes } = this.state;
                if (!movieData?.servers) return;

                const customEpisodesQuery = customEpisodes.length > 0 ? `&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}` : '';
                this.state.allEpisodes = movieData.servers.flatMap(server => server.server_data.map(ep => ({
                    name: ep.name,
                    link_m3u8: ep.link_m3u8 || '',
                    link_embed: ep.link_embed || '',
                    link_video: ep.link_video || '',
                    server_name: server.server_name
                })));

                const createEpisodeLink = (ep, type, url, displayName) => {
                    const isActive = ep.name === episodeName && linkType === type && url === linkUrl;
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `watch.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=${type}&url=${encodeURIComponent(url)}&name=${encodeURIComponent(movieName || movieData.name)}${customEpisodesQuery}`;
                    a.textContent = displayName;
                    a.className = isActive ? 'active' : '';
                    li.appendChild(a);
                    return li;
                };

                const renderServer = (server, serverList, m3u8List, embedList, videoList, index) => {
                    if (!server?.server_data?.length || server.server_name === 'Server Custom') {
                        serverList.style.display = 'none';
                        return;
                    }
                    serverList.querySelector('h2').textContent = server.server_name;
                    const m3u8Links = apiSource === 'phimnguonc' ? [] : server.server_data.filter(ep => ep.link_m3u8);
                    const embedLinks = server.server_data.filter(ep => ep.link_embed);
                    const videoLinks = server.server_data.filter(ep => ep.link_video);
                    const fragmentM3u8 = document.createDocumentFragment();
                    const fragmentEmbed = document.createDocumentFragment();
                    const fragmentVideo = document.createDocumentFragment();

                    m3u8Links.forEach(ep => fragmentM3u8.appendChild(createEpisodeLink(ep, 'm3u8', ep.link_m3u8, ep.name === 'Tập 1' ? '1' : ep.name)));
                    embedLinks.forEach(ep => fragmentEmbed.appendChild(createEpisodeLink(ep, 'embed', ep.link_embed, `${ep.name}[e]`)));
                    videoLinks.forEach(ep => fragmentVideo.appendChild(createEpisodeLink(ep, 'video', ep.link_video, `${ep.name}[v]`)));

                    m3u8List.innerHTML = m3u8Links.length > 0 ? '' : '<p class="error-message">Không có link M3U8.</p>';
                    embedList.innerHTML = embedLinks.length > 0 ? '' : '<p class="error-message">Không có link nhúng.</p>';
                    videoList.innerHTML = videoLinks.length > 0 ? '' : '<p class="error-message">Không có link video.</p>';
                    m3u8List.appendChild(fragmentM3u8);
                    embedList.appendChild(fragmentEmbed);
                    videoList.appendChild(fragmentVideo);
                };

                renderServer(movieData.servers[0], this.elements.server1List, this.elements.server1M3u8, this.elements.server1Embed, this.elements.server1Video, 0);
                renderServer(movieData.servers[1], this.elements.server2List, this.elements.server2M3u8, this.elements.server2Embed, this.elements.server2Video, 1);

                const customServer = movieData.servers.find(s => s.server_name === 'Server Custom') || { server_data: customEpisodes };
                if (customServer.server_data.length > 0) {
                    const fragmentM3u8 = document.createDocumentFragment();
                    const fragmentEmbed = document.createDocumentFragment();
                    const fragmentVideo = document.createDocumentFragment();
                    const m3u8Links = apiSource === 'phimnguonc' ? [] : customServer.server_data.filter(ep => ep.link_m3u8);
                    const embedLinks = customServer.server_data.filter(ep => ep.link_embed);
                    const videoLinks = customServer.server_data.filter(ep => ep.link_video);

                    m3u8Links.forEach(ep => fragmentM3u8.appendChild(createEpisodeLink(ep, 'm3u8', ep.link_m3u8, ep.name === 'Tập 1' ? '1' : ep.name)));
                    embedLinks.forEach(ep => fragmentEmbed.appendChild(createEpisodeLink(ep, 'embed', ep.link_embed, `${ep.name}[e]`)));
                    videoLinks.forEach(ep => fragmentVideo.appendChild(createEpisodeLink(ep, 'video', ep.link_video, `${ep.name}[v]`)));

                    this.elements.customM3u8.innerHTML = m3u8Links.length > 0 ? '' : '<p class="error-message">Không có link M3U8.</p>';
                    this.elements.customEmbed.innerHTML = embedLinks.length > 0 ? '' : '<p class="error-message">Không có link nhúng.</p>';
                    this.elements.customVideo.innerHTML = videoLinks.length > 0 ? '' : '<p class="error-message">Không có link video.</p>';
                    this.elements.customM3u8.appendChild(fragmentM3u8);
                    this.elements.customEmbed.appendChild(fragmentEmbed);
                    this.elements.customVideo.appendChild(fragmentVideo);
                } else {
                    this.elements.customList.style.display = 'none';
                }
            }

            setupEpisodeNavigation() {
                const { allEpisodes, episodeName, linkUrl, slug, apiSource, movieName, customEpisodes } = this.state;
                const customEpisodesQuery = customEpisodes.length > 0 ? `&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}` : '';

                const updateEpisodeButtons = () => {
                    const currentIndex = allEpisodes.findIndex(ep => ep.name === episodeName && (ep.link_m3u8 === linkUrl || ep.link_embed === linkUrl || ep.link_video === linkUrl));
                    this.elements.prevEpisodeBtn.disabled = currentIndex <= 0 || allEpisodes.length <= 1;
                    this.elements.nextEpisodeBtn.disabled = currentIndex >= allEpisodes.length - 1 || allEpisodes.length <= 1;
                };
                updateEpisodeButtons();

                this.elements.prevEpisodeBtn.addEventListener('click', () => {
                    const currentIndex = allEpisodes.findIndex(ep => ep.name === episodeName && (ep.link_m3u8 === linkUrl || ep.link_embed === linkUrl || ep.link_video === linkUrl));
                    if (currentIndex > 0) {
                        const prevEpisode = allEpisodes[currentIndex - 1];
                        const newLinkType = prevEpisode.link_m3u8 && apiSource !== 'phimnguonc' ? 'm3u8' :
                                            prevEpisode.link_video && this.state.isCustom ? 'video' : 'embed';
                        const newLinkUrl = newLinkType === 'm3u8' ? prevEpisode.link_m3u8 :
                                          newLinkType === 'video' ? prevEpisode.link_video : prevEpisode.link_embed;
                        window.location.href = `watch.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(prevEpisode.name)}&type=${newLinkType}&url=${encodeURIComponent(newLinkUrl)}&name=${encodeURIComponent(movieName || this.state.movieData.name)}${customEpisodesQuery}`;
                    }
                });

                this.elements.nextEpisodeBtn.addEventListener('click', () => {
                    const currentIndex = allEpisodes.findIndex(ep => ep.name === episodeName && (ep.link_m3u8 === linkUrl || ep.link_embed === linkUrl || ep.link_video === linkUrl));
                    if (currentIndex < allEpisodes.length - 1) {
                        const nextEpisode = allEpisodes[currentIndex + 1];
                        const newLinkType = nextEpisode.link_m3u8 && apiSource !== 'phimnguonc' ? 'm3u8' :
                                            nextEpisode.link_video && this.state.isCustom ? 'video' : 'embed';
                        const newLinkUrl = newLinkType === 'm3u8' ? nextEpisode.link_m3u8 :
                                          newLinkType === 'video' ? nextEpisode.link_video : nextEpisode.link_embed;
                        window.location.href = `watch.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(nextEpisode.name)}&type=${newLinkType}&url=${encodeURIComponent(newLinkUrl)}&name=${encodeURIComponent(movieName || this.state.movieData.name)}${customEpisodesQuery}`;
                    }
                });

                if (this.state.videoElement) {
                    this.elements.rewindBtn.addEventListener('click', () => {
                        if (this.state.linkType === 'm3u8' || this.state.linkType === 'video') {
                            this.state.videoElement.currentTime = Math.max(0, this.state.videoElement.currentTime - 10);
                        } else {
                            this.showSubtitleMessage('Tua video không hỗ trợ.', true);
                        }
                    });

                    this.elements.forwardBtn.addEventListener('click', () => {
                        if (this.state.linkType === 'm3u8' || this.state.linkType === 'video') {
                            this.state.videoElement.currentTime = Math.min(this.state.videoElement.duration, this.state.videoElement.currentTime + 10);
                        } else {
                            this.showSubtitleMessage('Tua video không hỗ trợ.', true);
                        }
                    });
                } else {
                    this.elements.rewindBtn.addEventListener('click', () => this.showSubtitleMessage('Tua video không hỗ trợ.', true));
                    this.elements.forwardBtn.addEventListener('click', () => this.showSubtitleMessage('Tua video không hỗ trợ.', true));
                }

                this.elements.backToDetailBtn.addEventListener('click', () => {
                    const customEpisodesQuery = customEpisodes.length > 0 ? `&episodes=${encodeURIComponent(JSON.stringify(customEpisodes))}` : '';
                    window.location.href = `detail.html?slug=${encodeURIComponent(slug)}&apiSource=${encodeURIComponent(apiSource)}${customEpisodesQuery}&name=${encodeURIComponent(movieName || this.state.movieData.name)}`;
                });

                this.elements.backToHomeBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }

            setupSubtitleHandling() {
                this.elements.loadSubBtn.addEventListener('click', async () => {
                    const sub1File = this.elements.sub1Input.files[0];
                    const sub2File = this.elements.sub2Input.files[0];
                    if (!sub1File && !sub2File) {
                        this.showSubtitleMessage('Vui lòng chọn ít nhất một file phụ đề.', true);
                        return;
                    }
                    this.clearSubtitleTracks();
                    const success = await this.processSubtitleFiles(sub1File, sub2File);
                    if (success && this.state.player && this.state.videoElement) {
                        this.state.player.captions.active = this.state.subtitlesEnabled;
                        setTimeout(() => {
                            if (this.state.videoElement.textTracks.length > 0) {
                                this.state.videoElement.textTracks[0].mode = this.state.subtitlesEnabled ? 'showing' : 'disabled';
                            }
                        }, 1500);
                    }
                });

                this.elements.toggleSubBtn.addEventListener('click', () => {
                    if (this.state.videoElement && this.state.videoElement.textTracks.length > 0) {
                        this.state.subtitlesEnabled = !this.state.subtitlesEnabled;
                        const textTrack = this.state.videoElement.textTracks[0];
                        textTrack.mode = this.state.subtitlesEnabled ? 'showing' : 'disabled';
                        this.elements.toggleSubBtn.innerHTML = `<i class="fas fa-${this.state.subtitlesEnabled ? 'eye' : 'eye-slash'}"></i> ${this.state.subtitlesEnabled ? 'Tắt' : 'Bật'} phụ đề`;
                        this.showSubtitleMessage(`Phụ đề đã được ${this.state.subtitlesEnabled ? 'bật' : 'tắt'}.`);
                    } else {
                        this.showSubtitleMessage('Không có phụ đề để bật/tắt.', true);
                    }
                });
            }
        }

        const app = new MoviePlayer();
        app.init();
    </script>
</body>
</html>