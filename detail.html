<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Phim Hay - Xem phim online miễn phí">
    <meta name="keywords" content="phim Hàn, phim bộ, phim lẻ, xem phim online">
    <meta name="author" content="Phim Hay">
    <title>Phim Hay - Chi tiết phim</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --primary-color: #ff1a1a;
            --primary-hover: #cc0000;
            --bg-dark: #141414;
            --bg-section: #221F1F;
            --text-gray: #B3B3B3;
            --text-white: #ffffff;
            --active-bg: #000;
            --active-text: #FFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-dark);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            gap: 15px;
        }

        .logo {
            max-height: 35px;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-menu a {
            color: var(--text-white);
            text-decoration: none;
            font-size: 1em;
            padding: 8px 15px;
            transition: color 0.3s ease;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }

        .movie-detail {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            background: var(--bg-section);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .movie-poster {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .movie-poster img {
            width: 244px;
            height: 365px;
            border-radius: 8px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .movie-poster img:hover {
            transform: scale(1.05);
        }

        .watch-btn, .home-btn {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--text-white);
            text-decoration: none;
            border-radius: 4px;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .watch-btn:hover, .home-btn:hover {
            background: var(--primary-hover);
        }

        .movie-info {
            flex: 1;
        }

        .movie-info h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .movie-info p {
            margin-bottom: 15px;
            color: var(--text-gray);
            font-size: 1.1em;
        }

        .movie-info strong {
            color: var(--text-white);
            font-weight: 500;
        }

        .episode-list {
            margin-top: 20px;
        }

        .episode-list h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .episode-list h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
            color: var(--text-white);
        }

        .episode-list ul {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .episode-list li {
            list-style: none;
        }

        .episode-list a {
            display: inline-block;
            padding: 10px 15px;
            background: var(--primary-color);
            color: var(--text-white);
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s ease;
            font-size: 1em;
        }

        .episode-list a:hover {
            background: var(--primary-hover);
        }

        .episode-list a.active {
            background: var(--active-bg);
            color: var(--active-text);
        }

        @media (max-width: 768px) {
            .movie-detail {
                flex-direction: column;
                padding: 15px;
            }

            .movie-poster {
                align-items: flex-start;
            }

            .movie-poster img {
                width: 244px;
                height: 365px;
            }

            .watch-btn, .home-btn {
                align-self: center;
            }

            .main-content {
                padding: 120px 15px 30px;
            }

            .movie-info h1 {
                font-size: 2em;
            }
        }

        @media (max-width: 480px) {
            .movie-info h1 {
                font-size: 1.5em;
            }

            .movie-info p {
                font-size: 1em;
            }

            .episode-list a {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://pngimg.com/d/free_PNG90750.png" alt="Phim Hay" class="logo">
            <div class="nav-menu">
                <a href="index.html">Trang chủ</a>
                <a href="phim-han.html">Phim Hàn</a>
                <a href="phim-trung.html">Phim Trung</a>
                <a href="phim-viet.html">Phim Việt</a>
                <a href="phim-my.html">Phim Mỹ</a>
                <a href="truyen-hinh.html">Truyền hình</a>
                <a href="hoat-hinh.html">Hoạt hình</a>
                <a href="khac.html">Khác</a>
            </div>
        </div>
    </header>
    <main class="main-content">
        <section class="movie-detail" id="movie-detail"></section>
        <section class="episode-list">
            <h2>List Bánh mì trứng</h2>
            <div id="api-list">
                <h3>Bánh mì cao cấp</h3>
                <ul id="api-m3u8"></ul>
                <h3>Bánh mì thượng hạng</h3>
                <ul id="api-embed"></ul>
            </div>
        </section>
        <section class="episode-list">
            <h2>List Bánh mì thịt</h2>
            <div id="custom-list">
                <h3>Bánh mì sơ cấp</h3>
                <ul id="custom-m3u8"></ul>
                <h3>Bánh mì đặc biệt </h3>
                <ul id="custom-embed"></ul>
            </div>
        </section>
    </main>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        const apiSource = urlParams.get('apiSource');
        const isCustom = apiSource === 'custom';
        let customEpisodes = [];

        function normalizeMovieData(data, apiSource) {
            const movie = data.movie;
            let categories = [], countries = [], year = movie.year, episodes = [], servers = [];

            if (apiSource === 'ophim1') {
                categories = movie.category?.map(c => c.name) || [];
                countries = movie.country?.map(c => c.name) || [];
                servers = data.episodes?.map(server => ({
                    server_name: server.server_name || 'Server ' + (servers.length + 1),
                    server_data: (server.server_data || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8,
                        link_embed: ep.link_embed,
                    }))
                })) || [];
            } else if (apiSource === 'phimapi') {
                categories = movie.category?.map(c => c.name) || [];
                countries = movie.country?.map(c => c.name) || [];
                servers = data.episodes?.map(server => ({
                    server_name: server.server_name || 'Server ' + (servers.length + 1),
                    server_data: (server.server_data || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8,
                        link_embed: ep.link_embed,
                    }))
                })) || [];
            } else if (apiSource === 'phimnguonc') {
                if (movie.category && typeof movie.category === 'object') {
                    Object.values(movie.category).forEach(group => {
                        if (group.group.name === 'Thể loại') {
                            categories = group.list.map(item => item.name);
                        } else if (group.group.name === 'Quốc gia') {
                            countries = group.list.map(item => item.name);
                        } else if (group.group.name === 'Năm') {
                            year = group.list[0]?.name || year;
                        }
                    });
                }
                servers = data.movie.episodes?.map(server => ({
                    server_name: server.server_name || 'Server ' + (servers.length + 1),
                    server_data: (server.items || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.m3u8,
                        link_embed: ep.embed,
                    }))
                })) || [];
            }

            episodes = servers.flatMap(server => server.server_data);

            return {
                id: movie._id || movie.id,
                name: movie.name,
                slug: movie.slug,
                origin_name: movie.origin_name || movie.original_name,
                poster_url: movie.poster_url || movie.thumb_url || 'poster-not-found.jpg',
                content: movie.content || movie.description || 'Không có nội dung',
                type: movie.type || (movie.total_episodes > 1 ? 'series' : 'movie'),
                status: movie.status || movie.current_episode || 'unknown',
                episode_total: parseInt((movie.episode_total || movie.total_episodes || '1').toString().replace('Tập', '').trim()) || 1,
                episode_current: movie.episode_current || movie.current_episode || 'Tập 1',
                time: movie.time || 'Không rõ',
                quality: movie.quality || 'HD',
                lang: movie.lang || movie.language || 'Vietsub',
                year: year || 'Không rõ',
                actors: Array.isArray(movie.actor) ? movie.actor.join(', ') : (movie.casts || 'Không có thông tin'),
                directors: Array.isArray(movie.director) ? movie.director.join(', ') : (movie.director || 'Không có thông tin'),
                categories: categories.join(', '),
                countries: countries.join(', '),
                episodes,
                servers,
            };
        }

        async function loadCustomMovies() {
            try {
                const files = ['customapi.txt', 'bo.txt', 'le.txt'];
                const allMovies = [];
                for (const file of files) {
                    const response = await fetch(file);
                    const text = await response.text();
                    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes('|') && !lines[i].includes('|sv2|')) {
                            const [pageTag, movieName, posterUrl, quality] = lines[i].split('|').map(item => item.trim());
                            const episodes = [];
                            let slug = movieName.toLowerCase().replace(/\s+/g, '-');
                            for (let j = i + 1; j < lines.length && !lines[j].includes('|'); j++) {
                                if (lines[j].startsWith('https')) {
                                    if (lines[j].endsWith('.m3u8')) {
                                        episodes.push({
                                            name: `${episodes.length + 1}`,
                                            link_m3u8: lines[j],
                                            link_embed: '',
                                        });
                                    } else if (lines[j].includes('youtube.com') || lines[j].includes('vimeo.com') || lines[j].includes('drive.google.com') || lines[j].startsWith('https')) {
                                        episodes.push({
                                            name: `${episodes.length + 1}`,
                                            link_m3u8: '',
                                            link_embed: lines[j],
                                        });
                                    }
                                }
                            }
                            if (episodes.length > 0) {
                                allMovies.push({
                                    name: movieName,
                                    slug,
                                    poster_url: posterUrl,
                                    quality,
                                    content: 'Nội dung không có trong thư viện',
                                    actors: 'Không có thông tin diễn viên',
                                    directors: 'Không có thông tin đạo diễn',
                                    countries: 'Không có thông tin quốc gia',
                                    episodes,
                                    episode_total: episodes.length,
                                    type: episodes.length > 1 ? 'series' : 'movie',
                                    apiSource: 'custom',
                                    servers: [{
                                        server_name: 'Server Custom',
                                        server_data: episodes
                                    }]
                                });
                            }
                        }
                    }
                }
                return allMovies;
            } catch (error) {
                console.error('Lỗi khi tải file text:', error);
                return [];
            }
        }

        async function fetchMovieData() {
            let movieData = {};
            let customMovie = null;

            if (isCustom) {
                const customMovies = await loadCustomMovies();
                customMovie = customMovies.find(m => m.slug === slug);
                if (customMovie) {
                    movieData = { ...customMovie };
                    customEpisodes = movieData.episodes;
                }
            } else {
                const apiUrl = apiSource === 'ophim1' ? `https://ophim1.com/phim/${slug}`
                    : apiSource === 'phimapi' ? `https://phimapi.com/phim/${slug}`
                    : `https://phim.nguonc.com/api/film/${slug}`;
                try {
                    const response = await fetch(apiUrl, { mode: 'cors' });
                    const data = await response.json();
                    if (data.status === true || data.status === 'success') {
                        movieData = normalizeMovieData(data, apiSource);
                    }
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu phim:', error);
                }
                const customMovies = await loadCustomMovies();
                customMovie = customMovies.find(m => m.slug === slug);
                if (customMovie) {
                    customEpisodes = customMovie.episodes;
                }
            }

            const movieDetail = document.getElementById('movie-detail');
            const firstEpisode = movieData.episodes?.find(ep => ep.link_m3u8 || ep.link_embed) || customEpisodes[0];
            const watchUrl = firstEpisode
                ? `watch.html?slug=${encodeURIComponent(movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(firstEpisode.name)}&type=${firstEpisode.link_m3u8 ? 'm3u8' : 'embed'}&url=${encodeURIComponent(firstEpisode.link_m3u8 || firstEpisode.link_embed)}&name=${encodeURIComponent(movieData.name)}&episodes=${encodeURIComponent(JSON.stringify(movieData.episodes || []))}&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}&episode_total=${movieData.episode_total || customEpisodes.length}&type=${movieData.type || (customEpisodes.length > 1 ? 'series' : 'movie')}&poster=${encodeURIComponent(movieData.poster_url || '')}&quality=${encodeURIComponent(movieData.quality || 'HD')}&content=${encodeURIComponent(movieData.content || 'Không có nội dung')}&actors=${encodeURIComponent(movieData.actors || 'Không có thông tin')}&directors=${encodeURIComponent(movieData.directors || 'Không có thông tin')}&countries=${encodeURIComponent(movieData.countries || 'Không rõ')}`
                : `watch.html?slug=${encodeURIComponent(movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&name=${encodeURIComponent(movieData.name)}`;
            movieDetail.innerHTML = `
                <div class="movie-poster">
                    <img src="${movieData.poster_url || 'poster-not-found.jpg'}" alt="${movieData.name}" onerror="this.src='poster-not-found.jpg'">
                    <a href="${watchUrl}" class="watch-btn">Xem phim</a>
                    <a href="index.html" class="home-btn">Quay lại trang chủ</a>
                </div>
                <div class="movie-info">
                    <h1>${movieData.name || 'Không xác định'}</h1>
                    <p><strong>Thể loại:</strong> ${movieData.categories || 'Không rõ'}</p>
                    <p><strong>Quốc gia:</strong> ${movieData.countries || 'Không rõ'}</p>
                    <p><strong>Năm:</strong> ${movieData.year || 'Không rõ'}</p>
                    <p><strong>Chất lượng:</strong> ${movieData.quality || 'HD'}</p>
                    <p><strong>Thời lượng:</strong> ${movieData.time || 'Không rõ'}</p>
                    <p><strong>Diễn viên:</strong> ${movieData.actors || 'Không có thông tin'}</p>
                    <p><strong>Đạo diễn:</strong> ${movieData.directors || 'Không có thông tin'}</p>
                    <p><strong>Nội dung:</strong> ${movieData.content?.replace(/<[^>]+>/g, '') || 'Không có nội dung'}</p>
                </div>
            `;

            const apiM3u8 = document.getElementById('api-m3u8');
            const apiEmbed = document.getElementById('api-embed');
            if (!isCustom && movieData.episodes?.length > 0) {
                const m3u8Links = movieData.episodes.filter(ep => ep.link_m3u8);
                const embedLinks = movieData.episodes.filter(ep => ep.link_embed);
                apiM3u8.innerHTML = m3u8Links.length > 0 ? m3u8Links.map(ep => {
                    const displayName = ep.name === 'Tập 1' ? '1' : ep.name;
                    return `<li><a href="watch.html?slug=${encodeURIComponent(movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=m3u8&url=${encodeURIComponent(ep.link_m3u8)}&name=${encodeURIComponent(movieData.name)}&episodes=${encodeURIComponent(JSON.stringify(movieData.episodes))}&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}&episode_total=${movieData.episode_total}&type=${movieData.type}&poster=${encodeURIComponent(movieData.poster_url || '')}&quality=${encodeURIComponent(movieData.quality || 'HD')}&content=${encodeURIComponent(movieData.content || 'Không có nội dung')}&actors=${encodeURIComponent(movieData.actors || 'Không có thông tin')}&directors=${encodeURIComponent(movieData.directors || 'Không có thông tin')}&countries=${encodeURIComponent(movieData.countries || 'Không rõ')}">${displayName}</a></li>`;
                }).join('') : '<p>Không có link từ Website.</p>';
                apiEmbed.innerHTML = embedLinks.length > 0 ? embedLinks.map(ep => {
                    const displayName = `${ep.name}[e]`;
                    return `<li><a href="watch.html?slug=${encodeURIComponent(movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=embed&url=${encodeURIComponent(ep.link_embed)}&name=${encodeURIComponent(movieData.name)}&episodes=${encodeURIComponent(JSON.stringify(movieData.episodes))}&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}&episode_total=${movieData.episode_total}&type=${movieData.type}&poster=${encodeURIComponent(movieData.poster_url || '')}&quality=${encodeURIComponent(movieData.quality || 'HD')}&content=${encodeURIComponent(movieData.content || 'Không có nội dung')}&actors=${encodeURIComponent(movieData.actors || 'Không có thông tin')}&directors=${encodeURIComponent(movieData.directors || 'Không có thông tin')}&countries=${encodeURIComponent(movieData.countries || 'Không rõ')}">${displayName}</a></li>`;
                }).join('') : '<p>Không có link Bên ngoài.</p>';
            } else {
                apiM3u8.innerHTML = '<p>Không có link từ Website.</p>';
                apiEmbed.innerHTML = '<p>Không có link Bên ngoài.</p>';
            }

            const customM3u8 = document.getElementById('custom-m3u8');
            const customEmbed = document.getElementById('custom-embed');
            if (customEpisodes.length > 0) {
                const m3u8Links = customEpisodes.filter(ep => ep.link_m3u8);
                const embedLinks = customEpisodes.filter(ep => ep.link_embed);
                customM3u8.innerHTML = m3u8Links.length > 0 ? m3u8Links.map(ep => {
                    return `<li><a href="watch.html?slug=${encodeURIComponent(movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=m3u8&url=${encodeURIComponent(ep.link_m3u8)}&name=${encodeURIComponent(movieData.name)}&episodes=${encodeURIComponent(JSON.stringify(movieData.episodes || []))}&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}&episode_total=${movieData.episode_total || customEpisodes.length}&type=${movieData.type || (customEpisodes.length > 1 ? 'series' : 'movie')}&poster=${encodeURIComponent(movieData.poster_url || '')}&quality=${encodeURIComponent(movieData.quality || 'HD')}&content=${encodeURIComponent(movieData.content || 'Không có nội dung')}&actors=${encodeURIComponent(movieData.actors || 'Không có thông tin')}&directors=${encodeURIComponent(movieData.directors || 'Không có thông tin')}&countries=${encodeURIComponent(movieData.countries || 'Không rõ')}">${ep.name}</a></li>`;
                }).join('') : '<p>Không có link từ Website.</p>';
                customEmbed.innerHTML = embedLinks.length > 0 ? embedLinks.map(ep => {
                    return `<li><a href="watch.html?slug=${encodeURIComponent(movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=embed&url=${encodeURIComponent(ep.link_embed)}&name=${encodeURIComponent(movieData.name)}&episodes=${encodeURIComponent(JSON.stringify(movieData.episodes || []))}&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}&episode_total=${movieData.episode_total || customEpisodes.length}&type=${movieData.type || (customEpisodes.length > 1 ? 'series' : 'movie')}&poster=${encodeURIComponent(movieData.poster_url || '')}&quality=${encodeURIComponent(movieData.quality || 'HD')}&content=${encodeURIComponent(movieData.content || 'Không có nội dung')}&actors=${encodeURIComponent(movieData.actors || 'Không có thông tin')}&directors=${encodeURIComponent(movieData.directors || 'Không có thông tin')}&countries=${encodeURIComponent(movieData.countries || 'Không rõ')}">${ep.name}</a></li>`;
                }).join('') : '<p>Không có link Bên ngoài.</p>';
            } else {
                customM3u8.innerHTML = '<p>Không có link từ Website.</p>';
                customEmbed.innerHTML = '<p>Không có link Bên ngoài.</p>';
            }
        }

        fetchMovieData();
    </script>
</body>
</html>