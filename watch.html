<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Xem phim</title>
  <link href="https://cdn.plyr.io/3.7.8/plyr.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a191f;
      color: #fff;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    /* HEADER */
    header {
      background: #212026;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .Top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
    }

    .Logo {
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 6px;
      transition: color 0.2s;
    }

    .Logo:hover { color: #de1212; }

    .MenuBtn {
      font-size: 22px;
      cursor: pointer;
      padding: 8px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      transition: background 0.2s;
    }

    .MenuBtn:hover { background: rgba(255, 255, 255, 0.2); }

    .MenuDropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 220px;
      background: #2b2b32;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      opacity: 0;
      transition: opacity 0.2s;
      max-height: 300px;
      overflow-y: auto;
    }

    .MenuBtn.active .MenuDropdown { display: block; opacity: 1; }

    .MenuDropdown h3 {
      margin: 10px 0 5px 10px;
      font-size: 14px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
      color: #bdbdbd;
    }

    .MenuDropdown button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: none;
      background: #444;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }

    .MenuDropdown button:hover { background: #555; }

    /* SEARCH */
    .Search {
      display: flex;
      align-items: center;
      position: relative;
    }

    .Search input {
      width: 0;
      opacity: 0;
      transition: all 0.3s ease;
      padding: 8px;
      border: none;
      border-radius: 6px;
      outline: none;
      background: #2a292f;
      color: #fff;
      font-size: 14px;
    }

    .Search.active input {
      width: 180px;
      opacity: 1;
    }

    .Search button {
      margin-left: 8px;
      background: #de1212;
      border: none;
      padding: 8px 12px;
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      transition: background 0.2s;
    }

    .Search button:hover { background: #b00d0d; }

    /* MAIN */
    main {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }

    .breadcrumbs {
      font-size: 14px;
      margin-bottom: 15px;
      color: #bdbdbd;
    }

    .breadcrumbs a {
      color: #de1212;
      text-decoration: none;
      transition: color 0.2s;
    }

    .breadcrumbs a:hover { color: #b00d0d; text-decoration: underline; }

    .movie-info { margin-bottom: 20px; }

    .movie-info h1 { font-size: 24px; margin: 0 0 10px; }

    .movie-info p { font-size: 16px; color: #bdbdbd; }

    /* PLAYER */
    .player-container {
      width: 900px;
      height: 500px;
      margin: 0 auto 20px;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player-container video,
    .player-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
    }

    /* SUBTITLE UPLOAD */
    .subtitle-upload {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .subtitle-upload label { display: none; }

    .subtitle-upload input[type="file"] { display: none; }

    .subtitle-upload .upload-btn {
      background: linear-gradient(145deg, #de1212, #ff4d4d);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .subtitle-upload .upload-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 10px rgba(0,0,0,0.4);
    }

    /* EPISODES */
    .episodes h3 { font-size: 18px; margin: 20px 0 10px; color: #fff; }

    .episode-section {
      margin-bottom: 20px;
    }

    .episode-section .toggle-btn {
      background: linear-gradient(145deg, #555, #333);
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .episode-section .toggle-btn:hover {
      background: linear-gradient(145deg, #ff4d4d, #de1212);
    }

    .episode-section .toggle-btn .icon {
      font-size: 18px;
      transition: transform 0.3s ease;
    }

    .episode-section.open .toggle-btn .icon {
      transform: rotate(180deg);
    }

    .episode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .episode-section.open .episode-grid {
      max-height: 500px;
      padding-top: 10px;
    }

    .episode-grid button {
      background: linear-gradient(145deg, #555, #333);
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .episode-grid button:hover {
      background: linear-gradient(145deg, #ff4d4d, #de1212);
      transform: scale(1.05);
      box-shadow: 0 6px 10px rgba(0,0,0,0.4);
    }

    .episode-grid button.active {
      background: linear-gradient(145deg, #de1212, #ff4d4d);
      border: 2px solid #fff;
      transform: scale(1.05);
      box-shadow: 0 6px 10px rgba(0,0,0,0.5);
    }

    /* RESPONSIVE */
    @media (max-width: 1023px) {
      .Search.active input { width: 120px; }
      .player-container {
        width: 100%;
        height: calc(100vw * 500 / 900);
      }
    }

    @media (max-width: 480px) {
      .Search.active input { width: 100px; }
      .movie-info h1 { font-size: 20px; }
      .movie-info p { font-size: 14px; }
      .episode-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }

    @media (max-width: 360px) {
      .episode-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    }
  </style>
</head>
<body>
  <header>
    <div class="Logo" onclick="location.href='index.html'">üé¨ B√°nh M√¨ üé¨</div>
    <div class="Top">
      <div class="MenuBtn" id="menuBtn">‚ò∞
        <div class="MenuDropdown">
          <!-- Menu dropdown c√≥ th·ªÉ th√™m n·ªôi dung t·ª´ index.html n·∫øu c·∫ßn -->
        </div>
      </div>
      <div class="Search" id="searchBox">
        <input id="searchInput" placeholder="Nh·∫≠p t√™n phim..." />
        <button id="searchBtn">T√¨m</button>
      </div>
    </div>
  </header>
  <main>
    <div class="breadcrumbs" id="breadcrumbs"></div>
    <div class="movie-info" id="movieInfo"></div>
    <div class="player-container" id="playerContainer"></div>
    <div class="subtitle-upload" id="subtitleUpload">
      <label for="subtitleInput">T·∫£i l√™n ph·ª• ƒë·ªÅ (.srt, .vtt):</label>
      <input type="file" id="subtitleInput" accept=".srt,.vtt" />
      <button class="upload-btn" onclick="document.getElementById('subtitleInput').click()">T·∫£i l√™n ph·ª• ƒë·ªÅ</button>
    </div>
    <div class="episodes" id="episodes">
      <h3>Danh s√°ch t·∫≠p</h3>
      <div id="episodeList"></div>
    </div>
  </main>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
  <script>
    // Config sources v√† labels (l∆∞·ª£c b·ªè labels cho ng·∫Øn g·ªçn, gi·ªØ nguy√™n c·∫•u tr√∫c)
    const sources = [
      { name: "üçû B√°nh M√¨ 01", base: "https://ophim1.com/v1/api", type: "ophim" },
      { name: "üçû B√°nh M√¨ 02", base: "https://phimapi.com/v1/api", type: "phimapi" },
      { name: "üçû B√°nh M√¨ 03", base: "https://phim.nguonc.com/api", type: "nguonc" }
    ];

    const labels = {
      "hanh-dong": "H√†nh ƒê·ªông", "phieu-luu": "Phi√™u L∆∞u", "hoat-hinh": "Ho·∫°t H√¨nh", "hai": "H√†i",
      "hinh-su": "H√¨nh S·ª±", "tai-lieu": "T√†i Li·ªáu", "chinh-kich": "Ch√≠nh K·ªãch", "gia-dinh": "Gia ƒê√¨nh",
      "gia-tuong": "Gi·∫£ T∆∞·ªüng", "lich-su": "L·ªãch S·ª≠", "kinh-di": "Kinh D·ªã", "nhac": "Nh·∫°c",
      "bi-an": "B√≠ ·∫®n", "lang-man": "L√£ng M·∫°n", "khoa-hoc-vien-tuong": "Khoa H·ªçc Vi·ªÖn T∆∞·ªüng",
      "gay-can": "G√¢y C·∫•n", "chien-tranh": "Chi·∫øn Tranh", "tam-ly": "T√¢m L√Ω", "tinh-cam": "T√¨nh C·∫£m",
      "co-trang": "C·ªï Trang", "mien-tay": "Mi·ªÅn T√¢y", "phim-18": "Phim 18+",
      "au-my": "√Çu M·ªπ", "anh": "Anh", "trung-quoc": "Trung Qu·ªëc", "indonesia": "Indonesia",
      "viet-nam": "Vi·ªát Nam", "phap": "Ph√°p", "hong-kong": "H·ªìng K√¥ng", "han-quoc": "H√†n Qu·ªëc",
      "nhat-ban": "Nh·∫≠t B·∫£n", "thai-lan": "Th√°i Lan", "dai-loan": "ƒê√†i Loan", "nga": "Nga",
      "ha-lan": "H√† Lan", "philippines": "Philippines", "an-do": "·∫§n ƒê·ªô", "quoc-gia-khac": "Qu·ªëc gia kh√°c",
      "duc": "ƒê·ª©c", "tay-ban-nha": "T√¢y Ban Nha", "tho-nhi-ky": "Th·ªï Nhƒ© K·ª≥", "mexico": "Mexico",
      "ba-lan": "Ba Lan", "uc": "√öc", "thu·ªµ-den": "Th·ª•y ƒêi·ªÉn", "malaysia": "Malaysia",
      "brazil": "Brazil", "bo-dao-nha": "B·ªì ƒê√†o Nha", "y": "√ù", "dan-mach": "ƒêan M·∫°ch",
      "uae": "UAE", "na-uy": "Na Uy", "thu·ªµ-si": "Th·ª•y Sƒ©", "chau-phi": "Ch√¢u Phi",
      "nam-phi": "Nam Phi", "ukraina": "Ukraina", "a-rap-xe-ut": "·∫¢ R·∫≠p X√™ √öt", "bi": "B·ªâ",
      "ireland": "Ireland", "colombia": "Colombia", "phan-lan": "Ph·∫ßn Lan", "chile": "Chile",
      "hy-lap": "Hy L·∫°p", "nigeria": "Nigeria", "argentina": "Argentina", "singapore": "Singapore",
      "phim-moi": "Phim m·ªõi", "phim-bo": "Phim b·ªô", "phim-le": "Phim l·∫ª", "shows": "TV Shows",
      "hoat-hinh": "Ho·∫°t h√¨nh", "phim-vietsub": "Phim vietsub", "phim-thuyet-minh": "Phim thuy·∫øt minh",
      "phim-long-tieng": "Phim l·ªìng ti·∫øng", "phim-bo-dang-chieu": "Phim b·ªô ƒëang chi·∫øu",
      "phim-bo-da-hoan-thanh": "Phim b·ªô ƒë√£ ho√†n th√†nh", "phim-sap-chieu": "Phim s·∫Øp chi·∫øu",
      "subteam": "Subteam", "phim-chieu-rap": "Phim chi·∫øu r·∫°p"
    };
    const reverseLabels = Object.fromEntries(Object.entries(labels).map(([k, v]) => [v, k]));

    // Query params
    const params = new URLSearchParams(location.search);
    const slug = params.get("slug");
    const source = params.get("src") ? decodeURIComponent(params.get("src")) : null;
    const srcConf = sources.find(s => s.name === source);
    const ep = params.get("ep") ? decodeURIComponent(params.get("ep")) : null;
    let isEmbed = params.get("isEmbed") === "true";
    const epName = params.get("epName") || "T·∫≠p ƒëang xem";
    const name = params.get("name") ? decodeURIComponent(params.get("name")) : "";
    const category = params.get("category") || "";
    const region = params.get("region") || "";
    const year = params.get("year") || "";
    const type = params.get("type") || "";
    const search = params.get("search") || "";

    // Force isEmbed based on source
    if (srcConf?.type === 'nguonc') isEmbed = true;

    // DOM refs
    const playerContainer = document.getElementById("playerContainer");
    const movieInfo = document.getElementById("movieInfo");
    const breadcrumbs = document.getElementById("breadcrumbs");
    const episodeList = document.getElementById("episodeList");
    const subtitleUpload = document.getElementById("subtitleUpload");
    const subtitleInput = document.getElementById("subtitleInput");
    const searchBox = document.getElementById("searchBox");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const menuBtn = document.getElementById("menuBtn");

    // Helpers
    function slugify(text) {
      if (!text) return "";
      return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D").replace(/[^a-z0-9\s-]/g, "").trim().replace(/\s+/g, "-");
    }

    function fixImagePath(img, src) {
      if (!img) return "";
      if (img.startsWith("http")) return img;
      if (src.type === "ophim") return `https://img.ophim.live/uploads/movies${img.startsWith("/") ? img : "/" + img}`;
      if (src.type === "phimapi") return `https://phimimg.com${img.startsWith("/") ? img : "/" + img}`;
      if (src.type === "nguonc") return img;
      return img.startsWith("/") ? img : "/" + img;
    }

    async function tryUrls(urls) {
      for (const u of urls) {
        try {
          const res = await fetch(u);
          if (!res.ok) {
            console.warn(`Failed to fetch ${u}: ${res.status}`);
            continue;
          }
          const json = await res.json();
          if (json.data?.item || json.movie || json.data) return { url: u, data: json };
        } catch (e) {
          console.warn(`Error fetching ${u}:`, e);
        }
      }
      console.warn("No valid response from any URL");
      return null;
    }

    async function fetchEpisodes(slug, srcConf) {
      const epUrl = srcConf.type === "nguonc" ? `${srcConf.base}/film/${slug}/episodes` : `${srcConf.base}/phim/${slug}/episodes`;
      try {
        const res = await fetch(epUrl);
        if (!res.ok) {
          console.warn(`Failed to fetch episodes from ${epUrl}: ${res.status}`);
          return [];
        }
        const data = await res.json();
        return data.episodes || data.data?.episodes || [];
      } catch (e) {
        console.warn(`Error fetching episodes from ${epUrl}:`, e);
        return [];
      }
    }

    // Convert SRT to VTT
    function convertSrtToVtt(srtContent) {
      try {
        return 'WEBVTT\n\n' + srtContent
          .replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2')
          .replace(/^\d+$/gm, (match) => `${match}\n`);
      } catch (e) {
        console.warn("Error converting SRT to VTT:", e);
        return null;
      }
    }

    // Validate M3U8 URL
    async function validateUrl(url) {
      try {
        const res = await fetch(url, { method: 'HEAD' });
        return res.ok;
      } catch (e) {
        console.warn(`Error validating URL ${url}:`, e);
        return false;
      }
    }

    // Load player
    let player;
    async function loadPlayer() {
      if (!ep || !srcConf) {
        playerContainer.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y link video ho·∫∑c ngu·ªìn kh√¥ng h·ª£p l·ªá.</p>";
        subtitleUpload.style.display = "none";
        return;
      }

      // Validate M3U8 URL
      if (!isEmbed) {
        const isValid = await validateUrl(ep);
        if (!isValid) {
          playerContainer.innerHTML = "<p>Link video kh√¥ng kh·∫£ d·ª•ng (404). Vui l√≤ng ch·ªçn t·∫≠p kh√°c.</p>";
          subtitleUpload.style.display = "none";
          return;
        }
      }

      if (isEmbed) {
        playerContainer.innerHTML = `<iframe src="${ep}" allowfullscreen allow="autoplay"></iframe>`;
        subtitleUpload.style.display = "none";
      } else {
        playerContainer.innerHTML = `<video id="videoPlayer" playsinline controls><source src="${ep}" type="application/x-mpegURL" /></video>`;
        subtitleUpload.style.display = "flex";
        player = new Plyr("#videoPlayer", {
          controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'fullscreen'],
          settings: ['captions', 'quality', 'speed'],
          captions: { active: true, update: true }
        });

        if (Hls.isSupported()) {
          const hls = new Hls({ lowLatencyMode: true });
          hls.loadSource(ep);
          hls.attachMedia(document.getElementById("videoPlayer"));
          hls.on(Hls.Events.MANIFEST_PARSED, () => player.play().catch(e => console.warn("Play error:", e)));
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.warn(`HLS error for ${ep}:`, data);
            if (data.fatal) playerContainer.innerHTML = "<p>L·ªói khi t·∫£i video M3U8. Vui l√≤ng ch·ªçn t·∫≠p kh√°c.</p>";
          });
        } else if (document.getElementById("videoPlayer").canPlayType('application/vnd.apple.mpegurl')) {
          document.getElementById("videoPlayer").src = ep;
          document.getElementById("videoPlayer").play().catch(e => console.warn("Native play error:", e));
        } else {
          playerContainer.innerHTML = "<p>Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t video M3U8.</p>";
        }
      }
    }

    // Handle subtitle upload
    subtitleInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file || !/\.(srt|vtt)$/i.test(file.name)) {
        alert("Vui l√≤ng ch·ªçn file ph·ª• ƒë·ªÅ ƒë·ªãnh d·∫°ng .srt ho·∫∑c .vtt");
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        let content = event.target.result;
        const fileType = file.name.endsWith('.srt') ? 'srt' : 'vtt';

        if (fileType === 'srt') {
          content = convertSrtToVtt(content);
          if (!content) {
            alert("L·ªói khi x·ª≠ l√Ω file SRT. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.");
            return;
          }
        }

        const subtitleBlob = new Blob([content], { type: 'text/vtt' });
        const subtitleUrl = URL.createObjectURL(subtitleBlob);

        if (player && !isEmbed) {
          // Remove existing tracks
          const video = document.getElementById("videoPlayer");
          while (video.textTracks.length > 0) {
            video.textTracks[0].mode = 'disabled';
            video.removeChild(video.querySelector('track'));
          }

          // Add new track
          const track = document.createElement("track");
          track.kind = "captions";
          track.label = "Ph·ª• ƒë·ªÅ t·∫£i l√™n";
          track.srclang = "vi";
          track.src = subtitleUrl;
          track.default = true;
          video.appendChild(track);

          // Ensure captions are enabled
          player.toggleCaptions(true);
        } else {
          alert("Kh√¥ng th·ªÉ t·∫£i ph·ª• ƒë·ªÅ v√¨ video ch∆∞a s·∫µn s√†ng ho·∫∑c ƒëang ·ªü ch·∫ø ƒë·ªô embed.");
        }
      };
      reader.onerror = () => alert("L·ªói khi ƒë·ªçc file ph·ª• ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i.");
      reader.readAsText(file, 'UTF-8');
    });

    // Load movie info
    function loadMovieInfo() {
      movieInfo.innerHTML = `<h1>${name || "Phim"}</h1><p>T·∫≠p ƒëang xem: ${epName}</p>`;
    }

    // Load breadcrumbs
    function loadBreadcrumbs() {
      const catSlug = category || "";
      const countrySlug = region || "";
      breadcrumbs.innerHTML = `
        <a href="index.html">Trang ch·ªß</a> > 
        ${catSlug ? `<a href="index.html?category=${catSlug}">${labels[catSlug] || catSlug}</a> > ` : ""}
        ${countrySlug ? `<a href="index.html?region=${countrySlug}">${labels[countrySlug] || countrySlug}</a> > ` : ""}
        ${year ? `<a href="index.html?year=${year}">${year}</a> > ` : ""}
        <a href="detail.html?slug=${encodeURIComponent(slug)}&src=${encodeURIComponent(source)}${category ? '&category=' + encodeURIComponent(category) : ''}${region ? '&region=' + encodeURIComponent(region) : ''}${year ? '&year=' + encodeURIComponent(year) : ''}${type ? '&type=' + encodeURIComponent(type) : ''}${search ? '&search=' + encodeURIComponent(search) : ''}">${name || "Phim"}</a> > Xem
      `;
    }

    // Load episodes
    async function loadEpisodes() {
      if (!slug || !srcConf) {
        episodeList.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y phim ho·∫∑c ngu·ªìn kh√¥ng h·ª£p l·ªá.</p>";
        return;
      }

      const url = srcConf.type === "nguonc" ? `${srcConf.base}/film/${slug}` : `${srcConf.base}/phim/${slug}`;
      const res = await tryUrls([url]);
      if (!res) {
        episodeList.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y phim. Vui l√≤ng ki·ªÉm tra l·∫°i ngu·ªìn.</p>";
        return;
      }

      const data = res.data;
      console.log("API response:", data); // Debug API response
      const item = data.data?.item || data.movie || data.data || {};
      let episodes = item.episodes || item.episode || item.data?.episodes || item.server_data || Object.values(item.episodes || {}).filter(Array.isArray) || [];
      if (episodes.length === 0) episodes = await fetchEpisodes(slug, srcConf);

      if (episodes.length === 0) {
        episodeList.innerHTML = "<p>Phim hi·ªán ch∆∞a c√≥ t·∫≠p n√†o. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
        return;
      }

      episodeList.innerHTML = "";
      const vsDiv = document.createElement("div"); vsDiv.className = "episode-section open";
      const vsToggle = document.createElement("button"); vsToggle.className = "toggle-btn"; vsToggle.innerHTML = 'Vietsub <span class="icon">V</span>'; vsDiv.appendChild(vsToggle);
      const vsGrid = document.createElement("div"); vsGrid.className = "episode-grid"; vsDiv.appendChild(vsGrid);

      const tmDiv = document.createElement("div"); tmDiv.className = "episode-section";
      const tmToggle = document.createElement("button"); tmToggle.className = "toggle-btn"; tmToggle.innerHTML = 'Thuy·∫øt Minh <span class="icon">V</span>'; tmDiv.appendChild(tmToggle);
      const tmGrid = document.createElement("div"); tmGrid.className = "episode-grid"; tmDiv.appendChild(tmGrid);

      const ltDiv = document.createElement("div"); ltDiv.className = "episode-section";
      const ltToggle = document.createElement("button"); ltToggle.className = "toggle-btn"; ltToggle.innerHTML = 'L·ªìng Ti·∫øng <span class="icon">V</span>'; ltDiv.appendChild(ltToggle);
      const ltGrid = document.createElement("div"); ltGrid.className = "episode-grid"; ltDiv.appendChild(ltGrid);

      // Toggle functionality
      [vsToggle, tmToggle, ltToggle].forEach(toggle => {
        toggle.addEventListener('click', () => {
          const section = toggle.parentElement;
          section.classList.toggle('open');
          const icon = toggle.querySelector('.icon');
          icon.textContent = section.classList.contains('open') ? 'V' : '^';
        });
      });

      episodes.forEach((server, serverIdx) => {
        const serverName = server.server_name || server.name || `Server ${serverIdx + 1}`;
        let languageType = 'vs';
        if (/thuy·∫øt minh|tm/i.test(serverName) || (item.language && /thuy·∫øt minh/i.test(item.language))) languageType = 'tm';
        else if (/l·ªìng ti·∫øng|lt/i.test(serverName) || (item.language && /l·ªìng ti·∫øng/i.test(item.language))) languageType = 'lt';

        const serverData = server.items || server.server_data || server.episodes || [];
        const grid = languageType === 'tm' ? tmGrid : languageType === 'lt' ? ltGrid : vsGrid;

        serverData.forEach((epItem, idx) => {
          const m3u8 = epItem.link_m3u8 || epItem.link || epItem.m3u8 || "";
          const embed = epItem.embed || epItem.link_embed || "";
          const currEpName = epItem.name || epItem.title || `T·∫≠p ${idx + 1}`;
          const queryParams = new URLSearchParams({ slug, src: source, name: item.name || item.title || '', category, region, year, type, search, epName: currEpName });

          if (m3u8 && srcConf.type !== "nguonc") {
            queryParams.set('ep', m3u8);
            queryParams.set('isEmbed', false);
            const btn = document.createElement("button");
            btn.textContent = `${currEpName} (A)`;
            btn.onclick = () => location.href = `watch.html?${queryParams.toString()}`;
            if (currEpName === epName || m3u8 === ep) btn.classList.add("active");
            grid.appendChild(btn);
          }

          if (embed && srcConf.type === "nguonc") {
            queryParams.set('ep', embed);
            queryParams.set('isEmbed', true);
            const btn = document.createElement("button");
            btn.textContent = `${currEpName} (B)`;
            btn.onclick = () => location.href = `watch.html?${queryParams.toString()}`;
            if (currEpName === epName || embed === ep) btn.classList.add("active");
            grid.appendChild(btn);
          }
        });
      });

      if (vsGrid.children.length > 0) episodeList.appendChild(vsDiv);
      if (tmGrid.children.length > 0) episodeList.appendChild(tmDiv);
      if (ltGrid.children.length > 0) episodeList.appendChild(ltDiv);
      if (episodeList.children.length === 0) episodeList.innerHTML = "<p>Phim hi·ªán ch∆∞a c√≥ t·∫≠p n√†o. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
    }

    // Search v√† menu handlers
    searchBtn.addEventListener("click", () => {
      const q = searchInput.value.trim();
      if (!q) return searchBox.classList.toggle("active"), searchInput.focus();
      location.href = `index.html?search=${encodeURIComponent(q)}`;
    });

    searchInput.addEventListener("keydown", (e) => e.key === "Enter" && searchBtn.click());

    menuBtn.addEventListener("click", (e) => { e.stopPropagation(); menuBtn.classList.toggle("active"); });
    document.addEventListener("click", () => menuBtn.classList.remove("active"));

    // Load on DOM content loaded
    window.addEventListener("DOMContentLoaded", () => {
      loadPlayer();
      loadMovieInfo();
      loadBreadcrumbs();
      loadEpisodes();
    });
  </script>
</body>
</html>