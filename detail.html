<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Chi ti·∫øt phim</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #1a191f;
      color: #fff;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    header {
      background: #212026;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .Top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1200px;
    }
    .Logo {
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      margin-bottom: 6px;
    }
    .MenuBtn {
      font-size: 22px;
      cursor: pointer;
      padding: 5px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      transition: background .2s;
      position: relative;
    }
    .MenuBtn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .MenuDropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 220px;
      background: #2b2b32;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      opacity: 0;
      transition: opacity .2s;
      max-height: 300px;
      overflow-y: auto;
    }
    .MenuBtn.active .MenuDropdown {
      display: block;
      opacity: 1;
    }
    .MenuDropdown h3 {
      margin: 10px 0 5px 10px;
      font-size: 14px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .MenuDropdown button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: none;
      background: #444;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: background .2s;
    }
    .MenuDropdown button:hover {
      background: #555;
    }
    .Search {
      display: flex;
      align-items: center;
      position: relative;
    }
    .Search input {
      width: 0;
      opacity: 0;
      transition: all .25s;
      padding: 6px;
      border: none;
      border-radius: 5px;
      outline: none;
      background: #2a292f;
      color: #fff;
    }
    .Search.active input {
      width: 180px;
      opacity: 1;
    }
    .Search button {
      margin-left: 8px;
      background: #de1212;
      border: none;
      padding: 7px 10px;
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
    }
    main {
      max-width: 1200px;
      margin: 10px auto;
      padding: 10px;
    }
    .breadcrumbs {
      font-size: 14px;
      margin-bottom: 15px;
      color: #bdbdbd;
    }
    .breadcrumbs a {
      color: #de1212;
      text-decoration: none;
    }
    .breadcrumbs a:hover {
      text-decoration: underline;
    }
    .banner {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background: #212026;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
      position: relative;
    }
    .banner .poster {
      position: relative;
      overflow: hidden;
      border-radius: 10px 0 0 10px;
      flex: 0 0 250px;
    }
    .banner .poster img {
      width: 100%;
      height: 350px;
      object-fit: cover;
      display: block;
      transition: filter .25s;
    }
    .banner:hover .poster img {
      filter: brightness(.7);
    }
    .banner .play-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #de1212;
      color: #fff;
      font-size: 20px;
      padding: 10px 12px;
      border-radius: 50%;
      opacity: 0;
      transition: opacity .2s;
      cursor: pointer;
    }
    .banner:hover .play-btn {
      opacity: 1;
    }
    .banner-content {
      flex: 1;
      padding: 15px;
    }
    .banner-content h1 {
      margin: 0 0 10px;
      font-size: 24px;
    }
    .banner-content p {
      margin: 5px 0;
      font-size: 14px;
    }
    .banner-content .btn-watch {
      background: #de1212;
      border: none;
      padding: 10px 20px;
      color: #fff;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      transition: background .2s;
    }
    .banner-content .btn-watch:hover {
      background: #b00d0d;
    }
    .story {
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
      color: #bdbdbd;
    }
    .episodes h3 {
      font-size: 18px;
      margin: 10px 0;
    }
    .episode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .episode-grid button {
      background: #444;
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      transition: background .2s;
      text-align: center;
    }
    .episode-grid button:hover {
      background: #555;
    }
    .small-note {
      font-size: 13px;
      color: #bdbdbd;
      margin-top: 6px;
      text-align: center;
    }
    @media (max-width: 1023px) {
      .banner .poster img {
        height: 200px;
      }
      .banner .poster {
        flex: 0 0 200px;
      }
      .Search.active input {
        width: 120px;
      }
    }
    @media (max-width: 480px) {
      .banner {
        flex-direction: column;
      }
      .banner .poster {
        flex: 0 0 auto;
        width: 100%;
      }
      .banner .poster img {
        height: 150px;
        border-radius: 10px 10px 0 0;
      }
      .banner-content h1 {
        font-size: 18px;
      }
      .banner-content p {
        font-size: 13px;
      }
      .episode-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      .Search.active input {
        width: 100px;
      }
    }
    @media (max-width: 360px) {
      .banner .poster img {
        height: 120px;
      }
      .episode-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="Logo" onclick="location.href='index.html'">üé¨ B√°nh M√¨ üé¨</div>
    <div class="Top">
      <div class="MenuBtn" id="menuBtn">‚ò∞
        <div class="MenuDropdown">
          <!-- Menu dropdown c√≥ th·ªÉ th√™m n·ªôi dung t·ª´ index.html n·∫øu c·∫ßn -->
        </div>
      </div>
      <div class="Search" id="searchBox">
        <input id="searchInput" placeholder="Nh·∫≠p t√™n phim..." />
        <button id="searchBtn">T√¨m</button>
      </div>
    </div>
  </header>
  <main>
    <div class="breadcrumbs" id="breadcrumbs"></div>
    <div class="banner" id="banner"></div>
    <div class="story" id="story"></div>
    <div class="episodes" id="episodes">
      <h3>Danh s√°ch t·∫≠p</h3>
      <div id="episodeList"></div>
    </div>
  </main>
<script>
  // Config sources v√† labels t·ª´ index.html
  const sources = [
    { name: "üçû B√°nh M√¨ 01", base: "https://ophim1.com/v1/api", type: "ophim" },
    { name: "üçû B√°nh M√¨ 02", base: "https://phimapi.com/v1/api", type: "phimapi" },
    { name: "üçû B√°nh M√¨ 03", base: "https://phim.nguonc.com/api", type: "nguonc" }
  ];

  const labels = {
    "hanh-dong": "H√†nh ƒê·ªông", "phieu-luu": "Phi√™u L∆∞u", "hoat-hinh": "Ho·∫°t H√¨nh", "hai": "H√†i",
    "hinh-su": "H√¨nh S·ª±", "tai-lieu": "T√†i Li·ªáu", "chinh-kich": "Ch√≠nh K·ªãch", "gia-dinh": "Gia ƒê√¨nh",
    "gia-tuong": "Gi·∫£ T∆∞·ªüng", "lich-su": "L·ªãch S·ª≠", "kinh-di": "Kinh D·ªã", "nhac": "Nh·∫°c",
    "bi-an": "B√≠ ·∫®n", "lang-man": "L√£ng M·∫°n", "khoa-hoc-vien-tuong": "Khoa H·ªçc Vi·ªÖn T∆∞·ªüng",
    "gay-can": "G√¢y C·∫•n", "chien-tranh": "Chi·∫øn Tranh", "tam-ly": "T√¢m L√Ω", "tinh-cam": "T√¨nh C·∫£m",
    "co-trang": "C·ªï Trang", "mien-tay": "Mi·ªÅn T√¢y", "phim-18": "Phim 18+",
    "au-my": "√Çu M·ªπ", "anh": "Anh", "trung-quoc": "Trung Qu·ªëc", "indonesia": "Indonesia",
    "viet-nam": "Vi·ªát Nam", "phap": "Ph√°p", "hong-kong": "H·ªìng K√¥ng", "han-quoc": "H√†n Qu·ªëc",
    "nhat-ban": "Nh·∫≠t B·∫£n", "thai-lan": "Th√°i Lan", "dai-loan": "ƒê√†i Loan", "nga": "Nga",
    "ha-lan": "H√† Lan", "philippines": "Philippines", "an-do": "·∫§n ƒê·ªô", "quoc-gia-khac": "Qu·ªëc gia kh√°c",
    "duc": "ƒê·ª©c", "tay-ban-nha": "T√¢y Ban Nha", "tho-nhi-ky": "Th·ªï Nhƒ© K·ª≥", "mexico": "Mexico",
    "ba-lan": "Ba Lan", "uc": "√öc", "thu·ªµ-den": "Th·ª•y ƒêi·ªÉn", "malaysia": "Malaysia",
    "brazil": "Brazil", "bo-dao-nha": "B·ªì ƒê√†o Nha", "y": "√ù", "dan-mach": "ƒêan M·∫°ch",
    "uae": "UAE", "na-uy": "Na Uy", "thu·ªµ-si": "Th·ª•y Sƒ©", "chau-phi": "Ch√¢u Phi",
    "nam-phi": "Nam Phi", "ukraina": "Ukraina", "a-rap-xe-ut": "·∫¢ R·∫≠p X√™ √öt", "bi": "B·ªâ",
    "ireland": "Ireland", "colombia": "Colombia", "phan-lan": "Ph·∫ßn Lan", "chile": "Chile",
    "hy-lap": "Hy L·∫°p", "nigeria": "Nigeria", "argentina": "Argentina", "singapore": "Singapore",
    "phim-moi": "Phim m·ªõi", "phim-bo": "Phim b·ªô", "phim-le": "Phim l·∫ª", "shows": "TV Shows",
    "hoat-hinh": "Ho·∫°t h√¨nh", "phim-vietsub": "Phim vietsub", "phim-thuyet-minh": "Phim thuy·∫øt minh",
    "phim-long-tieng": "Phim l·ªìng ti·∫øng", "phim-bo-dang-chieu": "Phim b·ªô ƒëang chi·∫øu",
    "phim-bo-da-hoan-thanh": "Phim b·ªô ƒë√£ ho√†n th√†nh", "phim-sap-chieu": "Phim s·∫Øp chi·∫øu",
    "subteam": "Subteam", "phim-chieu-rap": "Phim chi·∫øu r·∫°p"
  };

  // Reverse labels ƒë·ªÉ map name v·ªÅ slug
  const reverseLabels = {};
  for (const key in labels) {
    reverseLabels[labels[key]] = key;
  }

  // DOM refs
  const banner = document.getElementById("banner");
  const story = document.getElementById("story");
  const breadcrumbs = document.getElementById("breadcrumbs");
  const episodeList = document.getElementById("episodeList");
  const searchBox = document.getElementById("searchBox");
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const menuBtn = document.getElementById("menuBtn");

  // Query params t·ª´ index.html
  const params = new URLSearchParams(location.search);
  const slug = params.get("slug");
  const source = params.get("src") ? decodeURIComponent(params.get("src")) : null;
  const srcConf = sources.find(s => s.name === source);
  const category = params.get("category") || "";
  const region = params.get("region") || "";
  const year = params.get("year") || "";
  const type = params.get("type") || "";
  const search = params.get("search") || "";

  // Helpers
  function slugify(text) {
    if (!text) return "";
    return text.toString().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/ƒë/g, "d").replace(/ƒê/g, "D")
      .replace(/[^a-z0-9\s-]/g, "")
      .trim().replace(/\s+/g, "-");
  }

  function fixImagePath(img, src) {
    if (!img) return "";
    if (img.startsWith("http")) return img;
    if (src.type === "ophim") return `https://img.ophim.live/uploads/movies${img.startsWith("/") ? img : "/" + img}`;
    if (src.type === "phimapi") return `https://phimimg.com${img.startsWith("/") ? img : "/" + img}`;
    if (src.type === "nguonc") return img;
    return img.startsWith("/") ? img : "/" + img;
  }

  async function tryUrls(urls) {
    for (const u of urls) {
      try {
        const res = await fetch(u, { method: "GET" });
        if (!res.ok) {
          console.warn(`Request failed for ${u}: ${res.status}`);
          continue;
        }
        const json = await res.json();
        console.log(`API response from ${u}:`, json);
        if (json.data?.item || json.movie || json.data) {
          return { url: u, data: json };
        }
      } catch (e) {
        console.error(`Fetch error for ${u}:`, e);
      }
    }
    console.warn("No valid response from any URL");
    return null;
  }

  async function fetchEpisodes(slug, srcConf) {
    let epUrl;
    if (srcConf.type === "nguonc") epUrl = `${srcConf.base}/film/${slug}/episodes?sort=name`;
    else epUrl = `${srcConf.base}/phim/${slug}/episodes`;
    try {
      const res = await fetch(epUrl);
      if (!res.ok) return [];
      const data = await res.json();
      return data.episodes || data.data?.episodes || data.items || [];
    } catch (e) {
      console.error("Episodes fetch error:", e);
      return [];
    }
  }

  // Fetch movie detail
  async function loadDetail() {
    if (!slug || !source || !srcConf) {
      banner.innerHTML = "<p class='small-note'>Kh√¥ng t√¨m th·∫•y phim.</p>";
      return;
    }

    let url;
    if (srcConf.type === "nguonc") url = `${srcConf.base}/film/${slug}`;
    else url = `${srcConf.base}/phim/${slug}`;

    try {
      const res = await tryUrls([url]);
      if (!res) throw new Error("No valid response");
      const data = res.data;
      const item = data.data?.item || data.movie || data.data;

      if (!item) {
        banner.innerHTML = "<p class='small-note'>Kh√¥ng t√¨m th·∫•y phim.</p>";
        return;
      }

      // Extract categories, countries, year
      let categories = "?";
      let countries = "?";
      let yearVal = item.year || "?";
      let catList = [];
      let countryList = [];
      if (Array.isArray(item.category)) {
        categories = item.category.map(c => c.name || c).join(", ");
        catList = item.category.map(c => c.name || c);
      } else if (item.category && item.category.list) {
        categories = item.category.list.map(c => c.name).join(", ");
        catList = item.category.list.map(c => c.name);
      } else if (typeof item.category === 'object') {
        for (const key in item.category) {
          const group = item.category[key].group.name;
          const list = item.category[key].list.map(c => c.name);
          const listStr = list.join(", ");
          if (group === "Th·ªÉ lo·∫°i") {
            categories = listStr;
            catList = list;
          }
          if (group === "Qu·ªëc gia") {
            countries = listStr;
            countryList = list;
          }
          if (group === "NƒÉm") {
            yearVal = listStr;
          }
        }
      }

      if (countries === "?") {
        if (Array.isArray(item.country)) {
          countries = item.country.map(c => c.name || c).join(", ");
          countryList = item.country.map(c => c.name || c);
        } else if (item.country && item.country.list) {
          countries = item.country.list.map(c => c.name).join(", ");
          countryList = item.country.list.map(c => c.name);
        }
      }

      const actors = Array.isArray(item.actor) ? item.actor.filter(a => a).join(", ") : item.actors || item.casts || "?";
      const director = Array.isArray(item.director) ? item.director.filter(d => d).join(", ") : item.director || "?";

      // X·ª≠ l√Ω episodes v·ªõi c·∫•u tr√∫c ƒëa d·∫°ng
      let episodes = [];
      if (Array.isArray(item.episodes)) {
        episodes = item.episodes;
      } else if (Array.isArray(item.episode)) {
        episodes = item.episode;
      } else if (item.data && Array.isArray(item.data.episodes)) {
        episodes = item.data.episodes;
      } else if (item.server_data && Array.isArray(item.server_data)) {
        episodes = item.server_data;
      } else if (item.episodes && typeof item.episodes === 'object') {
        episodes = Object.values(item.episodes).filter(arr => Array.isArray(arr));
      }

      if (episodes.length === 0) {
        episodes = await fetchEpisodes(slug, srcConf);
      }

      // L·∫•y firstLink t·ª´ episodes, l·ªçc theo ngu·ªìn
      let firstEpisode = null;
      let firstLink = '';
      let isEmbed = false;
      for (const server of episodes) {
        const serverData = Array.isArray(server.items) ? server.items :
                          Array.isArray(server.server_data) ? server.server_data :
                          Array.isArray(server.episodes) ? server.episodes : [];
        if (serverData.length > 0) {
          firstEpisode = serverData[0];
          const m3u8 = firstEpisode.link_m3u8 || firstEpisode.link || firstEpisode.m3u8 || "";
          const embed = firstEpisode.embed || firstEpisode.link_embed || "";
          if (srcConf.type === 'nguonc') {
            firstLink = embed;
            isEmbed = true;
          } else {
            firstLink = m3u8;
            isEmbed = false;
          }
          if (firstLink) break;
        }
      }

      // Banner
      const poster = fixImagePath(item.poster_url || item.thumb_url || item.image, srcConf);
      banner.innerHTML = `
        <div class="poster">
          <img loading="lazy" src="${poster}" alt="${item.name || ''}">
          ${firstLink ? `<div class="play-btn" onclick="location.href='watch.html?slug=${encodeURIComponent(slug)}&src=${encodeURIComponent(source)}&ep=${encodeURIComponent(firstLink)}&isEmbed=${isEmbed}&name=${encodeURIComponent(item.name || item.title || '')}${category ? '&category=' + encodeURIComponent(category) : ''}${region ? '&region=' + encodeURIComponent(region) : ''}${year ? '&year=' + encodeURIComponent(year) : ''}${type ? '&type=' + encodeURIComponent(type) : ''}${search ? '&search=' + encodeURIComponent(search) : ''}'">‚ñ∂</div>` : ""}
        </div>
        <div class="banner-content">
          <h1>${item.name || item.title || ''}</h1>
          <p><b>NƒÉm:</b> ${yearVal}</p>
          <p><b>ƒê·∫°o di·ªÖn:</b> ${director}</p>
          <p><b>Di·ªÖn vi√™n:</b> ${actors}</p>
          <p><b>Th·ªÉ lo·∫°i:</b> ${categories}</p>
          <p><b>Qu·ªëc gia:</b> ${countries}</p>
          <p><b>Th·ªùi l∆∞·ª£ng:</b> ${item.time || "?"}</p>
          <p><b>Ch·∫•t l∆∞·ª£ng:</b> ${item.quality || "?"}</p>
          <p><b>Ng√¥n ng·ªØ:</b> ${item.language || "?"}</p>
          ${firstLink ? `<button class="btn-watch" onclick="location.href='watch.html?slug=${encodeURIComponent(slug)}&src=${encodeURIComponent(source)}&ep=${encodeURIComponent(firstLink)}&isEmbed=${isEmbed}&name=${encodeURIComponent(item.name || item.title || '')}${category ? '&category=' + encodeURIComponent(category) : ''}${region ? '&region=' + encodeURIComponent(region) : ''}${year ? '&year=' + encodeURIComponent(year) : ''}${type ? '&type=' + encodeURIComponent(type) : ''}${search ? '&search=' + encodeURIComponent(search) : ''}'">‚ñ∂ Xem ngay</button>` : ""}
        </div>
      `;
      if (!firstLink) {
        banner.innerHTML += `<p class='small-note'>Phim hi·ªán ch∆∞a c√≥ link xem. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
      }

      // Story
      story.textContent = item.content ? item.content.replace(/<[^>]+>/g, "") : item.description ? item.description.replace(/<[^>]+>/g, "") : "Kh√¥ng c√≥ m√¥ t·∫£.";

      // Breadcrumbs
      const firstCat = catList[0] || "";
      const firstCountry = countryList[0] || "";
      const catSlug = category || reverseLabels[firstCat] || slugify(firstCat);
      const countrySlug = region || reverseLabels[firstCountry] || slugify(firstCountry);
      breadcrumbs.innerHTML = `
        <a href="index.html">Trang ch·ªß</a> > 
        ${catSlug ? `<a href="index.html?category=${catSlug}">${labels[catSlug] || firstCat || catSlug}</a> > ` : ""}
        ${countrySlug ? `<a href="index.html?region=${countrySlug}">${labels[countrySlug] || firstCountry || countrySlug}</a> > ` : ""}
        ${yearVal !== "?" ? `<a href="index.html?year=${yearVal}">${yearVal}</a> > ` : ""}
        ${item.name || item.title || ""}
      `;

      // Episodes
      episodeList.innerHTML = "";
      if (episodes.length === 0) {
        episodeList.innerHTML = "<p class='small-note'>Phim hi·ªán ch∆∞a c√≥ t·∫≠p n√†o. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
        return;
      }

      // T·∫°o c√°c grid ri√™ng cho t·ª´ng lo·∫°i ng√¥n ng·ªØ
      const vsDiv = document.createElement("div");
      vsDiv.innerHTML = '<h3>Vietsub</h3><div class="episode-grid"></div>';
      const vsGrid = vsDiv.querySelector(".episode-grid");

      const tmDiv = document.createElement("div");
      tmDiv.innerHTML = '<h3>Thuy·∫øt Minh</h3><div class="episode-grid"></div>';
      const tmGrid = tmDiv.querySelector(".episode-grid");

      const ltDiv = document.createElement("div");
      ltDiv.innerHTML = '<h3>L·ªìng Ti·∫øng</h3><div class="episode-grid"></div>';
      const ltGrid = ltDiv.querySelector(".episode-grid");

      episodes.forEach((server, serverIdx) => {
        let serverName = server.server_name || server.name || `Server ${serverIdx + 1}`;
        let languageType = 'vs';
        if (serverName.toLowerCase().includes('thuy·∫øt minh') || serverName.toLowerCase().includes('tm') || item.language?.toLowerCase().includes('thuy·∫øt minh')) {
          languageType = 'tm';
        } else if (serverName.toLowerCase().includes('l·ªìng ti·∫øng') || serverName.toLowerCase().includes('lt') || item.language?.toLowerCase().includes('l·ªìng ti·∫øng')) {
          languageType = 'lt';
        } else if (serverName.toLowerCase().includes('vietsub') || item.language?.toLowerCase().includes('vietsub')) {
          languageType = 'vs';
        }

        const serverData = Array.isArray(server.items) ? server.items :
                          Array.isArray(server.server_data) ? server.server_data :
                          Array.isArray(server.episodes) ? server.episodes : [];
        const grid = languageType === 'tm' ? tmGrid : languageType === 'lt' ? ltGrid : vsGrid;

        serverData.forEach((ep, idx) => {
          const m3u8 = ep.link_m3u8 || ep.link || ep.m3u8 || "";
          const embed = ep.embed || ep.link_embed || "";
          const epName = ep.name || ep.title || `T·∫≠p ${idx + 1}`;
          const queryParams = new URLSearchParams({
            slug: slug,
            src: source,
            name: item.name || item.title || '',
            category: category,
            region: region,
            year: year,
            type: type,
            search: search
          });

          if (srcConf.type !== "nguonc" && m3u8) {
            queryParams.set('ep', m3u8);
            queryParams.set('isEmbed', false);
            const btn = document.createElement("button");
            btn.textContent = `T·∫≠p ${epName} (A)`;
            btn.onclick = () => location.href = `watch.html?${queryParams.toString()}`;
            grid.appendChild(btn);
          } else if (srcConf.type === "nguonc" && embed) {
            queryParams.set('ep', embed);
            queryParams.set('isEmbed', true);
            const btn = document.createElement("button");
            btn.textContent = `T·∫≠p ${epName} (B)`;
            btn.onclick = () => location.href = `watch.html?${queryParams.toString()}`;
            grid.appendChild(btn);
          }
        });
      });

      // Th√™m c√°c div v√†o episodeList n·∫øu c√≥ n·ªôi dung
      if (vsGrid.children.length > 0) {
        episodeList.appendChild(vsDiv);
      }
      if (tmGrid.children.length > 0) {
        episodeList.appendChild(tmDiv);
      }
      if (ltGrid.children.length > 0) {
        episodeList.appendChild(ltDiv);
      }
      if (episodeList.children.length === 0) {
        episodeList.innerHTML = "<p class='small-note'>Phim hi·ªán ch∆∞a c√≥ t·∫≠p n√†o. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
      }

    } catch (err) {
      console.error("Detail fetch error:", err);
      banner.innerHTML = "<p class='small-note'>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</p>";
      episodeList.innerHTML = "<p class='small-note'>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</p>";
    }
  }

  // Search handler
  searchBtn.addEventListener("click", () => {
    const q = searchInput.value.trim();
    if (!q) {
      searchBox.classList.toggle("active");
      searchInput.focus();
      return;
    }
    location.href = `index.html?search=${encodeURIComponent(q)}`;
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") searchBtn.click();
  });

  // Menu toggle
  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    menuBtn.classList.toggle("active");
  });

  document.addEventListener("click", () => {
    menuBtn.classList.remove("active");
  });

  // Quick filter handler
  function quickFilter(value, type = "category") {
    menuBtn.classList.remove("active");
    const query = new URLSearchParams({ [type]: value }).toString();
    location.href = `index.html?${query}`;
  }

  // Load on DOM content loaded
  window.addEventListener("DOMContentLoaded", () => {
    loadDetail();
  });
</script>
</body>
</html>