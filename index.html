<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem Phim - Trang Chủ</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        /* Giữ nguyên CSS từ mã trước */
        body {
            margin: 0;
            padding: 10px;
            background: #05071a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e4e4e4;
        }
        h1 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #543a7e;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h2 {
            font-size: 1.3em;
            color: #b8b8b8;
            margin: 15px 0 10px;
            text-align: center;
            background: linear-gradient(90deg, #543a7e, #0b3a44);
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 10px 15px;
            font-size: 1em;
            border: 2px solid #543a7e;
            border-radius: 25px;
            background-color: #191b24;
            color: #e4e4e4;
            outline: none;
            transition: border-color 0.3s ease;
        }
        .search-input:focus {
            border-color: #0b3a44;
        }
        .category-menu {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .category-link {
            color: #e4e4e4;
            text-decoration: none;
            font-size: 1.1em;
            padding: 12px 20px;
            border: 2px solid #543a7e;
            border-radius: 25px;
            background-color: transparent;
            transition: all 0.3s ease;
            flex: 1 1 45%;
            max-width: 300px;
            text-align: center;
        }
        .category-link:hover {
            background-color: #543a7e;
            color: #fff;
            transform: scale(1.05);
        }
        .category-link:active {
            transform: scale(0.98);
        }
        .movie-section {
            margin-bottom: 15px;
        }
        .movie-container {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            overflow-x: auto;
            padding-bottom: 15px;
        }
        .scrolling-container {
            animation: scrollPosters 90s linear infinite;
            width: max-content;
        }
        @keyframes scrollPosters {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .movie-card {
            flex: 0 0 140px;
            max-width: 140px;
            text-decoration: none;
            color: inherit;
            transition: transform 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .movie-poster {
            width: 100%;
            height: 200px;
            border: 2px solid #543a7e;
            border-radius: 8px;
            object-fit: cover;
            background: #191b24;
            transition: opacity 0.3s ease-in;
            opacity: 0;
        }
        .movie-poster.loaded {
            opacity: 1;
        }
        .movie-title {
            padding: 5px 0;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            color: #e4e4e4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .source-label {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 5px;
            font-size: 0.7em;
            color: #fff;
            border-radius: 3px;
        }
        .source-api { background: #191b24; }
        .source-creator { background: #543a7e; }
        .movie-card:hover {
            transform: scale(1.05);
        }
        @media (max-width: 720px) {
            .category-link {
                font-size: 1em;
                padding: 10px 15px;
            }
            .movie-card {
                flex: 0 0 130px;
                max-width: 130px;
            }
            .movie-poster {
                height: 180px;
            }
            .search-input {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1 id="pageHeader">Bánh mì là số 1</h1>
    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Tìm kiếm phim...">
    </div>
    <div class="category-menu">
        <a href="index.html" class="category-link">Trang Chủ</a>
        <a href="phim-my.html" class="category-link">Phim Mỹ</a>
        <a href="phim-viet.html" class="category-link">Phim Việt</a>
        <a href="phim-han.html" class="category-link">Phim Hàn</a>
        <a href="truyen-hinh.html" class="category-link">Truyền Hình</a>
        <a href="anime.html" class="category-link">Hoạt Hình</a>
    </div>

    <div class="movie-section">
        <h2>Xưởng Vip</h2>
        <div class="movie-container" id="VipContainer"></div>
    </div>

    <div class="movie-section">
        <h2 id="apiSectionTitle">Trung Quốc</h2>
        <div class="movie-container scrolling-container" id="apiContainer"></div>
    </div>

    <div class="movie-section">
        <h2>Xưởng Bánh Mì</h2>
        <div class="movie-container" id="banhMiContainer"></div>
    </div>

    <div class="movie-section">
        <h2>Danh Sách Phim</h2>
        <div class="movie-container" id="danhSachContainer"></div>
    </div>

    <script>
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        const pageTitles = {
            'index.html': 'Bánh mì là số 1',
            'phim-my.html': 'Phim Mỹ - Bánh mì là số 1',
            'phim-viet.html': 'Phim Việt - Bánh mì là số 1',
            'phim-han.html': 'Phim Hàn - Bánh mì là số 1',
            'truyen-hinh.html': 'Truyền Hình - Bánh mì là số 1',
            'anime.html': 'Hoạt Hình - Bánh mì là số 1',
            'tv.html': 'TV - Bánh mì là số 1'
        };
        const apiSectionTitles = {
            'index.html': 'Trung Quốc',
            'phim-my.html': 'Phim Mỹ',
            'phim-viet.html': 'Phim Việt',
            'phim-han.html': 'Phim Hàn',
            'truyen-hinh.html': 'Truyền Hình',
            'anime.html': 'Hoạt Hình',
            'tv.html': 'TV'
        };

        document.getElementById('pageHeader').textContent = pageTitles[currentPage] || 'Bánh mì là số 1';
        document.getElementById('apiSectionTitle').textContent = apiSectionTitles[currentPage] || 'Trung Quốc';

        let allMovies = {};

        // Hàm phân loại phim từ API dựa trên tiêu đề
        function categorizeMovie(title) {
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('hàn') || lowerTitle.includes('korea') || lowerTitle.includes('hàn quốc')) {
                return 'phim-han.html';
            } else if (lowerTitle.includes('mỹ') || lowerTitle.includes('us') || lowerTitle.includes('america')) {
                return 'phim-my.html';
            } else if (lowerTitle.includes('việt') || lowerTitle.includes('vn') || lowerTitle.includes('việt nam')) {
                return 'phim-viet.html';
            } else if (lowerTitle.includes('anime') || lowerTitle.includes('hoạt hình') || lowerTitle.includes('japan')) {
                return 'anime.html';
            } else if (lowerTitle.includes('truyền hình') || lowerTitle.includes('tv')) {
                return 'truyen-hinh.html';
            } else {
                return 'index.html'; // Mặc định là Trung Quốc hoặc Trang Chủ
            }
        }

        fetch('apiUrls.json')
            .then(response => response.json())
            .then(data => {
                const apiUrls = data.urls || [];
                const fetchAPIs = apiUrls.map(url => 
                    fetch(url)
                        .then(response => response.json())
                        .catch(err => {
                            console.error(`Lỗi khi gọi API ${url}:`, err);
                            return null;
                        })
                );

                const seriesTxtUrl = 'https://raw.githubusercontent.com/ngocnguyenmd/ngocnguyenmd/main/series.txt';
                const sourceLabels = { api: 'Vip', creator: 'HD+' };

                const fetchTxt = fetch(seriesTxtUrl)
                    .then(response => response.text())
                    .catch(err => {
                        console.error('Lỗi khi tải series.txt:', err);
                        return '';
                    });

                Promise.all([...fetchAPIs, fetchTxt])
                    .then(results => {
                        const vipContainer = document.getElementById('VipContainer');
                        const apiContainer = document.getElementById('apiContainer');
                        const banhMiContainer = document.getElementById('banhMiContainer');
                        const danhSachContainer = document.getElementById('danhSachContainer');
                        allMovies = {};

                        // Xử lý dữ liệu từ API
                        results.slice(0, -1).forEach((data, index) => {
                            if (!data || !data.status || !data.movie) return;
                            const movie = data.movie;
                            const title = movie.name;
                            const poster = movie.poster_url;
                            const seriesId = movie.slug;
                            const episodes = data.episodes[0].server_data.map(ep => ({
                                title: `Tập ${ep.name}`,
                                url: ep.link_m3u8
                            }));

                            const targetPage = categorizeMovie(title); // Phân loại phim
                            const container = index % 2 === 0 ? 'api' : 'danh-sach';

                            allMovies[seriesId] = { title, poster, episodes, targetPage, source: 'api', container };
                        });

                        // Xử lý dữ liệu từ series.txt
                        const txtData = results[results.length - 1];
                        if (txtData) {
                            const lines = txtData.split('\n');
                            let currentTargetPage = null;
                            let currentContainer = null;
                            lines.forEach(line => {
                                if (line.trim()) {
                                    if (line.startsWith('#')) {
                                        const match = line.match(/# .+ \(([^,]+)(?:,\s*([^)]+))?\)/);
                                        if (match) {
                                            currentTargetPage = match[1].toLowerCase() + '.html'; 
                                            currentContainer = match[2] ? match[2].toLowerCase() : 'trung-quoc';
                                        }
                                    } else if (currentTargetPage) {
                                        const [title, episodeTitle, url] = line.split('|');
                                        const seriesId = title.toLowerCase().replace(/\s+/g, '-');
                                        if (!allMovies[seriesId]) {
                                            allMovies[seriesId] = { 
                                                title, 
                                                targetPage: currentTargetPage, 
                                                container: currentContainer, 
                                                poster: '', 
                                                episodes: [], 
                                                source: 'creator' 
                                            };
                                        }
                                        if (!episodeTitle && url) {
                                            allMovies[seriesId].poster = url;
                                        } else if (url) {
                                            allMovies[seriesId].episodes.push({ title: episodeTitle, url });
                                        }
                                    }
                                }
                            });
                        }

                        function displayMovies(filter = '') {
                            vipContainer.innerHTML = '';
                            apiContainer.innerHTML = '';
                            banhMiContainer.innerHTML = '';
                            danhSachContainer.innerHTML = '';

                            Object.keys(allMovies).forEach(seriesId => {
                                const { title, poster, targetPage, episodes, source, container } = allMovies[seriesId];
                                const shouldDisplay = (
                                    (source === 'api' && targetPage === currentPage) || // Phim từ API khớp trang hiện tại
                                    (source === 'creator' && (
                                        (currentPage === 'index.html' && targetPage === 'all') ||
                                        targetPage === currentPage ||
                                        (currentPage === 'truyen-hinh.html' && targetPage === 'tv.html') ||
                                        (currentPage === 'tv.html' && targetPage === 'truyen-hinh.html')
                                    ))
                                );
                                const matchesSearch = title.toLowerCase().includes(filter.toLowerCase());

                                if (shouldDisplay && matchesSearch) {
                                    const card = document.createElement('a');
                                    card.href = `series.html?id=${seriesId}`;
                                    card.className = 'movie-card';
                                    card.innerHTML = `
                                        <img data-src="${poster}" class="movie-poster lazyload" alt="${title}" loading="lazy">
                                        <div class="movie-title">${title}</div>
                                        <span class="source-label source-${source}">${sourceLabels[source]}</span>
                                    `;
                                    if (container === 'vip') {
                                        vipContainer.appendChild(card);
                                    } else if (container === 'danh-sach') {
                                        danhSachContainer.appendChild(card);
                                    } else if (source === 'api') {
                                        apiContainer.appendChild(card);
                                    } else {
                                        banhMiContainer.appendChild(card);
                                    }
                                }
                            });

                            const apiCards = apiContainer.innerHTML;
                            apiContainer.innerHTML = apiCards + apiCards;

                            const lazyloadImages = document.querySelectorAll('img.lazyload');
                            const imageObserver = new IntersectionObserver((entries, observer) => {
                                entries.forEach(entry => {
                                    if (entry.isIntersecting) {
                                        const img = entry.target;
                                        img.src = img.dataset.src;
                                        img.classList.add('loaded');
                                        observer.unobserve(img);
                                    }
                                });
                            }, { rootMargin: '100px' });
                            lazyloadImages.forEach(img => imageObserver.observe(img));
                        }

                        displayMovies();

                        const searchInput = document.getElementById('searchInput');
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.trim();
                            displayMovies(searchTerm);
                        });

                        Object.keys(allMovies).forEach(seriesId => {
                            localStorage.setItem(seriesId, JSON.stringify(allMovies[seriesId]));
                        });
                    })
                    .catch(console.error);
            })
            .catch(console.error);
    </script>
</body>
</html>