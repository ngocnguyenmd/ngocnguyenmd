<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xem Phim - Series</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    /* Style cơ bản */
    body {
      margin: 0;
      padding: 20px;
      background: #050403;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      transition: all 0.3s ease;
    }
    h1 {
      font-size: 2em;
      color: #af762f;
      margin-bottom: 20px;
      text-align: center;
      position: relative;
    }
    .source-label {
      font-size: 0.8em;
      padding: 2px 5px;
      color: #fff;
      border-radius: 3px;
      margin-left: 10px;
    }
    .source-api {
      background: #af762f;
    }
    .source-creator {
      background: green;
    }
    .video-container {
      position: relative;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .plyr {
      border-radius: 8px;
      overflow: hidden;
    }
    /* Ẩn container phụ đề mặc định của Plyr */
    .plyr__captions {
      display: none !important;
    }
    .control-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .control-btn {
      background: #af762f;
      color: black;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .control-btn:hover {
      background: #000;
      color: #fff;
    }
    .episode-list {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .episode-btn {
      background: #000;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .episode-btn:hover,
    .episode-btn.active {
      background: #af762f;
      color: black;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #af762f;
      text-decoration: none;
      font-size: 1.1em;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .next-prompt {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2b2727;
      padding: 15px 25px;
      border-radius: 5px;
      display: none;
      z-index: 10;
      text-align: center;
    }
    .next-prompt button {
      background: #af762f;
      color: white;
      border: none;
      padding: 8px 15px;
      margin: 5px;
      cursor: pointer;
    }
    .next-prompt button:hover {
      background: #000;
      color: yellow;
    }
    .speed-display {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
      color: #f5cf8e;
      z-index: 1000;
    }
    .subtitle-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .subtitle-controls input[type="file"] {
      display: none;
    }
    .subtitle-controls label,
    .check-sub-btn,
    .apply-sub-btn,
    .bilingual-btn {
      background: #af762f;
      color: black;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      border: none;
    }
    .subtitle-controls label:hover,
    .check-sub-btn:hover,
    .apply-sub-btn:hover,
    .bilingual-btn:hover {
      background: #000;
      color: #fff;
    }
    .apply-sub-btn.applied {
      background: #000;
      color: #fff;
    }
    /* Container phụ đề custom */
    #customCaptions {
      position: absolute;
      bottom: 30%;
      width: 100%;
      text-align: center;
      /* Bỏ thuộc tính color mặc định để từng dòng có thể set riêng */
      text-shadow: 2px 2px 4px black;
      font-size: 1.2em;
      pointer-events: none;
      line-height: 1.4em;
      z-index: 2000;
    }
    /* Khi video full screen, áp dụng cho phần tử nằm trong .video-container */
    .video-container:-webkit-full-screen #customCaptions,
    .video-container:-moz-full-screen #customCaptions,
    .video-container:fullscreen #customCaptions {
      position: fixed; /* Chuyển sang fixed để đảm bảo vị trí hiển thị đúng */
      bottom: 0px;    /* Điều chỉnh khoảng cách từ dưới lên sao cho không bị che */
      left: 0;
      width: 100%;
      font-size: 1.4em; /* Có thể tăng kích thước chữ nếu cần */
      z-index: 9999;    /* Đưa lên trên cùng */
    }
    /* Định dạng riêng cho từng dòng phụ đề */
    .caption-line.top {
      color: #fff; /* Dòng trên màu trắng */
    }
    .caption-line.bottom {
      color: yellow; /* Dòng dưới màu vàng */
    }
    @media (max-width: 600px) {
      .video-container {
        padding: 10px;
      }
      .control-btn, .episode-btn {
        padding: 8px 12px;
        font-size: 0.9em;
      }
      .next-prompt {
        padding: 10px 15px;
        font-size: 0.9em;
      }
      .speed-display {
        font-size: 0.8em;
        padding: 3px 8px;
      }
      .subtitle-controls label,
      .check-sub-btn,
      .apply-sub-btn,
      .bilingual-btn {
        padding: 6px 10px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="seriesTitle">Loading...</h1>
    <div class="video-container">
      <video id="player" playsinline controls>
        <!-- Thay URL video theo nhu cầu của bạn -->
        <source src="your_video_url.m3u8" type="application/x-mpegURL" />
      </video>
      <!-- Container custom để hiển thị phụ đề song ngữ -->
      <div id="customCaptions"></div>
      <div class="control-buttons">
        <button class="control-btn" onclick="rewind()">⏪︎</button>
        <button class="control-btn" onclick="playNextEpisode(false)">⏮︎</button>
        <button class="control-btn" onclick="playNextEpisode(true)">⏭</button>
        <button class="control-btn" onclick="fastForward()">⏩︎</button>
      </div>
      <div class="subtitle-controls">
        <label for="subtitle1">Tải phụ đề 1</label>
        <input type="file" id="subtitle1" accept=".srt,.vtt" onchange="loadSubtitle(1)" />
        <label for="subtitle2">Tải phụ đề 2</label>
        <input type="file" id="subtitle2" accept=".srt,.vtt" onchange="loadSubtitle(2)" />
        <button class="check-sub-btn" onclick="checkSubtitles()">Kiểm tra phụ đề</button>
        <button class="apply-sub-btn" id="applyButton" onclick="toggleSubtitles()">Áp dụng phụ đề</button>
        <button class="bilingual-btn" id="toggleBilingual" onclick="toggleBilingual()">Bật song ngữ</button>
      </div>
      <div id="episodeList" class="episode-list"></div>
      <div id="nextPrompt" class="next-prompt">
        <span>Chuyển sang tập tiếp theo?</span><br />
        <button onclick="playNextEpisode(true)">Có</button>
        <button onclick="hidePrompt()">Không</button>
      </div>
    </div>
    <div class="speed-display" id="speedDisplay">Tốc độ: 0 KB/s</div>
    <a href="index.html" class="back-link">Ra xưởng bánh mì</a>
  </div>

  <!-- Thư viện Plyr và HLS.js -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('player');
    let hls;
    let currentEpisodeIndex = 0;
    let episodes = [];
    const speedDisplay = document.getElementById('speedDisplay');
    // Lưu nội dung phụ đề dạng data URI sau khi chuyển sang VTT
    let subtitleContents = { 1: null, 2: null };
    let subtitlesApplied = false;
    let bilingualMode = false;

    // Hàm đo tốc độ mạng (thêm cache busting)
    function measureNetworkSpeed(tsUrl) {
      const xhr = new XMLHttpRequest();
      const startTime = performance.now();
      const tsUrlWithNoCache = tsUrl + '?nocache=' + Date.now();
      xhr.open('GET', tsUrlWithNoCache, true);
      xhr.responseType = 'blob';
      xhr.onload = () => {
        if (xhr.status === 200) {
          const endTime = performance.now();
          const duration = (endTime - startTime) / 1000;
          const bytesLoaded = xhr.response.size;
          const speedKBps = (bytesLoaded / duration / 1024).toFixed(2);
          speedDisplay.textContent = `Tốc độ: ${speedKBps} KB/s`;
        } else {
          speedDisplay.textContent = "Lỗi tải file .ts";
        }
      };
      xhr.onerror = () => {
        speedDisplay.textContent = "Lỗi mạng hoặc CORS";
      };
      xhr.send();
      setTimeout(() => measureNetworkSpeed(tsUrl), 5000);
    }

    // Hàm khởi tạo player
    function initializePlayer(source) {
      // Xóa hết các track cũ
      while (video.getElementsByTagName('track').length > 0) {
        video.removeChild(video.getElementsByTagName('track')[0]);
      }
      document.getElementById('customCaptions').innerHTML = "";
      if (Hls.isSupported()) {
        if (hls) hls.destroy();
        hls = new Hls({
          startFragPrefetch: true,
          maxBufferLength: 5,
          maxMaxBufferLength: 10,
          liveSyncDuration: 3,
          liveMaxLatencyDuration: 10,
          capLevelToPlayerSize: true,
          maxFragLookUpTolerance: 0.1,
          abrEwmaFastLive: 2.0,
          abrEwmaSlowLive: 6.0,
          abrEwmaFastVoD: 2.0,
          abrEwmaSlowVoD: 6.0,
          abrBandWidthFactor: 0.9,
          abrBandWidthUpFactor: 0.6,
          startLevel: -1,
          debug: false
        });
        hls.loadSource(source);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          if (subtitlesApplied) applySubtitles();
          console.log('HLS manifest parsed, video ready');
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          console.log('HLS error:', data);
          if (data.fatal) {
            hls.destroy();
            setTimeout(() => initializePlayer(source), 1000);
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = source;
        video.addEventListener('loadedmetadata', () => {
          if (subtitlesApplied) applySubtitles();
          updateCustomCaptions();
        }, { once: true });
      }
    }

    // Khởi tạo Plyr (ẩn captions native)
    const player = new Plyr(video, {
      controls: ['play-large', 'play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'captions', 'fullscreen'],
      speed: { selected: 1, options: [0.5, 1, 1.5, 2] },
      captions: { active: false, update: true }
    });

    function rewind() {
      video.currentTime = Math.max(0, video.currentTime - 10);
    }
    function fastForward() {
      video.currentTime = Math.min(video.duration, video.currentTime + 10);
    }

    video.addEventListener('loadedmetadata', () => {
      console.log('Video duration:', video.duration);
    });

    video.addEventListener('timeupdate', () => {
      if (!video.duration || isNaN(video.duration)) return;
      const remaining = video.duration - video.currentTime;
      const prompt = document.getElementById('nextPrompt');
      if (remaining <= 60 && remaining > 0 && episodes.length > currentEpisodeIndex + 1) {
        video.pause();
        prompt.style.display = 'block';
        console.log('Video paused, showing prompt at last 60s of episode:', currentEpisodeIndex);
      }
      updateCustomCaptions();
    });

    function playNextEpisode(isNext) {
      const newIndex = isNext ? currentEpisodeIndex + 1 : currentEpisodeIndex - 1;
      if (newIndex >= 0 && newIndex < episodes.length) {
        currentEpisodeIndex = newIndex;
        initializePlayer(episodes[newIndex].url);
        updateActiveButton();
        document.getElementById('nextPrompt').style.display = 'none';
        console.log('Switching to next episode:', currentEpisodeIndex);
      }
    }

    function updateActiveButton() {
      document.querySelectorAll('.episode-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', idx === currentEpisodeIndex);
      });
    }

    function hidePrompt() {
      const prompt = document.getElementById('nextPrompt');
      if (prompt) {
        prompt.style.display = 'none';
        console.log('Prompt hidden after clicking No');
      }
      video.play().catch(err => console.error('Error resuming video:', err));
    }

    // Toggle áp dụng phụ đề
    function toggleSubtitles() {
      if (subtitlesApplied) {
        removeSubtitles();
        document.getElementById('applyButton').classList.remove('applied');
        document.getElementById('applyButton').textContent = 'Áp dụng phụ đề';
      } else {
        applySubtitles();
        document.getElementById('applyButton').classList.add('applied');
        document.getElementById('applyButton').textContent = 'Tắt phụ đề';
      }
      subtitlesApplied = !subtitlesApplied;
      updateCustomCaptions();
    }

    // Tạo thẻ track cho 2 phụ đề và ép mode về "hidden"
    function applySubtitles() {
      if (subtitleContents[1]) {
        const track1 = document.createElement('track');
        track1.kind = 'captions';
        track1.label = 'Phụ đề 1';
        track1.srclang = 'vi';
        track1.src = subtitleContents[1];
        track1.default = true;
        video.appendChild(track1);
      }
      if (subtitleContents[2]) {
        const track2 = document.createElement('track');
        track2.kind = 'captions';
        track2.label = 'Phụ đề 2';
        track2.srclang = 'vi';
        track2.src = subtitleContents[2];
        track2.default = false;
        video.appendChild(track2);
      }
      // Ép tất cả các textTracks về mode "hidden"
      setTimeout(() => {
        for (let i = 0; i < video.textTracks.length; i++) {
          video.textTracks[i].mode = 'hidden';
          console.log(`Track ${i} (${video.textTracks[i].label}): mode = ${video.textTracks[i].mode}`);
        }
      }, 500);
    }

    function removeSubtitles() {
      while (video.getElementsByTagName('track').length > 0) {
        video.removeChild(video.getElementsByTagName('track')[0]);
      }
      document.getElementById('customCaptions').innerHTML = "";
    }

    // Xử lý file phụ đề tải lên, chuyển SRT sang VTT
    function loadSubtitle(number) {
      const input = document.getElementById(`subtitle${number}`);
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const subtitleText = e.target.result;
        const vttText = convertSrtToVtt(subtitleText);
        subtitleContents[number] = 'data:text/vtt;base64,' + encodeBase64(vttText);
        console.log(`Subtitle ${number}: Loaded and ready`);
      };
      reader.readAsText(file);
    }

    // Mã hóa Base64 an toàn cho Unicode
    function encodeBase64(str) {
      let bytes = new TextEncoder().encode(str);
      let binary = Array.from(bytes).map(b => String.fromCharCode(b)).join('');
      return btoa(binary);
    }

    function convertSrtToVtt(srt) {
      const vtt = "WEBVTT\n\n" + srt
        .replace(/\{\\([ibu])\}/g, '</$1>')
        .replace(/\{\\([ibu])1\}/g, '<$1>')
        .replace(/(\d+:\d+:\d+),(\d+)/g, '$1.$2');
      return vtt;
    }

    function checkSubtitles() {
      console.log('Checking subtitle status:');
      for (const key in subtitleContents) {
        console.log(`Subtitle ${key}:`, subtitleContents[key] ? 'Loaded and ready' : 'Not loaded');
      }
      for (let i = 0; i < video.textTracks.length; i++) {
        console.log(`Track ${i} (${video.textTracks[i].label}): mode = ${video.textTracks[i].mode}`);
      }
    }

    // Cập nhật nội dung hiển thị trong container custom dựa vào activeCues của từng track
    function updateCustomCaptions() {
      const captionContainer = document.getElementById('customCaptions');
      if (!subtitlesApplied) {
        captionContainer.innerHTML = "";
        return;
      }
      let track1, track2;
      for (let i = 0; i < video.textTracks.length; i++) {
        if (video.textTracks[i].label === 'Phụ đề 1') {
          track1 = video.textTracks[i];
        } else if (video.textTracks[i].label === 'Phụ đề 2') {
          track2 = video.textTracks[i];
        }
      }
      let text1 = "";
      if (track1 && track1.activeCues && track1.activeCues.length > 0) {
        text1 = track1.activeCues[0].text;
      }
      let text2 = "";
      if (bilingualMode && track2 && track2.activeCues && track2.activeCues.length > 0) {
        text2 = track2.activeCues[0].text;
      }
      if (bilingualMode) {
        captionContainer.innerHTML = `<div class="caption-line top">${text1}</div><div class="caption-line bottom">${text2}</div>`;
      } else {
        captionContainer.innerHTML = `<div class="caption-line top">${text1}</div>`;
      }
    }

    // Hàm chuyển đổi trạng thái song ngữ
    function toggleBilingual() {
      bilingualMode = !bilingualMode;
      const btn = document.getElementById('toggleBilingual');
      btn.textContent = bilingualMode ? 'Tắt song ngữ' : 'Bật song ngữ';
      updateCustomCaptions();
    }

    // Sự kiện full screen: sử dụng JavaScript để thêm lớp .fs-active cho #customCaptions
    function handleFullScreenChange() {
      const captionContainer = document.getElementById('customCaptions');
      if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
        captionContainer.classList.add('fs-active');
      } else {
        captionContainer.classList.remove('fs-active');
      }
    }
    document.addEventListener('fullscreenchange', handleFullScreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
    document.addEventListener('mozfullscreenchange', handleFullScreenChange);

    // Giả lập lấy dữ liệu series từ localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const seriesId = urlParams.get('id');
    const seriesData = JSON.parse(localStorage.getItem(seriesId)) || { title: 'Không tìm thấy', episodes: [], source: '' };

    document.getElementById('seriesTitle').innerHTML = `${seriesData.title} <span class="source-label source-${seriesData.source}">${seriesData.source === 'api' ? '🎧' : '🎧'}</span>`;
    episodes = seriesData.episodes;

    const episodeList = document.getElementById('episodeList');
    episodes.forEach((episode, index) => {
      const btn = document.createElement('button');
      btn.className = 'episode-btn';
      btn.textContent = episode.title;
      btn.onclick = () => {
        currentEpisodeIndex = index;
        initializePlayer(episode.url);
        document.getElementById('nextPrompt').style.display = 'none';
        updateActiveButton();
      };
      episodeList.appendChild(btn);
    });

    if (episodes.length > 0) {
      initializePlayer(episodes[0].url);
      episodeList.children[0].classList.add('active');
    }

    // URL file .ts để đo tốc độ (ví dụ)
    const tsUrl = 'https://vip.opstream15.com/20250225/49776_0eca5fa0/3000k/hls/31d96b8d5a75522515cd08b129713af1.ts';
    measureNetworkSpeed(tsUrl);
  </script>
</body>
</html>
