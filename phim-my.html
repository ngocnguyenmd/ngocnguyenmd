<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xem Phim - Trang Chủ</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        body {
            margin: 0;
            padding: 5px;
            background: #05071a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e4e4e4;
            overflow-x: hidden;
        }
        h1 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #543a7e;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h2 {
            font-size: 1.1em;
            color: #b8b8b8;
            margin: 10px 0 5px;
            text-align: center;
            background: linear-gradient(90deg, #543a7e, #0b3a44);
            padding: 6px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        .category-menu {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .category-link {
            color: #e4e4e4;
            text-decoration: none;
            font-size: 0.9em;
            padding: 8px 12px;
            border: 2px solid #543a7e;
            border-radius: 20px;
            background-color: transparent;
            transition: all 0.3s ease;
            flex: 1 1 30%;
            max-width: 200px;
            text-align: center;
        }
        .category-link:hover {
            background-color: #543a7e;
            color: #fff;
            transform: scale(1.05);
        }
        .category-link:active {
            transform: scale(0.98);
        }
        .movie-section {
            margin-bottom: 10px;
        }
        .movie-container {
            display: flex;
            flex-wrap: wrap; /* Chuyển sang wrap để xuống hàng */
            gap: 20px; /* Khoảng cách vừa phải */
            justify-content: center;
            max-width: 720px; /* Tối đa bằng chiều rộng màn hình A04 */
            margin: 0 auto;
        }
        .movie-card {
            flex: 0 0 200px; /* Tăng từ 100px lên 200px */
            max-width: 200px;
            text-decoration: none;
            color: inherit;
            transition: transform 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .movie-poster {
            width: 100%;
            height: 300px; /* Tăng từ 150px lên 300px */
            border: 2px solid #543a7e;
            border-radius: 8px;
            object-fit: cover;
            background: #191b24;
            transition: opacity 0.3s ease-in;
            opacity: 0;
        }
        .movie-poster.loaded {
            opacity: 1;
        }
        .movie-title {
            padding: 5px 0; /* Tăng từ 3px lên 5px */
            font-size: 1em; /* Tăng từ 0.8em lên 1em */
            font-weight: bold;
            text-align: center;
            color: #e4e4e4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .source-label {
            position: absolute;
            top: 5px; /* Tăng từ 3px lên 5px */
            right: 5px;
            padding: 3px 6px; /* Tăng từ 2px 4px lên 3px 6px */
            font-size: 0.7em; /* Tăng từ 0.6em lên 0.7em */
            color: #fff;
            border-radius: 3px;
        }
        .source-api { background: #191b24; }
        .source-creator { background: #543a7e; }
        .movie-card:hover {
            transform: scale(1.05);
        }
        @media (max-width: 720px) {
            .category-link {
                font-size: 0.8em;
                padding: 6px 10px;
            }
            .movie-card {
                flex: 0 0 180px; /* Tăng từ 90px lên 180px */
                max-width: 180px;
            }
            .movie-poster {
                height: 270px; /* Tăng từ 135px lên 270px */
            }
            .movie-container {
                max-width: 720px; /* Giữ nguyên để vừa màn hình */
            }
        }
    </style>
</head>
<body>
    <h1 id="pageHeader">Bánh mì là số 1</h1>
    <div class="category-menu">
        <a href="index.html" class="category-link">Trang Chủ</a>
        <a href="phim-my.html" class="category-link">Phim Mỹ</a>
        <a href="phim-viet.html" class="category-link">Phim Việt</a>
        <a href="phim-han.html" class="category-link">Phim Hàn</a>
        <a href="truyen-hinh.html" class="category-link">Truyền Hình</a>
        <a href="anime.html" class="category-link">Hoạt Hình</a>
    </div>
    <div class="movie-section">
        <h2>Xưởng Bánh Mì</h2>
        <div class="movie-container" id="creatorContainer"></div>
    </div>
    <div class="movie-section">
        <h2 id="apiSectionTitle"></h2>
        <div class="movie-container" id="apiContainer"></div>
    </div>

    <script>
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        console.log('Current Page:', currentPage);

        const pageTitles = {
            'index.html': 'Bánh mì là số 1',
            'phim-my.html': 'Phim Mỹ - Bánh mì là số 1',
            'phim-viet.html': 'Phim Việt - Bánh mì là số 1',
            'phim-han.html': 'Phim Hàn - Bánh mì là số 1',
            'truyen-hinh.html': 'Truyền Hình - Bánh mì là số 1',
            'anime.html': 'Hoạt Hình - Bánh mì là số 1'
        };
        const apiSectionTitles = {
            'index.html': 'Trung Quốc',
            'phim-my.html': 'US-UK',
            'phim-viet.html': 'Việt Nam',
            'phim-han.html': 'Hàn Quốc',
            'truyen-hinh.html': 'TV-Online',
            'anime.html': 'Hoạt Hình'
        };

        document.getElementById('pageHeader').textContent = pageTitles[currentPage] || 'Bánh mì là số 1';
        document.getElementById('apiSectionTitle').textContent = apiSectionTitles[currentPage] || 'Trung Quốc';

        const apiSource = currentPage === 'anime.html' ? 'apiAnime.json' :
                         currentPage === 'phim-han.html' ? 'apiHan.json' :
                         currentPage === 'truyen-hinh.html' ? 'tv.json' :
                         currentPage === 'phim-my.html' ? 'apiUsa.json' :
                         currentPage === 'phim-viet.html' ? 'apiVn.json' : 'apiUrls.json';
        const seriesTxtUrl = 'https://raw.githubusercontent.com/ngocnguyenmd/ngocnguyenmd/main/series.txt';
        const sourceLabels = { api: 'Vip', creator: 'HD+' };

        let allMovies = {};

        fetch(apiSource)
            .then(response => response.json())
            .then(data => {
                const apiUrls = data.urls || [];
                const fetchAPIs = apiUrls.map(url => 
                    fetch(url)
                        .then(response => response.json())
                        .catch(err => {
                            console.error(`Lỗi khi gọi API ${url}:`, err);
                            return null;
                        })
                );

                const fetchTxt = fetch(seriesTxtUrl)
                    .then(response => response.text())
                    .catch(err => {
                        console.error('Lỗi khi tải series.txt:', err);
                        return '';
                    });

                Promise.all([...fetchAPIs, fetchTxt])
                    .then(results => {
                        const creatorContainer = document.getElementById('creatorContainer');
                        const apiContainer = document.getElementById('apiContainer');
                        allMovies = {};

                        // Xử lý dữ liệu từ API
                        results.slice(0, -1).forEach(data => {
                            if (!data || !data.status || !data.movie) return;
                            const movie = data.movie;
                            const title = movie.name;
                            const poster = movie.poster_url;
                            const seriesId = movie.slug;
                            const episodes = data.episodes[0].server_data.map(ep => ({
                                title: `Tập ${ep.name}`,
                                url: ep.link_m3u8
                            }));

                            allMovies[seriesId] = { title, poster, episodes, targetPage: currentPage, source: 'api' };
                        });

                        // Xử lý dữ liệu từ series.txt
                        const txtData = results[results.length - 1];
                        if (txtData) {
                            const lines = txtData.split('\n');
                            let currentTargetPage = null;
                            lines.forEach(line => {
                                if (line.trim()) {
                                    if (line.startsWith('#')) {
                                        const match = line.match(/# .+ \(([^,]+)(?:,\s*([^)]+))?\)/);
                                        if (match) {
                                            currentTargetPage = match[1].toLowerCase() + '.html';
                                            console.log('Target Page from series.txt:', currentTargetPage);
                                        }
                                    } else if (currentTargetPage) {
                                        const [title, episodeTitle, url] = line.split('|');
                                        const seriesId = title.toLowerCase().replace(/\s+/g, '-');
                                        if (!allMovies[seriesId]) {
                                            allMovies[seriesId] = { 
                                                title, 
                                                targetPage: currentTargetPage, 
                                                poster: '', 
                                                episodes: [], 
                                                source: 'creator' 
                                            };
                                        }
                                        if (!episodeTitle && url) {
                                            allMovies[seriesId].poster = url;
                                        } else if (url) {
                                            allMovies[seriesId].episodes.push({ title: episodeTitle, url });
                                        }
                                    }
                                }
                            });
                        }

                        // Hiển thị phim
                        Object.keys(allMovies).forEach(seriesId => {
                            const { title, poster, targetPage, episodes, source } = allMovies[seriesId];
                            const shouldDisplay = source === 'api' || targetPage === currentPage;
                            console.log(`Series: ${title}, Target Page: ${targetPage}, Source: ${source}, Should Display: ${shouldDisplay}`);
                            if (shouldDisplay) {
                                const card = document.createElement('a');
                                card.href = `series.html?id=${seriesId}`;
                                card.className = 'movie-card';
                                card.innerHTML = `
                                    <img data-src="${poster}" class="movie-poster lazyload" alt="${title}" loading="lazy">
                                    <div class="movie-title">${title}</div>
                                    <span class="source-label source-${source}">${sourceLabels[source]}</span>
                                `;
                                if (source === 'creator') {
                                    creatorContainer.appendChild(card);
                                } else if (source === 'api') {
                                    apiContainer.appendChild(card);
                                }

                                localStorage.setItem(seriesId, JSON.stringify({
                                    title,
                                    poster,
                                    episodes,
                                    source,
                                    targetPage
                                }));
                            }
                        });

                        // Lazy loading cho ảnh
                        const lazyloadImages = document.querySelectorAll('img.lazyload');
                        const imageObserver = new IntersectionObserver((entries, observer) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    const img = entry.target;
                                    img.src = img.dataset.src;
                                    img.classList.add('loaded');
                                    observer.unobserve(img);
                                }
                            });
                        }, { rootMargin: '100px' });
                        lazyloadImages.forEach(img => imageObserver.observe(img));
                    })
                    .catch(error => console.error('Lỗi khi tải dữ liệu từ Promise.all:', error));
            })
            .catch(error => console.error(`Lỗi khi tải ${apiSource}:`, error));
    </script>
</body>
</html>