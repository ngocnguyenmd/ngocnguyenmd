<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Xem Phim Vui V·∫ª</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",Roboto,sans-serif;overflow-x:hidden;line-height:1.5;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;}
a{text-decoration:none;color:inherit;}
.nav-wrapper{position:sticky;top:0;z-index:50;background:#111;backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.08);}
.container{max-width:1300px;margin:0 auto;padding:0 1.5rem;}
.nav{display:flex;align-items:center;justify-content:space-between;height:68px;}
.logo{font-size:1.2rem;font-weight:700;color:#fff;letter-spacing:-.5px;}
.nav-search{display:flex;align-items:center;gap:10px;flex:1;max-width:300px;margin-left:6rem;}
.nav-search-input{width:100%;padding:8px 4px;border-radius:20px;border:1px solid rgba(255,255,255,.15);background:#111;color:#fff;font-size:.9rem;transition:all .25s ease;}
.nav-search-input:focus{border-color:#0a84ff;outline:none;background:#181818;}
.nav-search-btn{background:#0a84ff;border:none;color:#fff;padding:8px 16px;border-radius:18px;font-size:.9rem;cursor:pointer;transition:background .25s;}
.nav-search-btn:hover{background:#006edc;}
.nav-menu-wrapper{flex:1;text-align:center;}
.nav-menu{display:inline-flex;list-style:none;gap:1.4rem;}
.nav-menu a{color:#bbb;font-weight:500;font-size:.95rem;transition:color .25s;}
.nav-menu a:hover{color:#fff;}
.hamburger-menu{display:none;flex-direction:column;gap:4px;cursor:pointer;}
.hamburger{width:22px;height:2px;background:#fff;}
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);z-index:999;justify-content:center;align-items:center;opacity:0;transition:opacity .2s ease;}
.modal-backdrop.show{display:flex;opacity:1;}
.modal-box{background:#111;border:1px solid rgba(255,255,255,.1);border-radius:12px;width:90%;max-width:800px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;transform:scale(.95);transition:transform .2s ease;}
.modal-backdrop.show .modal-box{transform:scale(1);}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.2rem;border-bottom:1px solid rgba(255,255,255,.08);}
.modal-title{font-size:1.1rem;font-weight:600;}
.modal-close{cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.08);transition:background .2s;}
.modal-close:hover{background:rgba(255,255,255,.15);}
.modal-close svg{width:16px;height:16px;fill:#fff;}
.modal-body{flex:1;overflow-y:auto;padding:1rem 0;}
.modal-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:0;}
.modal-item{padding:.75rem 1.2rem;color:#ddd;font-size:.95rem;cursor:pointer;transition:background .2s;border-bottom:1px solid rgba(255,255,255,.05);border-right:1px solid rgba(255,255,255,.05);}
.modal-item:nth-child(5n){border-right:none;}
.modal-item:hover{background:rgba(255,255,255,.08);}
.modal-item.active{color:#0a84ff;font-weight:600;}
.section{padding:2.5rem 0;position:relative;}
.section-header{font-size:1.4rem;font-weight:700;margin-bottom:1.2rem;text-transform:uppercase;color:#fff;}
.movie-grid{display:grid;grid-template-columns:repeat(5,minmax(180px,1fr));gap:1.3rem;}
.movie-item{position:relative;border-radius:14px;overflow:hidden;background:#111;cursor:pointer;transition:transform .25s,box-shadow .25s;}
.movie-item img{width:100%;height:340px;object-fit:cover;display:block;transition:opacity .3s ease;opacity:0;}
.movie-item img.loaded{opacity:1;}
.movie-item:hover{transform:scale(1.04);box-shadow:0 12px 25px rgba(0,0,0,.5);}
.movie-item-content{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.9) 20%,rgba(0,0,0,.05) 80%);opacity:0;padding:1rem;display:flex;flex-direction:column;justify-content:flex-end;transition:opacity .3s;}
.movie-item:hover .movie-item-content{opacity:1;}
.movie-item-title{font-weight:600;font-size:1rem;margin-bottom:.3rem;color:#fff;}
.movie-infos{display:flex;flex-wrap:wrap;gap:6px 10px;font-size:.8rem;color:#bbb;}
.movie-infos span{color:#ccc;}
.movie-source-tag{position:absolute;top:8px;right:8px;background:#292929;color:#a1a1a1;font-size:.75rem;padding:2px 6px;border-radius:6px;pointer-events:none;}
.pagination{display:flex;justify-content:center;margin-top:1rem;gap:6px;}
.page-btn{background:#111;color:#fff;border:1px solid #222;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .25s;}
.page-btn.active{background:#0a84ff;border-color:#0a84ff;}
.page-btn:hover:not(.active){background:#222;}
footer{background:#000;border-top:1px solid rgba(255,255,255,.08);color:#999;font-size:.9rem;text-align:center;padding:2rem 0;}
.progress-container{position:absolute;top:0;left:0;right:0;height:3px;background:rgba(255,255,255,.1);overflow:hidden;z-index:10;opacity:1;transition:opacity .3s ease;}
.progress-container.done{opacity:0;}
.progress-bar{height:100%;background:#0a84ff;width:0%;transition:width .3s ease;}
@media (max-width:1200px){.movie-grid{grid-template-columns:repeat(2,minmax(180px,1fr));}}
@media (max-width:992px){.nav-menu-wrapper{display:none;}.hamburger-menu{display:flex;}.nav-search{max-width:none;flex:1;margin-left:1rem;}.movie-item img{height:260px;}}
@media (max-width:600px){.container{padding:0 1rem;}.nav-search{margin-left:.5rem;}.movie-item img{height:290px;}.movie-item-title{font-size:.9rem;}.modal-box{width:95%;max-width:none;max-height:90vh;}.modal-grid{grid-template-columns:1fr;}.modal-item{padding:.5rem .8rem;font-size:.85rem;border-right:none;}}
</style>
</head>
<body>

<div class="nav-wrapper">
  <div class="container">
    <div class="nav">
      <a href="#" class="logo">Phim B√°nh M√¨</a>
      <div class="nav-search">
        <input type="text" class="nav-search-input" id="nav-search-input" placeholder="T√¨m - ho·∫∑c vi·∫øt kh√¥ng d·∫•u">
        <button class="nav-search-btn" id="nav-search-btn">üëìÔ∏è</button>
      </div>
      <div class="nav-menu-wrapper">
        <ul class="nav-menu" id="nav-menu">
          <li><a href="#" id="home-link">Trang ch·ªß</a></li>
          <li><a href="#" class="menu-trigger" data-target="genre">Th·ªÉ Lo·∫°i</a></li>
          <li><a href="#" class="menu-trigger" data-target="country">Qu·ªëc Gia</a></li>
          <li><a href="#" class="menu-trigger" data-target="year">NƒÉm</a></li>
          <li><a href="#" class="menu-trigger" data-target="cutee">Kh√°c</a></li>
          <li><a href="#" id="phim-bo">Phim B·ªô</a></li>
          <li><a href="#" id="phim-le">Phim L·∫ª</a></li>
          <li><a href="#" id="phim-chieu-rap">Cinemax</a></li>
        </ul>
      </div>
      <div class="hamburger-menu" id="hamburger">
        <div class="hamburger"></div><div class="hamburger"></div><div class="hamburger"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Menu</div>
      <div class="modal-close" id="modalClose">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-grid" id="modalBody"></div>
    </div>
  </div>
</div>

<div id="main-content"></div>

<footer>
  <div class="container">
    <p class="footer-heading">Phim Nh√† B√°nh M√¨</p>
    <p>Load ƒë√¥i khi ch·∫≠m ƒë·ª£i 1 - 2 ph√∫t</p>
  </div>
</footer>

<script>
/* ==== VANILLA JS ‚Äì FULL CODE (ABC HI·ªÜN NGAY, KH√îNG ƒêEN, KH√îNG HOVER M·ªöI HI·ªÜN) ==== */

const GENRE_SLUG_MAP = {
  'H√†nh ƒê·ªông': 'hanh-dong','Phi√™u L∆∞u': 'phieu-luu','Ho·∫°t H√¨nh': 'hoat-hinh','H√†i': 'phim-hai','H√†i H∆∞·ªõc': 'hai-huoc','H√¨nh S·ª±': 'hinh-su','T√†i Li·ªáu': 'tai-lieu','Ch√≠nh K·ªãch': 'chinh-kich','Gia ƒê√¨nh': 'gia-dinh','Gi·∫£ T∆∞·ªüng': 'gia-tuong','L·ªãch S·ª≠': 'lich-su','Kinh D·ªã': 'kinh-di','Nh·∫°c': 'am-nhac','√Çm Nh·∫°c': 'am-nhac','B√≠ ·∫®n': 'bi-an','L√£ng M·∫°n': 'lang-man','T√¨nh C·∫£m': 'tinh-cam','Khoa H·ªçc Vi·ªÖn T∆∞·ªüng': 'khoa-hoc-vien-tuong','G√¢y C·∫•n': 'gay-can','Chi·∫øn Tranh': 'chien-tranh','T√¢m L√Ω': 'tam-ly','C·ªï Trang': 'co-trang','Mi·ªÅn T√¢y': 'mien-tay','Phim 18': 'phim-18','Th·ªÉ Thao': 'the-thao','V√µ Thu·∫≠t': 'vo-thuat','Vi·ªÖn T∆∞·ªüng': 'vien-tuong','Khoa H·ªçc': 'khoa-hoc','Th·∫ßn Tho·∫°i': 'than-thoai','H·ªçc ƒê∆∞·ªùng': 'hoc-duong','Kinh ƒêi·ªÉn': 'kinh-dien'
};

const COUNTRY_SLUG_MAP = {
  '√Çu M·ªπ': 'au-my','H√†n Qu·ªëc': 'han-quoc','Trung Qu·ªëc': 'trung-quoc','Nh·∫≠t B·∫£n': 'nhat-ban','Th√°i Lan': 'thai-lan','H·ªìng K√¥ng': 'hong-kong','·∫§n ƒê·ªô': 'an-do','Anh': 'anh','Ph√°p': 'phap','Canada': 'canada','ƒê·ª©c': 'duc','T√¢y Ban Nha': 'tay-ban-nha','√öc': 'uc','√ù': 'y','H√† Lan': 'ha-lan','Indonesia': 'indonesia','Nga': 'nga','Mexico': 'mexico','Ba Lan': 'ba-lan','Malaysia': 'malaysia','B·ªì ƒê√†o Nha': 'bo-dao-nha','Th·ª•y ƒêi·ªÉn': 'thuy-dien','Philippines': 'philippines','ƒêan M·∫°ch': 'dan-mach','Th·ª•y Sƒ©': 'thuy-si','Ukraina': 'ukraina','UAE': 'uae','·∫¢ R·∫≠p X√™ √öt': 'a-rap-xe-ut','Th·ªï Nhƒ© K·ª≥': 'tho-nhi-ky','Brazil': 'brazil','Na Uy': 'na-uy','Nam Phi': 'nam-phi','Vi·ªát Nam': 'viet-nam','ƒê√†i Loan': 'dai-loan','Ch√¢u Phi': 'chau-phi','B·ªâ': 'bi','Ireland': 'ireland','Colombia': 'colombia','Ph·∫ßn Lan': 'phan-lan','Chile': 'chile','Hy L·∫°p': 'hy-lap','Nigeria': 'nigeria','Argentina': 'argentina','Singapore': 'singapore','Qu·ªëc Gia Kh√°c': 'quoc-gia-khac'
};

const TYPE_MAP = {'phim-bo': 'phim-bo','phim-le': 'phim-le','thuyet-minh': 'phim-thuyet-minh','chieu-rap': 'phim-chieu-rap'};
const CUTEE_MENU = {
  'Phim m·ªõi': { mode: 'default' },'Phim b·ªô': { mode: 'type', filter: 'phim-bo' },'Phim l·∫ª': { mode: 'type', filter: 'phim-le' },'Shows': { mode: 'cutee', slug: 'tv-shows' },'Ho·∫°t h√¨nh': { mode: 'cutee', slug: 'hoat-hinh' },'Phim vietsub': { mode: 'cutee', slug: 'vietsub' },'Phim thuy·∫øt minh': { mode: 'cutee', slug: 'thuyet-minh' },'Phim l·ªìng ti·∫øng': { mode: 'cutee', slug: 'long-tieng' },'Phim b·ªô ƒëang chi·∫øu': { mode: 'cutee', slug: 'phim-dang-chieu' },'Phim b·ªô ƒë√£ ho√†n th√†nh': { mode: 'cutee', slug: 'hoan-tat' },'Phim s·∫Øp chi·∫øu': { mode: 'cutee', slug: 'phim-sap-chieu' },'Subteam': { mode: 'cutee', slug: 'subteam' },'Phim chi·∫øu r·∫°p': { mode: 'cutee', slug: 'phim-chieu-rap' }
};

const API_SOURCES={Ophim:{name:'Ophim',code:'ax',defaultUrl:p=>`https://ophim1.com/v1/api/danh-sach/phim-moi-cap-nhat?page=${p}`,genreUrlTheLoai:(s,p)=>`https://ophim1.com/v1/api/the-loai/${s}?page=${p}`,countryUrl:(s,p)=>`https://ophim1.com/v1/api/quoc-gia/${s}?page=${p}`,yearUrl:(y,p)=>`https://ophim1.com/v1/api/nam-phat-hanh/${y}?page=${p}`,typeUrl:(t,p)=>`https://ophim1.com/v1/api/danh-sach/${t}?page=${p}`,cuteeUrl:(s,p)=>`https://ophim1.com/v1/api/danh-sach/${s}?page=${p}`,searchUrl:s=>`https://ophim1.com/v1/api/phim/${s}`,keywordSearchUrl:(k,p=1)=>`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(k)}&page=${p}`,parser:d=>d?.data?.items||[],searchParser:d=>d?.data?.item?[d.data.item]:[],keywordParser:d=>d?.data?.items||[],getCdn:()=>"https://img.ophim.live/uploads/movies/"},Phimapi:{name:'Phimapi',code:'bx',defaultUrl:p=>`https://phimapi.com/danh-sach/phim-moi-cap-nhat-v3?page=${p}`,genreUrlTheLoai:(s,p)=>`https://phimapi.com/v1/api/the-loai/${s}?page=${p}`,countryUrl:(s,p)=>`https://phimapi.com/v1/api/quoc-gia/${s}?page=${p}`,yearUrl:(y,p)=>`https://phimapi.com/v1/api/nam/${y}?page=${p}`,typeUrl:(t,p)=>`https://phimapi.com/v1/api/danh-sach/${t}?page=${p}`,cuteeUrl:(s,p)=>`https://phimapi.com/v1/api/danh-sach/${s}?page=${p}`,searchUrl:s=>`https://phimapi.com/phim/${s}`,keywordSearchUrl:(k,p=1)=>`https://phimapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(k)}&page=${p}`,parser:d=>d?.data?.items||d?.items||[],searchParser:d=>d?.movie?[d.movie]:[],keywordParser:d=>d?.data?.items||[],getCdn:d=>(d?.data?.APP_DOMAIN_CDN_IMAGE||'https://phimimg.com/').replace(/\/+$/,'')+'/'},Nguonc:{name:'Nguonc',code:'cx',defaultUrl:p=>`https://phim.nguonc.com/api/films/phim-moi-cap-nhat?page=${p}`,genreUrlTheLoai:(s,p)=>`https://phim.nguonc.com/api/films/danh-sach/${s}?page=${p}`,countryUrl:(s,p)=>`https://phim.nguonc.com/api/films/quoc-gia/${s}?page=${p}`,yearUrl:(y,p)=>`https://phim.nguonc.com/api/films/nam-phat-hanh/${y}?page=${p}`,typeUrl:(t,p)=>`https://phim.nguonc.com/api/films/danh-sach/${t}?page=${p}`,cuteeUrl:(s,p)=>{const m={'tv-shows':'tv-shows','dang-chieu':'phim-dang-chieu','hoat-hinh':'hoat-hinh'};return`https://phim.nguonc.com/api/films/danh-sach/${m[s]||s}?page=${p}`;},searchUrl:s=>`https://phim.nguonc.com/api/film/${s}`,keywordSearchUrl:(k,p=1)=>`https://phim.nguonc.com/api/films/search?keyword=${encodeURIComponent(k)}&page=${p}`,parser:d=>d?.items||[],searchParser:d=>d?.movie?[d.movie]:[],keywordParser:d=>d?.items||[],getCdn:()=>"https://phim.nguonc.com/public/images/Poster/"}};

let ITEMS_PER_PAGE=5,currentMode='default',currentFilter=null,currentPage=1,currentSearchQuery='';
const CACHE_TTL=6*60*60*1000;
const PLACEHOLDER_LOW = 'abc.jpg'; // ·∫¢NH N·∫∂NG ‚Üí HI·ªÜN ABC NGAY L·∫¨P T·ª®C
const HEAVY_THRESHOLD = 1024 * 1024; // >1MB

function getCacheKey(s,m,f,p,isS=false,isK=false){return isK?`cache|keyword|${s}|${f}|${p||1}`:isS?`cache|search|${s}|${f}`:`cache|${s}|${m}|${f||'default'}|${p||1}`;}
function getCache(k){try{const r=localStorage.getItem(k);if(!r)return null;const c=JSON.parse(r);if(Date.now()-c.timestamp>CACHE_TTL){localStorage.removeItem(k);return null;}return c.data;}catch(e){return null;}}
function setCache(k,d){try{localStorage.setItem(k,JSON.stringify({data:d,timestamp:Date.now()}));}catch(e){}}

function getEpisodeDisplay(i){
  if(!i) return '';
  const m = i.movie || i;
  const e = i.episodes || m.episodes;
  if((!m.episode_current && !m.current_episode) && (!m.episode_total && !m.total_episodes) && !Array.isArray(e)){
    const t = m.type || m.tmdb?.type;
    return t === 'tv' ? 'Phim b·ªô' : 'Phim l·∫ª';
  }
  let c = '', t = '', l = 0;
  const cur = m.episode_current || m.current_episode || '';
  const tot = m.episode_total || m.total_episodes || '';
  const cm = cur.match(/T·∫≠p (\d+)/i) || cur.match(/(\d+)/);
  if(cm) c = cm[1];
  if(tot) t = tot;
  if(Array.isArray(e)) e.forEach(s => {
    const d = s.server_data || s.items || [];
    if(Array.isArray(d)) l += d.length;
  });
  let disp = '';
  if(c && t) disp = `T·∫≠p ${c}/${t}`;
  else if(c) disp = `T·∫≠p ${c}`;
  else if(/full|ho√†n t·∫•t|ho√†n th√†nh/i.test(cur)) disp = 'Ho√†n t·∫•t';
  else disp = 'ƒêang ph√°t';
  if(l > 0) disp += ` (${l} link)`;
  return disp;
}

async function fetchFromSource(src, p, m, f, isS = false, isK = false){
  const ck = getCacheKey(src.name, m, f, p, isS, isK);
  const ca = getCache(ck);
  if(ca) return ca.map(x => ({...x, sourceCode: src.code, sourceName: src.name}));
  let urls = [];
  if(isK) urls.push(src.keywordSearchUrl(f, p));
  else if(isS) urls.push(src.searchUrl(f));
  else if(m === 'genre') urls.push(src.genreUrlTheLoai?.(f, p) || src.defaultUrl(p));
  else if(m === 'cutee' || m === 'type') urls.push(src.cuteeUrl?.(f, p) || src.typeUrl?.(f, p) || src.defaultUrl(p));
  else if(m === 'country') urls.push(src.countryUrl(f, p));
  else if(m === 'year') urls.push(src.yearUrl(f, p));
  else urls.push(src.defaultUrl(p));
  const pr = urls.map(async u => {
    try{
      const r = await fetch(u, {mode: 'cors'});
      if(!r.ok) return null;
      const d = await r.json();
      const pa = isK ? (src.keywordParser || src.parser) : isS ? (src.searchParser || src.parser) : src.parser;
      const it = pa(d) || [];
      if(it.length > 0){
        return {data: d, items: it, cdn: typeof src.getCdn === 'function' ? src.getCdn(d) : src.getCdn()};
      }
    }catch(e){ return null; }
  });
  const res = await Promise.all(pr);
  const val = res.find(x => x !== null);
  if(!val) return [];
  const proc = val.items.map(it => {
    let th = it.poster_url || it.poster || it.thumb_url || it.thumb || '';
    if(src.name === 'Phimapi'){
      th = it.poster_url || it.poster || '';
    }else{
      th = it.thumb_url || it.thumb || it.poster_url || it.poster || '';
    }
    if(th && !th.startsWith('https') && !th.startsWith('//')) th = val.cdn + th.replace(/^\/+/, '');
    const po = it.poster_url || it.poster || th;
    return {
      name: it.name || it.origin_name || it.title || 'Kh√¥ng r√µ',
      thumb_url: th || '',
      poster_url: po || th || '',
      episodeDisplay: getEpisodeDisplay(it),
      slug: it.slug || '',
      sourceCode: src.code,
      sourceName: src.name,
      isSlugSearch: isS
    };
  }).filter(x => x.slug && x.thumb_url);
  setCache(ck, proc);
  return proc;
}

function interleaveSourcesProperly(res, isS = false){
  const sl = [], kw = [];
  res.forEach(a => (a[0]?.isSlugSearch ? sl : kw).push(a));
  const seen = new Set(), fin = [];
  const add = (arrs) => {
    const ns = arrs.length;
    let idx = new Array(ns).fill(0);
    while(fin.length < ITEMS_PER_PAGE){
      let ad = false;
      for(let i = 0; i < ns; i++){
        if(idx[i] < arrs[i].length){
          const m = arrs[i][idx[i]];
          if(!seen.has(m.slug)){
            seen.add(m.slug);
            fin.push(m);
            ad = true;
            idx[i]++;
            if(fin.length >= ITEMS_PER_PAGE) break;
          }else idx[i]++;
        }
      }
      if(!ad) break;
    }
  };
  add(sl); add(kw);
  return fin;
}

function createSection(id, tit){
  const s = document.createElement('div');
  s.className = 'section';
  s.id = id;
  s.innerHTML = `<div class="progress-container" id="${id}-progress-cont"><div class="progress-bar" id="${id}-progress"></div></div><div class="container"><div class="section-header">${tit}</div><div class="movie-grid" id="${id}-grid"></div><div class="pagination" id="${id}-pagination"></div></div>`;
  return s;
}

function showSection(sec){
  document.querySelectorAll('#main-content > .section').forEach(x => x.style.display = 'none');
  const c = document.getElementById('main-content'), ex = document.getElementById(sec.id);
  if(ex){ ex.style.display = 'block'; c.insertBefore(ex, c.firstChild); }
  else{ c.insertBefore(sec, c.firstChild); sec.style.display = 'block'; }
}

function createMovieCard(m, progressId){
  const c = document.createElement('div');
  c.className = 'movie-item';
  c.dataset.slug = m.slug;
  c.dataset.source = m.sourceCode;
  c.onclick = () => location.href = `detail.html?slug=${m.slug}&source=${m.sourceCode}`;
  const tag = document.createElement('div');
  tag.className = 'movie-source-tag';
  tag.textContent = m.sourceCode;
  const img = document.createElement('img');
  img.alt = m.name;
  img.style.opacity = '0';
  img.style.transition = 'opacity .3s ease';
  const cont = document.createElement('div');
  cont.className = 'movie-item-content';
  cont.innerHTML = `<div class="movie-item-title">${m.name}</div><div class="movie-infos"><div class="movie-info">‚òÖ <span>*</span></div><div class="movie-info">‚è± <span>${m.episodeDisplay}</span></div><div class="movie-info">HD</div><div class="movie-info">B√°nh m√¨</div></div>`;
  c.append(tag, img, cont);
  return {card: c, img};
}

let loadedImages = 0, totalImages = 0, currentProgressId = null;
function updateProgress(progressId){
  loadedImages++;
  const percent = (loadedImages / totalImages) * 100;
  const bar = document.getElementById(progressId);
  if(bar) bar.style.width = percent + '%';
  if(loadedImages === totalImages){
    const cont = document.getElementById(progressId + '-cont');
    if(cont) cont.classList.add('done');
  }
}

async function getImageSize(url){
  try{
    const r = await fetch(url, {method: 'HEAD'});
    const s = r.headers.get('content-length');
    return s ? parseInt(s, 10) : Infinity;
  }catch(e){ return Infinity; }
}

async function renderMoviesFinal(movs, cont, progressId){
  cont.innerHTML = '';
  const disp = movs.slice(0, ITEMS_PER_PAGE);
  totalImages = disp.length;
  loadedImages = 0;
  currentProgressId = progressId;
  const cards = disp.map(m => createMovieCard(m, progressId));
  cards.forEach((obj, idx) => { cont.appendChild(obj.card); });
  const withSize = await Promise.all(disp.map(async (m, i) => {
    const size = await getImageSize(m.thumb_url);
    return {idx: i, img: cards[i].img, size, url: m.thumb_url};
  }));
  withSize.sort((a, b) => a.size - b.size);
  let idx = 0;
  const loadNext = () => {
    if(idx >= withSize.length){
      if(loadedImages === totalImages){
        const cont = document.getElementById(progressId + '-cont');
        if(cont) cont.classList.add('done');
      }
      return;
    }
    const item = withSize[idx++];
    // HI·ªÜN ABC NGAY L·∫¨P T·ª®C N·∫æU ·∫¢NH N·∫∂NG
    if(item.size > HEAVY_THRESHOLD){
      item.img.src = PLACEHOLDER_LOW;
      item.img.classList.add('loaded');
      item.img.style.opacity = '1'; // HI·ªÜN NGAY
      updateProgress(progressId);
      const real = new Image();
      real.onload = () => {
        item.img.src = item.url;
        item.img.style.opacity = '1';
        updateProgress(progressId);
      };
      real.onerror = () => { updateProgress(progressId); };
      real.src = item.url;
    }else{
      item.img.src = item.url;
      item.img.onload = () => {
        item.img.classList.add('loaded');
        item.img.style.opacity = '1';
        updateProgress(progressId);
      };
    }
    setTimeout(loadNext, 50);
  };
  loadNext();
}

function renderPagination(p, secId, more){
  const el = document.getElementById(`${secId}-pagination`);
  if(!el) return;
  el.innerHTML = '';
  const prev = document.createElement('button');
  prev.className = 'page-btn';
  prev.textContent = '‚Äπ';
  prev.disabled = p === 1;
  prev.onclick = () => currentSearchQuery ? search(currentSearchQuery, p-1) : loadContent(currentMode, currentFilter, p-1);
  el.appendChild(prev);
  for(let i = Math.max(1, p-3); i <= p+4; i++){
    const b = document.createElement('button');
    b.className = 'page-btn';
    if(i === p) b.classList.add('active');
    b.textContent = i;
    b.onclick = () => currentSearchQuery ? search(currentSearchQuery, i) : loadContent(currentMode, currentFilter, i);
    el.appendChild(b);
  }
  const next = document.createElement('button');
  next.className = 'page-btn';
  next.textContent = '‚Ä∫';
  next.disabled = !more;
  next.onclick = () => currentSearchQuery ? search(currentSearchQuery, p+1) : loadContent(currentMode, currentFilter, p+1);
  el.appendChild(next);
}

function getTitle(m, f){
  if(m === 'default') return 'PHIM M·ªöI PHIM M·ªöI NH√Ä B√ÅNH M√å';
  if(m === 'genre') return `TH·ªÇ LO·∫†I: ${Object.keys(GENRE_SLUG_MAP).find(k => GENRE_SLUG_MAP[k] === f)?.toUpperCase() || f.toUpperCase()}`;
  if(m === 'country') return `QU·ªêC GIA: ${Object.keys(COUNTRY_SLUG_MAP).find(k => COUNTRY_SLUG_MAP[k] === f)?.toUpperCase() || f.toUpperCase()}`;
  if(m === 'year') return `NƒÇM: ${f}`;
  if(m === 'type') return {'phim-bo':'PHIM B·ªò','phim-le':'PHIM L·∫∫'}[f] || f.toUpperCase();
  if(m === 'cutee'){
    const l = Object.keys(CUTEE_MENU).find(k => CUTEE_MENU[k].slug === f || CUTEE_MENU[k].filter === f);
    return l?.toUpperCase() || f.toUpperCase().replace(/-/g, ' ');
  }
  return f?.toUpperCase() || 'PHIM';
}

async function loadContent(m, f = null, p = 1){
  ITEMS_PER_PAGE = 5;
  currentMode = m;
  currentFilter = f;
  currentPage = p;
  if(m === 'default'){
    document.querySelectorAll('#main-content > .section').forEach(x => x.remove());
    loadCustomMenu();
    return;
  }
  const tit = getTitle(m, f), sid = `${m}-${f||''}-section`.replace(/--/g, '-');
  let sec = document.getElementById(sid);
  if(!sec) sec = createSection(sid, tit);
  else{
    sec.querySelector('.section-header').textContent = tit;
    const prog = document.getElementById(`${sid}-progress`);
    if(prog) prog.style.width = '0%';
  }
  showSection(sec);
  const grid = document.getElementById(`${sid}-grid`);
  grid.innerHTML = '';
  const srcs = Object.values(API_SOURCES);
  const prom = srcs.map(s => fetchFromSource(s, p, m, f, false, false));
  const all = await Promise.all(prom);
  const movs = interleaveSourcesProperly(all, false);
  await renderMoviesFinal(movs, grid, `${sid}-progress`);
  renderPagination(p, sid, movs.length >= ITEMS_PER_PAGE);
  sec.scrollIntoView({behavior: 'smooth'});
}

async function search(q = null, p = 1){
  const raw = (q || document.getElementById('nav-search-input').value).trim();
  if(!raw) return loadContent('default');
  currentSearchQuery = raw;
  currentPage = p;
  const sid = 'search-section';
  let sec = document.getElementById(sid);
  if(!sec) sec = createSection(sid, `T√åM: "${raw}"`);
  else{
    sec.querySelector('.section-header').textContent = `T√åM: "${raw}"`;
    const prog = document.getElementById(`${sid}-progress`);
    if(prog) prog.style.width = '0%';
  }
  showSection(sec);
  const grid = document.getElementById(`${sid}-grid`);
  grid.innerHTML = '';
  const srcs = Object.values(API_SOURCES);
  const sp = srcs.map(s => fetchFromSource(s, p, null, raw, true, false));
  const kp = srcs.map(s => fetchFromSource(s, p, null, raw, false, true));
  const [sr, kr] = await Promise.all([Promise.all(sp), Promise.all(kp)]);
  const movs = interleaveSourcesProperly([...sr, ...kr], true);
  await renderMoviesFinal(movs, grid, `${sid}-progress`);
  renderPagination(p, sid, movs.length >= ITEMS_PER_PAGE);
  sec.scrollIntoView({behavior: 'smooth'});
}

async function loadCustomMenu(){
  try{
    const r = await fetch('custom-menu.txt?t=' + Date.now());
    if(!r.ok) return;
    const txt = await r.text();
    if(!txt.trim()) return;
    const g = parseCustomMenuWithGroups(txt);
    for(const [gn, it] of Object.entries(g)){
      if(it.length === 0) continue;
      await loadCustomGroup(gn, it);
    }
  }catch(e){ loadContentFromAPI('default'); }
}

function parseCustomMenuWithGroups(txt){
  const lines = txt.split('\n'), gr = {};
  let cur = null;
  lines.forEach(l => {
    l = l.trim();
    if(!l) return;
    if(l.startsWith('#')){
      cur = l.substring(1).trim().toUpperCase();
      if(!gr[cur]) gr[cur] = [];
      return;
    }
    if(!cur) return;
    const p = l.split('|');
    if(p.length < 2) return;
    const [st, sk, dt] = p.map(x => x.trim());
    const sl = st.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-').replace(/^-+|-+$/g, '');
    gr[cur].push({slug: sl, source: sk.toLowerCase(), display: dt || st});
  });
  return gr;
}

async function loadCustomGroup(gn, it){
  const sid = `custom-group-${gn.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
  let sec = document.getElementById(sid);
  if(!sec) sec = createSection(sid, gn);
  const cont = document.getElementById('main-content');
  if(!document.getElementById(sid)) cont.appendChild(sec);
  sec.style.display = 'block';
  const grid = document.getElementById(`${sid}-grid`);
  grid.innerHTML = '';
  const all = [];
  for(const i of it){
    const src = Object.values(API_SOURCES).find(s => s.name.toLowerCase() === i.source);
    if(!src) continue;
    const res = await fetchFromSource(src, null, null, i.slug, true, false);
    all.push(...res);
  }
  const seen = new Set(), fin = all.filter(m => !seen.has(m.slug) && seen.add(m.slug));
  await renderMoviesFinal(fin, grid, `${sid}-progress`);
  const pag = document.getElementById(`${sid}-pagination`);
  if(pag) pag.style.display = 'none';
}

async function loadContentFromAPI(m, f = null, p = 1){
  const sid = 'fallback-section';
  let sec = document.getElementById(sid);
  if(!sec) sec = createSection(sid, 'PHIM M·ªöI C·∫¨P NH·∫¨T');
  showSection(sec);
  const grid = document.getElementById(`${sid}-grid`);
  grid.innerHTML = '';
  const srcs = Object.values(API_SOURCES);
  const prom = srcs.map(s => fetchFromSource(s, p, m, f));
  const all = await Promise.all(prom);
  const movs = interleaveSourcesProperly(all);
  await renderMoviesFinal(movs, grid, `${sid}-progress`);
  renderPagination(p, sid, movs.length >= ITEMS_PER_PAGE);
}

const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');
const hamburger = document.getElementById('hamburger');

function openModal(tit, items, cb){
  modalTitle.textContent = tit;
  modalBody.innerHTML = '';
  document.querySelectorAll('.modal-item.active').forEach(x => x.classList.remove('active'));
  items.forEach(it => {
    const d = document.createElement('div');
    d.className = 'modal-item';
    d.textContent = it;
    d.onclick = () => {
      document.querySelectorAll('.modal-item.active').forEach(x => x.classList.remove('active'));
      d.classList.add('active');
      cb(it);
    };
    modalBody.appendChild(d);
  });
  modalBackdrop.classList.add('show');
  setTimeout(() => { modalBackdrop.scrollTop = 0; }, 150);
}

function closeModal(){ modalBackdrop.classList.remove('show'); }

modalClose.onclick = closeModal;
modalBackdrop.onclick = e => { if(e.target === modalBackdrop) closeModal(); };

document.addEventListener('DOMContentLoaded', () => {
  hamburger.onclick = () => openModal('DANH M·ª§C CH√çNH', ['Th·ªÉ Lo·∫°i','Qu·ªëc Gia','NƒÉm','Kh√°c','Phim B·ªô','Phim L·∫ª','Cinemax'], v => {
    if(v === 'Th·ªÉ Lo·∫°i') openModal('TH·ªÇ LO·∫†I', Object.keys(GENRE_SLUG_MAP), x => loadContent('genre', GENRE_SLUG_MAP[x], 1));
    if(v === 'Qu·ªëc Gia') openModal('QU·ªêC GIA', Object.keys(COUNTRY_SLUG_MAP), x => loadContent('country', COUNTRY_SLUG_MAP[x], 1));
    if(v === 'NƒÉm') openModal('NƒÇM', Array.from({length: 25}, (_, i) => 2025 - i), x => loadContent('year', x, 1));
    if(v === 'Kh√°c') openModal('KH√ÅC', Object.keys(CUTEE_MENU), x => { const c = CUTEE_MENU[x]; loadContent(c.mode, c.slug || c.filter, 1); });
    if(v === 'Phim B·ªô') loadContent('type', 'phim-bo', 1);
    if(v === 'Phim L·∫ª') loadContent('type', 'phim-le', 1);
    if(v === 'Cinemax') loadContent('cutee', 'phim-chieu-rap', 1);
  });

  document.querySelectorAll('.menu-trigger').forEach(el => {
    el.onclick = e => {
      e.preventDefault();
      const tar = el.dataset.target;
      if(tar === 'genre') openModal('TH·ªÇ LO·∫†I', Object.keys(GENRE_SLUG_MAP), x => loadContent('genre', GENRE_SLUG_MAP[x], 1));
      if(tar === 'country') openModal('QU·ªêC GIA', Object.keys(COUNTRY_SLUG_MAP), x => loadContent('country', COUNTRY_SLUG_MAP[x], 1));
      if(tar === 'year') openModal('NƒÇM', Array.from({length: 25}, (_, i) => 2025 - i), x => loadContent('year', x, 1));
      if(tar === 'cutee') openModal('KH√ÅC', Object.keys(CUTEE_MENU), x => { const c = CUTEE_MENU[x]; loadContent(c.mode, c.slug || c.filter, 1); });
    };
  });

  document.getElementById('home-link').onclick = e => { e.preventDefault(); loadContent('default'); };
  document.getElementById('phim-bo').onclick = e => { e.preventDefault(); loadContent('type', 'phim-bo', 1); };
  document.getElementById('phim-le').onclick = e => { e.preventDefault(); loadContent('type', 'phim-le', 1); };
  document.getElementById('phim-chieu-rap').onclick = e => { e.preventDefault(); loadContent('cutee', 'phim-chieu-rap', 1); };
  document.getElementById('nav-search-btn').onclick = () => search();
  document.getElementById('nav-search-input').addEventListener('keypress', e => { if(e.key === 'Enter') search(); });
  loadContent('default');
});
</script>
</body>
</html>
