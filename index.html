<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Xem Phim Vui V·∫ª</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
    background:#000;
    color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",Roboto,sans-serif;
    overflow-x:hidden;
    line-height:1.5;
    -webkit-touch-callout:none;
    -webkit-user-select:none;
    user-select:none;
}
a{text-decoration:none;color:inherit;}

/* ===============================
   NAVIGATION
   =============================== */
.nav-wrapper{
    position:sticky;
    top:0;
    z-index:1000;
    background:rgba(17,17,17,0.95);
    backdrop-filter:saturate(180%) blur(20px);
    -webkit-backdrop-filter:saturate(180%) blur(20px);
    border-bottom:1px solid rgba(255,255,255,.08);
    transition:background .3s ease;
}
.nav-wrapper.scrolled{
    background:rgba(0,0,0,0.96);
}
.container{
    max-width:1360px;
    margin:0 auto;
    padding:0 1.5rem;
}
.nav{
    display:flex;
    align-items:center;
    justify-content:space-between;
    height:68px;
}
.logo {
    font-size: 1.35rem;
    font-weight: 800;
    background: linear-gradient(261deg, rgba(255, 255, 255, 0.15), #0a31ff59);
    padding: 2px 6px;
    border-radius: 22px;
    letter-spacing: -1px;
}
.nav-search{
    display:flex;
    align-items:center;
    gap:12px;
    flex:1;
    max-width:360px;
    margin-left:7rem;
}
.nav-search-input{
    width:100%;
    padding:10px 16px;
    border-radius:24px;
    border:1px solid rgba(255,255,255,.18);
    background:#111;
    color:#fff;
    font-size:.95rem;
    transition:all .3s ease;
}
.nav-search-input:focus{
    border-color:#0a31ff;
    background:#1a1a1a;
    outline:none;
    box-shadow:0 0 0 3px #0a31ff(10,132,255,.2);
}
.nav-search-btn {
    background: #0a31ff;
    border: none;
    color: #fff;
    padding: 10px 20px;
    border-radius: 22px;
    font-size: .95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .3s ease;
    white-space: nowrap;
}
.nav-search-btn:hover{background:#0a31ff;}


.nav-menu-wrapper{flex:1;text-align:center;}
.nav-menu{
    display:inline-flex;
    list-style:none;
    gap:1.4rem;
}
.nav-menu a{
    color:#bbb;
    font-weight:500;
    font-size:.95rem;
    transition:color .25s;
}
.nav-menu a:hover{color:#fff;}

.hamburger-menu{
    display:none;
    flex-direction:column;
    gap:5px;
    cursor:pointer;
    padding:10px;
    border-radius:8px;
    transition:background .2s;
}
.hamburger {
    width: 24px;
    height: 3px;
    background: #ffffff;
    border-radius: 1px;
}

/* ===============================
   MODAL
   =============================== */
.modal-backdrop{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.88);
    backdrop-filter:blur(8px);
    z-index:999;
    justify-content:center;
    align-items:center;
    opacity:0;
    transition:opacity .2s ease;
}
.modal-backdrop.show{
    display:flex;
    opacity:1;
}
.modal-box{
    background:#111;
    border:1px solid rgba(255,255,255,.1);
    border-radius:12px;
    width:90%;
    max-width:800px;
    max-height:85vh;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    transform:scale(.95);
    transition:transform .2s ease;
}
.modal-backdrop.show .modal-box{transform:scale(1);}
.modal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:1rem 1.2rem;
    border-bottom:1px solid rgba(255,255,255,.08);
}
.modal-title{
    font-size:1.1rem;
    font-weight:600;
}
.modal-close{
    cursor:pointer;
    width:28px;
    height:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:50%;
    background:rgba(255,255,255,.08);
    transition:background .2s;
}
.modal-close:hover{background:rgba(255,255,255,.15);}
.modal-close svg{
    width:16px;
    height:16px;
    fill:#fff;
}
.modal-body{
    flex:1;
    overflow-y:auto;
    padding:1rem 0;
}
.modal-grid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:0;
}
.modal-item{
    padding:.75rem 1.2rem;
    color:#ddd;
    font-size:.95rem;
    cursor:pointer;
    transition:background .2s;
    border-bottom:1px solid rgba(255,255,255,.05);
    border-right:1px solid rgba(255,255,255,.05);
}
.modal-item:nth-child(5n){border-right:none;}
.modal-item:hover{background:rgba(255,255,255,.08);}
.modal-item.active{
    color:#0a84ff;
    font-weight:600;
}

/* ===============================
   SECTION
   =============================== */
.section{
    padding:2.5rem 0;
    position:relative;
}
.section-header{
    font-size:1.4rem;
    font-weight:700;
    margin-bottom:1.2rem;
    text-transform:uppercase;
    color:#fff;
}

/* ===============================
   MOVIE GRID
   =============================== */
.movie-grid{
    display:grid;
    grid-template-columns:repeat(5,minmax(180px,1fr));
    gap:1.3rem;
}
.movie-item{
    position:relative;
    border-radius:14px;
    overflow:hidden;
    background:#111;
    cursor:pointer;
    display:flex;
    flex-direction:column;
}

/* IMAGE + placeholder */
.movie-img-container{
    position:relative;
    width:100%;
    padding-bottom:150%;
    overflow:hidden;
}
.movie-img-real,
.movie-img-placeholder{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    object-fit:cover;
    transition:opacity .4s ease, transform .3s ease;
}
.movie-img-placeholder{
    z-index:2;
    opacity:1;
}
.movie-img-real{
    opacity:0;
}

/* ===============================
   TAG KI·ªÇU NETFLIX
   =============================== */
.movie-ep-tag {
    position: absolute;
    top: 12px;
    left: 12px;
    background: linear-gradient(135deg, rgba(10, 132, 255, 0.9), rgba(10, 132, 255, 0.7));
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 800;
    color: #ffffff;
    text-transform: uppercase;
    z-index: 3;
    backdrop-filter: blur(4px);
    box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
    letter-spacing: 0.5px;
}

.movie-top-right {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    gap: 8px;
    z-index: 3;
}

.movie-quality-tag, .movie-source-tag {
    background: rgba(0, 0, 0, 0.6);
    padding: 5px 12px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 800;
    color: #ffffff;
    text-transform: uppercase;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    letter-spacing: 0.5px;
}

.movie-lang-tag {
    position: absolute;
    bottom: 62px;
    left: 12px;
    background: linear-gradient(135deg, rgba(10, 132, 255, 0.9), rgba(10, 132, 255, 0.7));
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 0.7rem;
    color: #ffffff;
    font-weight: 800;
    backdrop-filter: blur(4px);
    box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
    letter-spacing: 0.5px;
}

.movie-year-tag {
    position: absolute;
    bottom: 289px;
    right: 180px;
    background: linear-gradient(135deg, rgba(10, 132, 255, 0.9), rgba(10, 132, 255, 0.7));
    padding: 5px 12px;
    border-radius: 8px;
    font-size: 0.7rem;
    color: #ffffff;
    font-weight: 700;
    backdrop-filter: blur(4px);
    box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
    letter-spacing: 0.5px;
}

/* TITLE */
.movie-title {
    position: absolute;
    bottom: 8px;
    left: 12px;
    right: 12px;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 800;
    color: #ffffff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    z-index: 3;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
    backdrop-filter: blur(8px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    letter-spacing: 0.3px;
}

.movie-item:hover .movie-title {
    transform: translateY(-5px);
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
}

/* ===============================
   PROGRESS BAR
   =============================== */
.progress-container{
    position:absolute;
    top:0;
    left:0;
    right:0;
    height:3px;
    background:rgba(255,255,255,.1);
    overflow:hidden;
    z-index:10;
    opacity:1;
    transition:opacity .3s ease;
}
.progress-container.done{opacity:0;}
.progress-bar{
    height:100%;
    background:#0a84ff;
    width:0%;
    transition:width .3s ease;
}

/* ===============================
   PAGINATION
   =============================== */
.pagination{
    display:flex;
    justify-content:center;
    margin-top:1rem;
    gap:6px;
}
.page-btn{
    background:#111;
    color:#fff;
    border:1px solid #222;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    transition:background .25s;
}
.page-btn.active{
    background:#0a84ff;
    border-color:#0a84ff;
}
.page-btn:hover:not(.active){background:#222;}

/* ===============================
   FOOTER
   =============================== */
footer{
    background:#000;
    border-top:1px solid rgba(255,255,255,.08);
    color:#999;
    font-size:.9rem;
    text-align:center;
    padding:2rem 0;
}

/* ===============================
   RESPONSIVE
   =============================== */
@media (max-width:1200px){
    .movie-grid{grid-template-columns:repeat(2,minmax(180px,1fr));}
}
@media (max-width:992px){
    .nav-menu-wrapper{display:none;}
    .hamburger-menu{display:flex;}
    .nav-search{max-width:none;flex:1;margin-left:1rem;}
}
@media (max-width:600px){
    .container{padding:0 1rem;}
    .nav-search{margin-left:.5rem;}
    .movie-title{font-size: 0.9rem;}
    .modal-box{width:95%;max-width:none;max-height:90vh;}
    .modal-grid{grid-template-columns:1fr;}
    .modal-item{
        padding:.5rem .8rem;
        font-size:.85rem;
        border-right:none;
    }
}

</style>
</head>
<body>

<div class="nav-wrapper">
  <div class="container">
    <div class="nav">
      <a href="#" class="logo">^B√ÅNH M√å^</a>
      <div class="nav-search">
        <input type="text" class="nav-search-input" id="nav-search-input" placeholder="T√¨m t·∫°i ƒë√¢y...">
        <button class="nav-search-btn" id="nav-search-btn">üëìÔ∏è</button>
      </div>
      <div class="nav-menu-wrapper">
        <ul class="nav-menu" id="nav-menu">
          <li><a href="#" id="home-link">Trang ch·ªß</a></li>
          <li><a href="#" class="menu-trigger" data-target="genre">Th·ªÉ Lo·∫°i</a></li>
          <li><a href="#" class="menu-trigger" data-target="country">Qu·ªëc Gia</a></li>
          <li><a href="#" class="menu-trigger" data-target="year">NƒÉm</a></li>
          <li><a href="#" class="menu-trigger" data-target="cutee">Kh√°c</a></li>
          <li><a href="#" id="phim-bo">Phim B·ªô</a></li>
          <li><a href="#" id="phim-le">Phim L·∫ª</a></li>
          <li><a href="#" id="phim-chieu-rap">Cinemax</a></li>
        </ul>
      </div>
      <div class="hamburger-menu" id="hamburger">
        <div class="hamburger"></div><div class="hamburger"></div><div class="hamburger"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Menu</div>
      <div class="modal-close" id="modalClose">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-grid" id="modalBody"></div>
    </div>
  </div>
</div>

<div id="main-content"></div>

<footer>
  <div class="container">
    <p class="footer-heading">XEM - PHIM - GI·∫¢I TR√ç - TH∆Ø GI·∫¢N</p>
    <p>Load ƒë√¥i khi ch·∫≠m vui l√≤ng ƒë·ª£i...!</p>
  </div>
</footer>

<script>
// ==================== PROXY M·∫†NH CHO API (AX, BX, CX) ====================
const PROXY_API = 'https://api.allorigins.win/raw?url=';
const proxyUrl = (url) => PROXY_API + encodeURIComponent(url);

// ==================== C·∫§U H√åNH NGU·ªíN (ƒê√É QUA PROXY) ====================
const GENRE_SLUG_MAP = { 'H√†nh ƒê·ªông': 'hanh-dong','Phi√™u L∆∞u': 'phieu-luu','Ho·∫°t H√¨nh': 'hoat-hinh','H√†i': 'phim-hai','H√†i H∆∞·ªõc': 'hai-huoc','H√¨nh S·ª±': 'hinh-su','T√†i Li·ªáu': 'tai-lieu','Ch√≠nh K·ªãch': 'chinh-kich','Gia ƒê√¨nh': 'gia-dinh','Gi·∫£ T∆∞·ªüng': 'gia-tuong','L·ªãch S·ª≠': 'lich-su','Kinh D·ªã': 'kinh-di','Nh·∫°c': 'am-nhac','√Çm Nh·∫°c': 'am-nhac','B√≠ ·∫®n': 'bi-an','L√£ng M·∫°n': 'lang-man','T√¨nh C·∫£m': 'tinh-cam','Khoa H·ªçc Vi·ªÖn T∆∞·ªüng': 'khoa-hoc-vien-tuong','G√¢y C·∫•n': 'gay-can','Chi·∫øn Tranh': 'chien-tranh','T√¢m L√Ω': 'tam-ly','C·ªï Trang': 'co-trang','Mi·ªÅn T√¢y': 'mien-tay','Phim 18': 'phim-18','Th·ªÉ Thao': 'the-thao','V√µ Thu·∫≠t': 'vo-thuat','Vi·ªÖn T∆∞·ªüng': 'vien-tuong','Khoa H·ªçc': 'khoa-hoc','Th·∫ßn Tho·∫°i': 'than-thoai','H·ªçc ƒê∆∞·ªùng': 'hoc-duong','Kinh ƒêi·ªÉn': 'kinh-dien' };
const COUNTRY_SLUG_MAP = { '√Çu M·ªπ': 'au-my','H√†n Qu·ªëc': 'han-quoc','Trung Qu·ªëc': 'trung-quoc','Nh·∫≠t B·∫£n': 'nhat-ban','Th√°i Lan': 'thai-lan','H·ªìng K√¥ng': 'hong-kong','·∫§n ƒê·ªô': 'an-do','Anh': 'anh','Ph√°p': 'phap','Canada': 'canada','ƒê·ª©c': 'duc','T√¢y Ban Nha': 'tay-ban-nha','√öc': 'uc','√ù': 'y','H√† Lan': 'ha-lan','Indonesia': 'indonesia','Nga': 'nga','Mexico': 'mexico','Ba Lan': 'ba-lan','Malaysia': 'malaysia','B·ªì ƒê√†o Nha': 'bo-dao-nha','Th·ª•y ƒêi·ªÉn': 'thuy-dien','Philippines': 'philippines','ƒêan M·∫°ch': 'dan-mach','Th·ª•y Sƒ©': 'thuy-si','Ukraina': 'ukraina','UAE': 'uae','·∫¢ R·∫≠p X√™ √öt': 'a-rap-xe-ut','Th·ªï Nhƒ© K·ª≥': 'tho-nhi-ky','Brazil': 'brazil','Na Uy': 'na-uy','Nam Phi': 'nam-phi','Vi·ªát Nam': 'viet-nam','ƒê√†i Loan': 'dai-loan','Ch√¢u Phi': 'chau-phi','B·ªâ': 'bi','Ireland': 'ireland','Colombia': 'colombia','Ph·∫ßn Lan': 'phan-lan','Chile': 'chile','Hy L·∫°p': 'hy-lap','Nigeria': 'nigeria','Argentina': 'argentina','Singapore': 'singapore','Qu·ªëc Gia Kh√°c': 'quoc-gia-khac' };
const TYPE_MAP = {'phim-bo': 'phim-bo','phim-le': 'phim-le','thuyet-minh': 'phim-thuyet-minh','chieu-rap': 'phim-chieu-rap'};
const CUTEE_MENU = { 'Phim m·ªõi': { mode: 'default' },'Phim b·ªô': { mode: 'type', filter: 'phim-bo' },'Phim l·∫ª': { mode: 'type', filter: 'phim-le' },'Shows': { mode: 'cutee', slug: 'tv-shows' },'Ho·∫°t h√¨nh': { mode: 'cutee', slug: 'hoat-hinh' },'Phim vietsub': { mode: 'cutee', slug: 'vietsub' },'Phim thuy·∫øt minh': { mode: 'cutee', slug: 'thuyet-minh' },'Phim l·ªìng ti·∫øng': { mode: 'cutee', slug: 'long-tieng' },'Phim b·ªô ƒëang chi·∫øu': { mode: 'cutee', slug: 'phim-dang-chieu' },'Phim b·ªô ƒë√£ ho√†n th√†nh': { mode: 'cutee', slug: 'hoan-tat' },'Phim s·∫Øp chi·∫øu': { mode: 'cutee', slug: 'phim-sap-chieu' },'Subteam': { mode: 'cutee', slug: 'subteam' },'Phim chi·∫øu r·∫°p': { mode: 'cutee', slug: 'phim-chieu-rap' } };

const API_SOURCES = { 
  Ophim: { name: 'Ophim', code: 'ax', 
    defaultUrl: p => proxyUrl(`https://ophim1.com/v1/api/danh-sach/phim-moi-cap-nhat?page=${p}`),
    genreUrl: (s,p) => proxyUrl(`https://ophim1.com/v1/api/the-loai/${s}?page=${p}`),
    countryUrl: (s,p) => proxyUrl(`https://ophim1.com/v1/api/quoc-gia/${s}?page=${p}`),
    yearUrl: (y,p) => proxyUrl(`https://ophim1.com/v1/api/nam-phat-hanh/${y}?page=${p}`),
    typeUrl: (t,p) => proxyUrl(`https://ophim1.com/v1/api/danh-sach/${t}?page=${p}`),
    cuteeUrl: (s,p) => proxyUrl(`https://ophim1.com/v1/api/danh-sach/${s}?page=${p}`),
    searchUrl: s => proxyUrl(`https://ophim1.com/v1/api/phim/${s}`),
    keywordSearchUrl: (k,p=1) => proxyUrl(`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(k)}&page=${p}`),
    parser: d => d?.data?.items || [], searchParser: d => d?.data?.item ? [d.data.item] : [], keywordParser: d => d?.data?.items || [], getCdn: () => "https://img.ophim.live/uploads/movies/" }, 
  Phimapi: { name: 'Phimapi', code: 'bx',
    defaultUrl: p => proxyUrl(`https://phimapi.com/danh-sach/phim-moi-cap-nhat-v3?page=${p}`),
    genreUrl: (s,p) => proxyUrl(`https://phimapi.com/v1/api/the-loai/${s}?page=${p}`),
    countryUrl: (s,p) => proxyUrl(`https://phimapi.com/v1/api/quoc-gia/${s}?page=${p}`),
    yearUrl: (y,p) => proxyUrl(`https://phimapi.com/v1/api/nam/${y}?page=${p}`),
    typeUrl: (t,p) => proxyUrl(`https://phimapi.com/v1/api/danh-sach/${t}?page=${p}`),
    cuteeUrl: (s,p) => proxyUrl(`https://phimapi.com/v1/api/danh-sach/${s}?page=${p}`),
    searchUrl: s => proxyUrl(`https://phimapi.com/phim/${s}`),
    keywordSearchUrl: (k,p=1) => proxyUrl(`https://phimapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(k)}&page=${p}`),
    parser: d => d?.data?.items || d?.items || [], searchParser: d => d?.movie ? [d.movie] : [], keywordParser: d => d?.data?.items || [], getCdn: d => (d?.data?.APP_DOMAIN_CDN_IMAGE || 'https://phimimg.com/').replace(/\/+$/, '') + '/' }, 
  Nguonc: { name: 'Nguonc', code: 'cx',
    defaultUrl: p => proxyUrl(`https://phim.nguonc.com/api/films/phim-moi-cap-nhat?page=${p}`),
    genreUrl: (s,p) => proxyUrl(`https://phim.nguonc.com/api/films/danh-sach/${s}?page=${p}`),
    countryUrl: (s,p) => proxyUrl(`https://phim.nguonc.com/api/films/quoc-gia/${s}?page=${p}`),
    yearUrl: (y,p) => proxyUrl(`https://phim.nguonc.com/api/films/nam-phat-hanh/${y}?page=${p}`),
    typeUrl: (t,p) => proxyUrl(`https://phim.nguonc.com/api/films/danh-sach/${t}?page=${p}`),
    cuteeUrl: (s,p) => proxyUrl(`https://phim.nguonc.com/api/films/danh-sach/${s}?page=${p}`),
    searchUrl: s => proxyUrl(`https://phim.nguonc.com/api/film/${s}`),
    keywordSearchUrl: (k,p=1) => proxyUrl(`https://phim.nguonc.com/api/films/search?keyword=${encodeURIComponent(k)}&page=${p}`),
    parser: d => d?.items || [], searchParser: d => d?.movie ? [d.movie] : [], keywordParser: d => d?.items || [], getCdn: () => "https://phim.nguonc.com/public/images/Poster/" } 
};

let ITEMS_PER_PAGE = 24, currentMode = 'default', currentFilter = null, currentPage = 1, currentSearchQuery = '';

// ==================== PROXY ·∫¢NH WESERV.NL ====================
const proxyImage = (url) => {
    if (!url || url.includes('images.weserv.nl') || url.includes('placeholder')) return url || 'https://via.placeholder.com/300x450/222222/999999?text=No+Image';
    return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=600&h=900&fit=outside&output=webp&q=90&il`;
};
const PLACEHOLDER_LOW = 'abc.jpg';

// ==================== L∆ØU / KH√îI PH·ª§C TR·∫†NG TH√ÅI ====================
const STATE_KEY = 'phim_state';
const saveState = () => localStorage.setItem(STATE_KEY, JSON.stringify({mode:currentMode,filter:currentFilter,page:currentPage,search:currentSearchQuery}));
const loadState = () => { try{ const s = JSON.parse(localStorage.getItem(STATE_KEY)||'{}'); if(s.mode){ currentMode=s.mode; currentFilter=s.filter; currentPage=s.page||1; currentSearchQuery=s.search||''; }}catch{} };
const clearState = () => localStorage.removeItem(STATE_KEY);

// ==================== EPISODE DISPLAY ====================
const getEpisodeDisplay = i => {
  if (!i) return '';
  const m = i.movie || i;
  const e = i.episodes || m.episodes || [];
  if (!m.episode_current && !m.current_episode && !m.episode_total && !m.total_episodes && !Array.isArray(e)) return (m.type || m.tmdb?.type) === 'tv' ? 'Phim b·ªô' : 'Phim l·∫ª';
  let c = '', t = '', l = 0;
  const cur = m.episode_current || m.current_episode || '';
  const tot = m.episode_total || m.total_episodes || '';
  const cm = cur.match(/T·∫≠p (\d+)/i) || cur.match(/(\d+)/);
  if (cm) c = cm[1];
  if (tot) t = tot;
  if (Array.isArray(e)) e.forEach(s => { const d = s.server_data || s.items || []; if (Array.isArray(d)) l += d.length; });
  let disp = c && t ? `T·∫≠p ${c}/${t}` : c ? `T·∫≠p ${c}` : /full|ho√†n t·∫•t|ho√†n th√†nh/i.test(cur) ? 'Ho√†n t·∫•t' : 'ƒêang ph√°t';
  if (l > 0) disp += ` (${l} link)`;
  return disp;
};

// ==================== FETCH + X·ª¨ L√ù D·ªÆ LI·ªÜU (CH·ªà S·ª¨A D√íNG N√ÄY) ====================
const fetchFromSource = async (src, p, m, f, isS = false, isK = false) => {
  let url = '';
  if (isK) url = src.keywordSearchUrl(f, p);
  else if (isS) url = src.searchUrl(f);
  else if (m === 'genre') url = src.genreUrl(f, p);
  else if (m === 'country') url = src.countryUrl(f, p);
  else if (m === 'year') url = src.yearUrl(f, p);
  else if (m === 'type' || m === 'cutee') url = (src.cuteeUrl || src.typeUrl)(f, p);
  else url = src.defaultUrl(p);

  try {
    const r = await fetch(url);
    if (!r.ok) return [];
    const d = await r.json();
    const parser = isK ? src.keywordParser : isS ? src.searchParser : src.parser;
    let items = parser(d) || [];
    const cdn = typeof src.getCdn === 'function' ? src.getCdn(d) : src.getCdn();

    return items.map(it => {
      // ƒê√ÇY L√Ä D√íNG DUY NH·∫§T ƒê∆Ø·ª¢C S·ª¨A THEO Y√äU C·∫¶U C·ª¶A B·∫†N
      let thumb = '';
      if (src.code === 'ax') thumb = it.thumb_url || it.poster_url || it.poster || it.thumb || '';        // Ophim ‚Üí thumb_url
      if (src.code === 'bx') thumb = it.poster_url || it.thumb_url || it.poster || it.thumb || '';        // Phimapi ‚Üí poster_url
      if (src.code === 'cx') thumb = it.thumb_url || it.poster_url || it.poster || it.thumb || '';        // Nguonc ‚Üí thumb_url

      if (thumb && !thumb.startsWith('http') && !thumb.startsWith('//') && cdn) thumb = cdn + thumb.replace(/^\/+/, '');
      return {
        name: it.name || it.origin_name || it.title || 'Kh√¥ng r√µ',
        thumb_url: proxyImage(thumb),
        episodeDisplay: getEpisodeDisplay(it),
        slug: it.slug || it._id || '',
        sourceCode: src.code,
        sourceName: src.name,
        year: (it.year || '').toString(),
        lang: (it.lang || '').toUpperCase(),
        quality: it.quality || ''
      };
    }).filter(x => x.slug && x.thumb_url);
  } catch (e) { console.error('FETCH ERR:', src.name, e); return []; }
};

// ==================== T·ª™ ƒê√ÇY TR·ªû XU·ªêNG GI·ªÆ NGUY√äN 100% CODE C·ª¶A B·∫†N ====================
const interleaveFull = async (mode, filter, page, isSearch = false, isKeyword = false) => {
  const sources = Object.values(API_SOURCES);
  const results = await Promise.all(sources.map(src => fetchFromSource(src, page, mode, filter, isSearch, isKeyword)));
  const all = []; const seen = new Set(); let idx = new Array(sources.length).fill(0);
  while (all.length < ITEMS_PER_PAGE * 3) {
    let added = false;
    for (let i = 0; i < sources.length; i++) {
      if (idx[i] < results[i].length) {
        const m = results[i][idx[i]];
        if (!seen.has(m.slug + m.sourceCode)) { seen.add(m.slug + m.sourceCode); all.push(m); added = true; }
        idx[i]++;
      }
    }
    if (!added) break;
  }
  return all.slice(0, ITEMS_PER_PAGE);
};

const search = async (q = null, p = 1) => {
  const raw = (q || document.getElementById('nav-search-input').value).trim();
  if (!raw) return load('default');
  currentSearchQuery = raw; currentPage = p;
  const sid = 'search-sec';
  let sec = document.getElementById(sid); if (!sec) sec = createSec(sid, `T√åM: "${raw}"`);
  else sec.querySelector('.section-header').textContent = `T√åM: "${raw}"`;
  showSec(sec); const grid = document.getElementById(`${sid}-grid`); grid.innerHTML = '';
  const slugMovies = await interleaveFull(null, raw, p, true);
  const keyMovies = await interleaveFull(null, raw, p, false, true);
  const all = [...slugMovies, ...keyMovies];
  const seen = new Set(), fin = all.filter(m => !seen.has(m.slug + m.sourceCode) && seen.add(m.slug + m.sourceCode));
  await renderFinal(fin, grid, `${sid}-progress`);
  renderPag(p, sid, fin.length >= ITEMS_PER_PAGE);
  sec.scrollIntoView({behavior:'smooth'});
  saveState();
};

let loaded = 0, total = 0, progId = null;
const updateProg = id => {
  loaded++;
  const bar = document.getElementById(id);
  if (bar) bar.style.width = (loaded / total * 100) + '%';
  if (loaded === total) document.getElementById(id + '-cont')?.classList.add('done');
};

const createCard = (m) => {
  const c = document.createElement('div'); c.className = 'movie-item';
  c.dataset.slug = m.slug; c.dataset.source = m.sourceCode;
  c.onclick = () => { saveState(); location.href = `detail.html?slug=${m.slug}&source=${m.sourceCode}`; };

  const epTag = document.createElement('div'); epTag.className = 'movie-ep-tag'; epTag.textContent = m.episodeDisplay || ''; if (!epTag.textContent) epTag.style.display = 'none';
  const topRight = document.createElement('div'); topRight.className = 'movie-top-right';
  const qualityTag = document.createElement('div'); qualityTag.className = 'movie-quality-tag'; qualityTag.textContent = m.quality || ''; if (!qualityTag.textContent) qualityTag.style.display = 'none';
  const sourceTag = document.createElement('div'); sourceTag.className = 'movie-source-tag'; sourceTag.textContent = m.sourceCode || '';
  topRight.append(qualityTag, sourceTag);
  const langTag = document.createElement('div'); langTag.className = 'movie-lang-tag'; langTag.textContent = m.lang || "Vietsub";
  const yearTag = document.createElement('div'); yearTag.className = 'movie-year-tag'; yearTag.textContent = m.year || ''; if (!yearTag.textContent) yearTag.style.display = 'none';
  const titleTag = document.createElement('div'); titleTag.className = 'movie-title'; titleTag.textContent = m.name;

  const imgReal = document.createElement('img'); imgReal.className = 'movie-img-real'; imgReal.loading = 'lazy';
  const imgPlaceholder = document.createElement('img'); imgPlaceholder.className = 'movie-img-placeholder'; imgPlaceholder.src = PLACEHOLDER_LOW;

  const imgContainer = document.createElement('div'); imgContainer.className = 'movie-img-container';
  imgContainer.append(imgReal, imgPlaceholder, epTag, topRight, langTag, yearTag, titleTag);
  c.appendChild(imgContainer);

  return { card: c, imgReal, imgPlaceholder, url: m.thumb_url };
};

const renderFinal = async (movies, container, id) => {
  container.innerHTML = '';
  const disp = movies.slice(0, ITEMS_PER_PAGE);
  total = disp.length; loaded = 0; progId = id;
  const cards = disp.map(m => createCard(m));
  cards.forEach(o => container.appendChild(o.card));
  cards.forEach(o => {
    if (!o.url) { o.imgPlaceholder.style.opacity = '1'; updateProg(id); return; }
    const img = new Image();
    img.onload = () => { o.imgReal.src = o.url; o.imgReal.style.opacity = '1'; o.imgPlaceholder.style.opacity = '0'; updateProg(id); };
    img.onerror = () => { o.imgPlaceholder.style.opacity = '1'; updateProg(id); };
    img.src = o.url;
  });
};

const createSec = (id, title) => {
  const s = document.createElement('div'); s.className='section'; s.id=id;
  s.innerHTML = `<div class="progress-container" id="${id}-progress-cont"><div class="progress-bar" id="${id}-progress"></div></div><div class="container"><div class="section-header">${title}</div><div class="movie-grid" id="${id}-grid"></div><div class="pagination" id="${id}-pagination"></div></div>`;
  return s;
};
const showSec = sec => {
  document.querySelectorAll('#main-content > .section').forEach(x => x.style.display = 'none');
  const c = document.getElementById('main-content');
  const ex = document.getElementById(sec.id);
  if (ex) { ex.style.display = 'block'; c.insertBefore(ex, c.firstChild); }
  else { c.insertBefore(sec, c.firstChild); sec.style.display = 'block'; }
};
const renderPag = (p, sid, more) => {
  const el = document.getElementById(`${sid}-pagination`); if (!el) return; el.innerHTML = '';
  const prev = document.createElement('button'); prev.className='page-btn'; prev.textContent='‚Äπ'; prev.disabled=p===1;
  prev.onclick = () => { currentSearchQuery ? search(currentSearchQuery, p-1) : load(currentMode, currentFilter, p-1); }; el.appendChild(prev);
  for (let i = Math.max(1, p-3); i <= p+4; i++) {
    const b = document.createElement('button'); b.className='page-btn'; if (i===p) b.classList.add('active'); b.textContent=i;
    b.onclick = () => { currentSearchQuery ? search(currentSearchQuery, i) : load(currentMode, currentFilter, i); }; el.appendChild(b);
  }
  const next = document.createElement('button'); next.className='page-btn'; next.textContent='‚Ä∫'; next.disabled=!more;
  next.onclick = () => { currentSearchQuery ? search(currentSearchQuery, p+1) : load(currentMode, currentFilter, p+1); }; el.appendChild(next);
};

const getTitle = (m, f) => {
  if (m==='default') return 'PHIM M·ªöI NH√Ä B√ÅNH M√å';
  if (m==='genre') return `TH·ªÇ LO·∫†I: ${Object.keys(GENRE_SLUG_MAP).find(k=>GENRE_SLUG_MAP[k]===f)?.toUpperCase()||f.toUpperCase()}`;
  if (m==='country') return `QU·ªêC GIA: ${Object.keys(COUNTRY_SLUG_MAP).find(k=>COUNTRY_SLUG_MAP[k]===f)?.toUpperCase()||f.toUpperCase()}`;
  if (m==='year') return `NƒÇM: ${f}`;
  if (m==='type') return {'phim-bo':'PHIM B·ªò','phim-le':'PHIM L·∫∫'}[f]||f.toUpperCase();
  if (m==='cutee') { const l=Object.keys(CUTEE_MENU).find(k=>CUTEE_MENU[k].slug===f||CUTEE_MENU[k].filter===f); return l?.toUpperCase()||f.toUpperCase().replace(/-/g,' '); }
  return f?.toUpperCase()||'PHIM';
};

const load = async (m, f=null, p=1) => {
  currentSearchQuery = ''; document.getElementById('nav-search-input').value = '';
  currentMode=m; currentFilter=f; currentPage=p;
  if (m==='default') { document.querySelectorAll('#main-content > .section').forEach(x=>x.remove()); loadTxt(); saveState(); return; }
  const title=getTitle(m,f), sid=`${m}-${f||''}-sec`.replace(/--/g,'-');
  let sec=document.getElementById(sid); if(!sec) sec=createSec(sid,title);
  showSec(sec); const grid=document.getElementById(`${sid}-grid`); grid.innerHTML='';
  const movies=await interleaveFull(m,f,p);
  await renderFinal(movies,grid,`${sid}-progress`);
  renderPag(p,sid,movies.length>=ITEMS_PER_PAGE);
  sec.scrollIntoView({behavior:'smooth'});
  saveState();
};

const loadTxt = async () => {
  try {
    const r = await fetch('custom-menu.txt?t=' + Date.now());
    if (!r.ok) throw 1;
    const txt = await r.text();
    if (!txt.trim()) throw 1;
    const groups = parseTxt(txt);
    for (const [name, items] of Object.entries(groups)) if (items.length) await loadGroup(name, items);
  } catch {
    document.getElementById('main-content').innerHTML = '<div class="container"><h2 style="text-align:center;padding:100px;color:#aaa;">Ch∆∞a c√≥ custom-menu.txt</h2></div>';
  }
  saveState();
};
const parseTxt = txt => {
  const lines = txt.split('\n'), g = {}; let cur = null;
  lines.forEach(l => {
    l = l.trim(); if (!l) return;
    if (l.startsWith('#')) { cur = l.substring(1).trim(); if (!g[cur]) g[cur] = []; return; }
    if (!cur) return;
    const p = l.split('|'); if (p.length < 2) return;
    const [st, sk, dt] = p.map(x => x.trim());
    const sl = st.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,'-').replace(/^-+|-+$/g,'');
    g[cur].push({slug:sl, source:sk.toLowerCase(), display:dt||st});
  });
  return g;
};
const loadGroup = async (name, items) => {
  const sid = `txt-${name.toLowerCase().replace(/[^a-z0-9]/g,'-')}`;
  let sec = document.getElementById(sid); if (!sec) sec = createSec(sid, name);
  const cont = document.getElementById('main-content');
  if (!document.getElementById(sid)) cont.appendChild(sec);
  sec.style.display = 'block';
  const grid = document.getElementById(`${sid}-grid`); grid.innerHTML = '';
  const all = [];
  for (const i of items) {
    const src = Object.values(API_SOURCES).find(s => s.name.toLowerCase() === i.source);
    if (!src) continue;
    const res = await fetchFromSource(src, null, null, i.slug, true, false);
    all.push(...res);
  }
  const seen = new Set(), fin = all.filter(m => !seen.has(m.slug + m.sourceCode) && seen.add(m.slug + m.sourceCode));
  await renderFinal(fin, grid, `${sid}-progress`);
  document.getElementById(`${sid}-pagination`).style.display = 'none';
};

document.addEventListener('DOMContentLoaded', () => {
  loadState();
  if (currentSearchQuery) {
    document.getElementById('nav-search-input').value = currentSearchQuery;
    search(currentSearchQuery, currentPage);
  } else if (currentMode !== 'default') {
    load(currentMode, currentFilter, currentPage);
  } else {
    loadTxt();
  }

  const hamburger = document.getElementById('hamburger');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');

  const openModal = (t, items, cb) => {
    modalTitle.textContent = t; modalBody.innerHTML = '';
    document.querySelectorAll('.modal-item.active').forEach(x=>x.classList.remove('active'));
    items.forEach(it => {
      const d = document.createElement('div'); d.className = 'modal-item'; d.textContent = it;
      d.onclick = () => { document.querySelectorAll('.modal-item.active').forEach(x=>x.classList.remove('active')); d.classList.add('active'); cb(it); };
      modalBody.appendChild(d);
    });
    modalBackdrop.classList.add('show');
  };
  const closeModal = () => modalBackdrop.classList.remove('show');
  modalClose.onclick = closeModal;
  modalBackdrop.onclick = e => { if (e.target === modalBackdrop) closeModal(); };

  if (hamburger) hamburger.onclick = () => openModal(
    'MENU',
    ['Trang ch·ªß','Th·ªÉ Lo·∫°i','Qu·ªëc Gia','NƒÉm','Kh√°c','Phim B·ªô','Phim L·∫ª','Cinemax'],
    v => {
      if (v === 'Trang ch·ªß') { clearState(); location.reload(); return; }
      if (v === 'Th·ªÉ Lo·∫°i') openModal('TH·ªÇ LO·∫†I', Object.keys(GENRE_SLUG_MAP), x => load('genre', GENRE_SLUG_MAP[x], 1));
      if (v === 'Qu·ªëc Gia') openModal('QU·ªêC GIA', Object.keys(COUNTRY_SLUG_MAP), x => load('country', COUNTRY_SLUG_MAP[x], 1));
      if (v === 'NƒÉm') openModal('NƒÇM', Array.from({length:25},(_,i)=>2025-i), x => load('year', x, 1));
      if (v === 'Kh√°c') openModal('KH√ÅC', Object.keys(CUTEE_MENU), x => { const c=CUTEE_MENU[x]; load(c.mode, c.slug || c.filter, 1); });
      if (v === 'Phim B·ªô') load('type', 'phim-bo', 1);
      if (v === 'Phim L·∫ª') load('type', 'phim-le', 1);
      if (v === 'Cinemax') load('cutee', 'phim-chieu-rap', 1);
    }
  );

  document.querySelectorAll('.menu-trigger').forEach(el => {
    el.onclick = e => { e.preventDefault();
      const t = el.dataset.target;
      if(t==='genre') openModal('TH·ªÇ LO·∫†I', Object.keys(GENRE_SLUG_MAP), x=>load('genre',GENRE_SLUG_MAP[x],1));
      if(t==='country') openModal('QU·ªêC GIA', Object.keys(COUNTRY_SLUG_MAP), x=>load('country',COUNTRY_SLUG_MAP[x],1));
      if(t==='year') openModal('NƒÇM', Array.from({length:25},(_,i)=>2025-i), x=>load('year',x,1));
      if(t==='cutee') openModal('KH√ÅC', Object.keys(CUTEE_MENU), x=>{const c=CUTEE_MENU[x];load(c.mode,c.slug||c.filter,1);});
    };
  });

  document.getElementById('home-link')?.addEventListener('click', e => { e.preventDefault(); clearState(); load('default'); });
  document.getElementById('phim-bo')?.addEventListener('click', e => { e.preventDefault(); load('type','phim-bo',1); });
  document.getElementById('phim-le')?.addEventListener('click', e => { e.preventDefault(); load('type','phim-le',1); });
  document.getElementById('phim-chieu-rap')?.addEventListener('click', e => { e.preventDefault(); load('cutee','phim-chieu-rap',1); });
  document.getElementById('nav-search-btn')?.addEventListener('click', () => search());
  document.getElementById('nav-search-input')?.addEventListener('keypress', e => { if(e.key==='Enter') search(); });
});
</script>
</body>
</html>
