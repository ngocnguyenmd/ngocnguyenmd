<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Phim Hay - Xem phim Hàn, phim bộ, phim lẻ chất lượng cao">
    <meta name="keywords" content="phim Hàn, phim bộ, phim lẻ, xem phim online, phim chất lượng cao">
    <meta name="author" content="Phim Hay">
    <title>Phim Hay - Truyền hình</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #e50914;
            --primary-hover: #b20710;
            --bg-dark: #181818;
            --bg-section: #222;
            --text-white: #fff;
            --text-gray: #b3b3b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --bg-dark: #f4f4f4;
            --bg-section: #e0e0e0;
            --text-white: #333;
            --text-gray: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-dark);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            flex-wrap: wrap;
        }

        .logo {
            max-height: 50px;
            transition: var(--transition);
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 500px;
            min-width: 200px;
            position: relative;
        }

        .search-bar input {
            padding: 12px 40px 12px 15px;
            border: none;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            font-size: 1em;
            width: 100%;
            transition: var(--transition);
        }

        .search-bar input:focus {
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            box-shadow: 0 0 5px var(--primary-color);
        }

        .search-bar i {
            position: absolute;
            right: 15px;
            color: var(--text-gray);
            font-size: 1.2em;
            cursor: pointer;
        }

        .search-bar .clear-search {
            right: 35px;
            display: none;
        }

        .search-bar .clear-search.visible {
            display: block;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-section);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestions.visible {
            display: block;
        }

        .search-suggestions div {
            padding: 10px 15px;
            color: var(--text-white);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-suggestions div:hover {
            background: var(--primary-color);
        }

        .nav-menu {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .nav-menu a {
            color: var(--text-white);
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .nav-menu a:hover {
            background-color: var(--primary-hover);
            color: var(--text-white);
        }

        .nav-menu a.active {
            background-color: var(--primary-color);
            color: var(--text-white);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-white);
            font-size: 1.5em;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--primary-color);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            flex: 1;
        }

        .movie-section {
            margin-bottom: 40px;
        }

        .movie-section h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: center;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .movie-item {
            position: relative;
            transition: transform 0.3s ease;
        }

        .movie-item:hover {
            transform: translateY(-5px);
        }

        .movie-poster {
            position: relative;
            aspect-ratio: 2 / 3;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .movie-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: opacity 0.3s ease;
        }

        .movie-poster.skeleton::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            z-index: 1;
        }

        .movie-poster img:not(.loaded) {
            opacity: 0;
        }

        .movie-poster img.loaded {
            opacity: 1;
        }

        .episode-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 500;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .check-icon {
            font-size: 0.8em;
        }

        .movie-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 10px;
        }

        .movie-item:hover .movie-overlay {
            opacity: 1;
        }

        .movie-overlay p {
            color: var(--text-white);
            font-size: 0.9em;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        .movie-title {
            display: block;
            margin-top: 10px;
            color: var(--text-white);
            font-size: 1.1em;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            transition: color 0.3s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .movie-title:hover {
            color: var(--primary-color);
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            z-index: 1000;
            display: none;
        }

        .loading-spinner.visible {
            display: block;
        }

        footer {
            background: var(--bg-section);
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .footer-btn {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .footer-text {
            font-size: 0.9em;
            color: var(--text-gray);
        }

        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .scroll-top:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .scroll-top.visible {
            display: flex;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-section);
            color: var(--text-white);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--error-color);
        }

        .toast.visible {
            display: block;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @media (max-width: 1024px) {
            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .movie-section h2 {
                font-size: 1.8em;
            }

            .movie-title {
                font-size: 1em;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }

            .header-content {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .logo {
                max-height: 40px;
            }

            .search-bar {
                max-width: 100%;
                min-width: 200px;
            }

            .nav-menu {
                gap: 10px;
                justify-content: center;
            }

            .nav-menu a {
                font-size: 0.95em;
                padding: 6px 10px;
            }

            .main-content {
                padding: 90px 15px 30px;
            }

            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }

            .movie-section h2 {
                font-size: 1.6em;
            }

            .movie-title {
                font-size: 0.95em;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 8px 10px;
            }

            .logo {
                max-height: 35px;
            }

            .search-bar input {
                font-size: 0.9em;
                padding: 10px 35px 10px 12px;
            }

            .nav-menu a {
                font-size: 0.9em;
                padding: 6px 10px;
            }

            .main-content {
                padding: 80px 10px 20px;
            }

            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .movie-section h2 {
                font-size: 1.4em;
            }

            .movie-title {
                font-size: 0.9em;
            }

            .episode-badge {
                font-size: 0.8em;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://www.freeiconspng.com/uploads/star-icon-11.png" alt="Phim Hay" class="logo">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Tìm kiếm phim...">
                <i class="fas fa-times clear-search" id="clear-search"></i>
                <i class="fas fa-search"></i>
                <div class="search-suggestions" id="search-suggestions"></div>
            </div>
            <div class="nav-menu">
                <a href="index.html">Trang chủ</a>
                <a href="phim-han.html">Phim Hàn</a>
                <a href="phim-trung.html">Phim Trung</a>
                <a href="phim-viet.html">Phim Việt</a>
                <a href="phim-my.html">Phim Mỹ</a>
                <a href="truyen-hinh.html">Truyền hình</a>
                <a href="hoat-hinh.html">Hoạt hình</a>
                <a href="netflix.html">Netflix</a>
                <a href="ykhoa.html">Y Khoa</a>
                <button class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="main-content">
        <section class="movie-section">
            <h2>Phim truyền hình</h2>
            <div class="movie-grid" id="recommended-list"></div>
        </section>
    </main>
    <footer>
        <div class="footer-buttons">
            <button class="footer-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                <i class="fas fa-arrow-up"></i> Lên đầu
            </button>
            <button class="footer-btn">
                <i class="fas fa-info-circle"></i> Liên hệ
            </button>
        </div>
        <p class="footer-text">© 2025 Phim Nhà Bánh Mì.</p>
    </footer>
    <button class="scroll-top" id="scroll-top">
        <i class="fas fa-arrow-up"></i>
    </button>
    <div class="toast" id="toast"></div>
    <div class="loading-spinner" id="loading-spinner"></div>
    <script>
        const elements = {
            recommendedList: document.getElementById('recommended-list'),
            searchInput: document.getElementById('search-input'),
            clearSearch: document.getElementById('clear-search'),
            searchSuggestions: document.getElementById('search-suggestions'),
            toast: document.getElementById('toast'),
            loadingSpinner: document.getElementById('loading-spinner'),
            scrollTop: document.getElementById('scroll-top'),
            themeToggle: document.getElementById('theme-toggle')
        };

        let allApiUrls = [];
        let customMovies = [];
        let seriesMovies = [];
        let singleMovies = [];
        let isLoading = false;
        const DEFAULT_POSTER = 'https://via.placeholder.com/200x300?text=No+Image';
        const currentPage = 'truyen-hinh';

        // Theme Toggle
        elements.themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
            document.body.dataset.theme = currentTheme;
            elements.themeToggle.innerHTML = `<i class="fas fa-${currentTheme === 'light' ? 'moon' : 'sun'}"></i>`;
            localStorage.setItem('theme', currentTheme);
        });

        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.dataset.theme = savedTheme;
        elements.themeToggle.innerHTML = `<i class="fas fa-${savedTheme === 'light' ? 'moon' : 'sun'}"></i>`;

        // Scroll Top Button
        window.addEventListener('scroll', () => {
            elements.scrollTop.classList.toggle('visible', window.scrollY > 300);
        });

        elements.scrollTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Toast Notification
        function showToast(message, type = 'error', duration = 3000) {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type} visible`;
            setTimeout(() => {
                elements.toast.className = 'toast';
            }, duration);
        }

        const showSuccessToast = (msg) => showToast(msg, 'success');
        const showErrorToast = (msg) => showToast(msg, 'error');

        // Fetch with Timeout
        async function fetchWithTimeout(url, options = {}, timeout = 15000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        // Check File Existence
        async function checkFileExists(file) {
            try {
                const response = await fetchWithTimeout(file, { method: 'HEAD', cache: 'no-store' }, 5000);
                return response.ok;
            } catch {
                return false;
            }
        }

        // Load API URLs
        async function loadApiUrls() {
            if (!(await checkFileExists('apiurl.json'))) {
                console.error('File apiurl.json không tồn tại');
                showErrorToast('Không tìm thấy apiurl.json');
                return [];
            }
            try {
                const response = await fetchWithTimeout('apiurl.json', { cache: 'no-store' });
                if (!response.ok) {
                    console.error('Không thể tải apiurl.json:', response.status);
                    showErrorToast('Lỗi tải apiurl.json');
                    return [];
                }
                const data = await response.json();
                console.log('Raw apiurl.json data:', data);
                const urls = data
                    .filter(item => item && item[currentPage])
                    .flatMap(item => item[currentPage] || []);
                console.log('Extracted API URLs:', urls);
                if (urls.length === 0) {
                    console.warn('Không tìm thấy URL nào cho trang', currentPage);
                    showErrorToast('Không có URL API cho trang truyền hình');
                }
                return urls;
            } catch (error) {
                console.error('Lỗi khi tải apiurl.json:', error);
                showErrorToast('Không thể tải apiurl.json');
                return [];
            }
        }

        // Load Custom Movies
        async function loadCustomMovies(file) {
            if (!(await checkFileExists(file))) {
                console.error(`File ${file} không tồn tại`);
                showErrorToast(`File ${file} không tồn tại`);
                return [];
            }
            try {
                const response = await fetchWithTimeout(file, { cache: 'no-store' });
                if (!response.ok) {
                    console.error(`Không thể tải file ${file}: ${response.status}`);
                    showErrorToast(`Không thể tải file ${file}`);
                    return [];
                }
                const text = await response.text();
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                const movies = [];
                const episodeRegex = /^(.+?)\|(.+?)\|(.+?)?\|(.+?)$/;
                const linkRegex = /^(.+?)\|(.+?)$/;
                const urlRegex = /^https?:\/\/.+/;

                if (lines.length === 0) {
                    console.warn(`File ${file} rỗng`);
                    return [];
                }

                for (let i = 0; i < lines.length; i++) {
                    const match = lines[i].match(episodeRegex);
                    if (match && !lines[i].includes('|sv2|')) {
                        const [, pageTag, movieName, posterUrl, quality] = match;
                        if (!pageTag || !movieName || !quality) continue;
                        const episodes = [];
                        let apiSource = 'custom';
                        let apiUrl = null;
                        let slug = movieName.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-') || `custom-${Date.now()}`;
                        let episodeCount = 0;
                        const seenLinks = new Set();

                        for (let j = i + 1; j < lines.length && !lines[j].match(episodeRegex); j++) {
                            let epName = `Tập ${episodeCount + 1}`;
                            let link_m3u8 = '';
                            let link_embed = '';
                            let link_video = '';

                            const linkMatch = lines[j].match(linkRegex);
                            if (linkMatch) {
                                const [, name, link] = linkMatch;
                                epName = name.replace('Tập ', '').trim();
                                if (link.endsWith('.m3u8')) link_m3u8 = link;
                                else if (link.includes('youtube.com') || link.includes('vimeo.com') || link.includes('drive.google.com')) link_embed = link;
                                else link_video = link;
                            } else if (lines[j].match(urlRegex)) {
                                const link = lines[j];
                                if (link.endsWith('.m3u8')) link_m3u8 = link;
                                else if (link.includes('youtube.com') || link.includes('vimeo.com') || link.includes('drive.google.com')) link_embed = link;
                                else link_video = link;
                            } else continue;

                            const linkKey = link_m3u8 || link_embed || link_video;
                            if (linkKey && !seenLinks.has(linkKey)) {
                                seenLinks.add(linkKey);
                                episodes.push({ name: epName, link_m3u8, link_embed, link_video });
                                episodeCount++;
                            }

                            if (lines[j].includes('ophim1.com')) {
                                apiSource = 'ophim1';
                                apiUrl = lines[j];
                                slug = lines[j].split('/').pop();
                            } else if (lines[j].includes('phimapi.com')) {
                                apiSource = 'phimapi';
                                apiUrl = lines[j];
                                slug = lines[j].split('/').pop();
                            } else if (lines[j].includes('phim.nguonc.com')) {
                                apiSource = 'phimnguonc';
                                apiUrl = lines[j];
                                slug = lines[j].split('/').pop();
                            }
                        }

                        if (episodes.length === 0) {
                            episodes.push({ name: 'Tập 1', link_m3u8: '', link_embed: '', link_video: '' });
                            episodeCount = 1;
                        }

                        movies.push({
                            pageTag,
                            name: movieName,
                            slug,
                            poster_url: posterUrl && posterUrl.startsWith('http') ? posterUrl : DEFAULT_POSTER,
                            quality: quality || 'HD',
                            content: 'Nội dung không có trong thư viện',
                            actors: 'Không có thông tin',
                            directors: 'Không có thông tin',
                            countries: 'Không rõ',
                            categories: pageTag || 'Không rõ',
                            year: 'Không rõ',
                            time: 'Không rõ',
                            lang: normalizeLanguage(quality),
                            origin_name: movieName || 'Không có',
                            status: episodeCount > 1 ? `Hoàn tất (${episodeCount}/${episodeCount})` : 'Hoàn tất',
                            episodes,
                            episode_total: episodeCount || 1,
                            type: episodeCount > 1 ? 'series' : 'movie',
                            apiSource,
                            apiUrl,
                            servers: [{
                                server_name: 'Server Custom',
                                server_data: episodes
                            }]
                        });
                        i += episodes.length;
                    }
                }

                console.log(`Loaded ${movies.length} movies from ${file}`);
                return movies;
            } catch (error) {
                console.error(`Lỗi khi tải ${file}:`, error);
                showErrorToast(`Không thể tải file ${file}`);
                return [];
            }
        }

        // Normalize Language
        function normalizeLanguage(quality) {
            if (!quality) return 'Vietsub';
            quality = quality.toLowerCase();
            if (quality.includes('thuyết minh') || quality.includes('thuyet minh') || quality.includes('tm')) return 'Thuyết Minh';
            if (quality.includes('lồng tiếng') || quality.includes('long tieng') || quality.includes('lt')) return 'Lồng Tiếng';
            return 'Vietsub';
        }

        // Parse Episode Total
        function parseEpisodeTotal(total, current, episodes) {
            if (total && !isNaN(parseInt(total))) return parseInt(total);
            if (current && current.includes('/')) {
                const totalMatch = current.split('/')[1]?.match(/\d+/);
                if (totalMatch) return parseInt(totalMatch[0]);
            }
            return episodes?.length || 1;
        }

        // Determine Movie Type
        function determineMovieType(total, current, episodes) {
            if (total && parseInt(total) > 1) return 'series';
            if (current && current.includes('/')) {
                const totalMatch = current.split('/')[1]?.match(/\d+/);
                if (totalMatch && parseInt(totalMatch[0]) > 1) return 'series';
            }
            return episodes?.length > 1 ? 'series' : 'movie';
        }

        // Determine Language
        function determineLanguage(movie) {
            return movie.lang || movie.language || normalizeLanguage(movie.quality);
        }

        // Normalize Movie Data
        function normalizeMovieData(data, apiSource) {
            console.log(`Normalizing data for ${apiSource}:`, data);
            const movie = data.movie || data;
            let categories = [];
            let countries = [];
            let year = movie.year || 'Không rõ';
            let episodes = [];
            let servers = [];

            if (apiSource === 'ophim1' || apiSource === 'phimapi') {
                categories = Array.isArray(movie.category) ? movie.category.map(c => c.name || 'Không rõ') : [];
                countries = Array.isArray(movie.country) ? movie.country.map(c => c.name || 'Không rõ') : [];
                servers = Array.isArray(data.episodes) ? data.episodes.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: Array.isArray(server.server_data) ? server.server_data.map(ep => ({
                        name: (ep.name || 'Tập 1').replace('Tập ', '').trim(),
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    })) : []
                })) : [];
            } else if (apiSource === 'phimnguonc') {
                if (movie.category && typeof movie.category === 'object') {
                    Object.values(movie.category).forEach(group => {
                        if (group && group.group && group.group.name === 'Thể loại' && Array.isArray(group.list)) {
                            categories = group.list.map(item => item.name || 'Không rõ');
                        } else if (group && group.group && group.group.name === 'Quốc gia' && Array.isArray(group.list)) {
                            countries = group.list.map(item => item.name || 'Không rõ');
                        } else if (group && group.group && group.group.name === 'Năm' && Array.isArray(group.list)) {
                            year = group.list[0]?.name || 'Không rõ';
                        }
                    });
                }
                servers = Array.isArray(data.episodes) ? data.episodes.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: Array.isArray(server.items) ? server.items.map(ep => ({
                        name: (ep.name || 'Tập 1').replace('Tập ', '').trim(),
                        link_m3u8: ep.m3u8 || '',
                        link_embed: ep.embed || '',
                        link_video: ep.video || ''
                    })) : []
                })) : [];
            } else if (apiSource === 'custom') {
                categories = movie.categories ? [movie.categories] : ['Không rõ'];
                countries = movie.countries ? [movie.countries] : ['Không rõ'];
                servers = Array.isArray(movie.episodes) && movie.episodes.length > 0 ? [{
                    server_name: 'Server Custom',
                    server_data: movie.episodes.map(ep => ({
                        name: ep.name || 'Tập 1',
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    }))
                }] : [{
                    server_name: 'Server Custom',
                    server_data: [{ name: 'Tập 1', link_m3u8: '', link_embed: '', link_video: '' }]
                }];
            }

            episodes = servers.flatMap(server => Array.isArray(server.server_data) ? server.server_data : []);
            if (episodes.length === 0) {
                episodes = [{ name: 'Tập 1', link_m3u8: '', link_embed: '', link_video: '' }];
            }

            const episodeTotal = parseEpisodeTotal(movie.total_episodes, movie.current_episode || movie.status, episodes);
            const type = movie.type || determineMovieType(movie.total_episodes, movie.current_episode || movie.status, episodes);
            const lang = determineLanguage(movie);

            const normalized = {
                id: movie.id || movie._id || `id-${Date.now()}`,
                name: movie.name || 'Không có tên',
                slug: movie.slug || `slug-${Date.now()}`,
                origin_name: movie.original_name || movie.origin_name || 'Không có',
                poster_url: movie.poster_url || movie.thumb_url || DEFAULT_POSTER,
                content: movie.description || movie.content || 'Không có nội dung',
                type,
                status: movie.current_episode || movie.status || 'unknown',
                episode_total: episodeTotal,
                time: movie.time || 'Không rõ',
                quality: movie.quality || 'HD',
                lang,
                year,
                actors: Array.isArray(movie.casts) && movie.casts.length ? movie.casts.join(', ') : (typeof movie.casts === 'string' ? movie.casts : (movie.actor || 'Không có thông tin')),
                directors: Array.isArray(movie.director) && movie.director.length ? movie.director.join(', ') : (typeof movie.director === 'string' ? movie.director : (movie.director || 'Không có thông tin')),
                categories: categories.join(', ') || 'Không rõ',
                countries: countries.join(', ') || 'Không rõ',
                episodes,
                servers,
                apiSource,
                apiUrl: data.apiUrl || null
            };
            console.log(`Normalized movie data for ${apiSource}:`, normalized);
            return normalized;
        }

        // Fetch Movie Data
        async function fetchMovieData(url, apiSource, retries = 3) {
            console.log(`Fetching data from ${url} (Source: ${apiSource})`);
            try {
                const response = await fetchWithTimeout(url, { mode: 'cors', cache: 'no-store' }, 15000);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Raw API response from ${url}:`, data);
                if ((data.status === true || data.status === 'success') && data.movie) {
                    const normalizedData = normalizeMovieData({ ...data, apiUrl: url }, apiSource);
                    console.log(`Normalized data from ${url}:`, normalizedData);
                    return normalizedData;
                }
                console.warn(`Dữ liệu không hợp lệ từ ${url}`);
                return null;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Thử lại ${url}, còn ${retries} lần. Lỗi:`, error.message);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return fetchMovieData(url, apiSource, retries - 1);
                }
                console.error(`Lỗi khi tải dữ liệu từ ${url}:`, error);
                showErrorToast(`Không thể tải dữ liệu từ ${apiSource}`);
                return null;
            }
        }

        // Process API Queue
        async function processApiQueue(urls, limit = 5) {
            console.log('Processing API queue with URLs:', urls);
            const results = [];
            const queue = [...urls];
            const active = new Set();

            async function processNext() {
                if (queue.length === 0 && active.size === 0) return;
                while (active.size < limit && queue.length > 0) {
                    const url = queue.shift();
                    if (!url || typeof url !== 'string') {
                        console.warn('URL không hợp lệ:', url);
                        continue;
                    }
                    active.add(url);
                    const apiSource = url.includes('ophim1.com') ? 'ophim1' : url.includes('phimapi.com') ? 'phimapi' : 'phimnguonc';
                    console.log(`Queue processing: ${url} (${apiSource})`);
                    fetchMovieData(url, apiSource).then(data => {
                        if (data) {
                            console.log(`Successfully fetched movie from ${url}:`, data.name);
                            results.push(data);
                        } else {
                            console.warn(`No valid data from ${url}`);
                        }
                        active.delete(url);
                        return processNext();
                    }).catch(error => {
                        console.error(`Error processing ${url}:`, error);
                        active.delete(url);
                        processNext();
                    });
                }
            }

            await Promise.all(Array(limit).fill().map(() => processNext()));
            console.log(`Processed ${results.length} movies from API queue`);
            return results.filter(movie => movie !== null);
        }

        // Render Movie Item
        async function renderMovieItem(movie, container) {
            if (!movie || typeof movie !== 'object' || !movie.name || !movie.poster_url) {
                console.warn('Dữ liệu phim không hợp lệ:', movie);
                return null;
            }

            console.log(`Rendering movie: ${movie.name} (${movie.apiSource})`);

            movie.apiSource = movie.apiSource || 'custom';
            movie.slug = movie.slug || (movie.name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-') || `custom-${Date.now()}`);
            movie.poster_url = movie.poster_url && movie.poster_url.startsWith('http') ? movie.poster_url : DEFAULT_POSTER;
            movie.episodes = Array.isArray(movie.episodes) && movie.episodes.length > 0 ? movie.episodes : [{ name: 'Tập 1', link_m3u8: '', link_embed: '', link_video: '' }];
            movie.servers = Array.isArray(movie.servers) && movie.servers.length > 0 ? movie.servers : [{ server_name: 'Server Custom', server_data: movie.episodes }];

            const detailUrlBase = `detail.html?slug=${encodeURIComponent(movie.slug)}&apiSource=${encodeURIComponent(movie.apiSource)}&name=${encodeURIComponent(movie.name || '')}&episodes=${encodeURIComponent(JSON.stringify(movie.episodes))}&poster=${encodeURIComponent(movie.poster_url)}&quality=${encodeURIComponent(movie.quality)}&content=${encodeURIComponent(movie.content)}&actors=${encodeURIComponent(movie.actors)}&directors=${encodeURIComponent(movie.directors)}&countries=${encodeURIComponent(movie.countries)}&categories=${encodeURIComponent(movie.categories)}&year=${encodeURIComponent(movie.year)}&time=${encodeURIComponent(movie.time)}&lang=${encodeURIComponent(movie.lang)}&origin_name=${encodeURIComponent(movie.origin_name)}&status=${encodeURIComponent(movie.status)}&episode_total=${encodeURIComponent(movie.episode_total)}&type=${encodeURIComponent(movie.type)}`;
            const detailUrl = await checkFileExists('detail.html') ? detailUrlBase : 'javascript:void(0)';

            const lang = movie.lang || 'Vietsub';
            let langText = 'VS';
            if (lang.toLowerCase().includes('thuyết minh') || lang.toLowerCase().includes('thuyet minh') || lang.toLowerCase().includes('tm')) {
                langText = 'TM';
            } else if (lang.toLowerCase().includes('lồng tiếng') || lang.toLowerCase().includes('long tieng') || lang.toLowerCase().includes('lt')) {
                langText = 'LT';
            }
            const langBadge = langText === 'VS' ? langText : `<i class="fas fa-check check-icon"></i> ${langText}`;
            const episodeDisplay = `${movie.episode_total || 1} tập`;

            const movieItem = document.createElement('div');
            movieItem.classList.add('movie-item');
            movieItem.innerHTML = `
                <div class="movie-poster">
                    <a href="${detailUrl}" onclick="${detailUrl === 'javascript:void(0)' ? 'alert(\"Trang chi tiết không khả dụng!\"); return false;' : ''}">
                        <img data-src="${movie.poster_url}" alt="${movie.name || 'Phim không tên'}" class="lazy" loading="lazy" onerror="this.src='${DEFAULT_POSTER}'; console.warn('Poster failed to load: ${movie.poster_url}');">
                        <span class="episode-badge">${episodeDisplay} | ${langBadge}</span>
                        <div class="movie-overlay">
                            <p>${movie.content || 'Không có nội dung'}</p>
                        </div>
                    </a>
                </div>
                <a href="${detailUrl}" class="movie-title" onclick="${detailUrl === 'javascript:void(0)' ? 'alert(\"Trang chi tiết không khả dụng!\"); return false;' : ''}">${movie.name || 'Phim không tên'} (${movie.quality || 'HD'})</a>
            `;
            return movieItem;
        }

        // Show Skeleton Loading
        function showSkeleton(container) {
            container.innerHTML = Array(8).fill().map(() => `
                <div class="movie-item">
                    <div class="movie-poster skeleton">
                        <img data-src="${DEFAULT_POSTER}" alt="Loading" class="lazy">
                    </div>
                    <a href="#" class="movie-title">Đang tải...</a>
                </div>
            `).join('');
            observeImages();
        }

        // Observe Images
        function observeImages() {
            const images = document.querySelectorAll('.movie-poster img');
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const parent = img.closest('.movie-poster');
                            img.src = img.dataset.src;
                            img.onload = () => {
                                img.classList.add('loaded');
                                parent.classList.remove('skeleton');
                            };
                            img.onerror = () => {
                                console.error(`Không thể tải ảnh: ${img.dataset.src}`);
                                img.src = DEFAULT_POSTER;
                                img.classList.add('loaded');
                                parent.classList.remove('skeleton');
                            };
                            observer.unobserve(img);
                        }
                    });
                }, { threshold: 0.2 });
                images.forEach(img => {
                    img.closest('.movie-poster').classList.add('skeleton');
                    observer.observe(img);
                });
            } else {
                images.forEach(img => {
                    const parent = img.closest('.movie-poster');
                    img.src = img.dataset.src;
                    img.onload = () => {
                        img.classList.add('loaded');
                        parent.classList.remove('skeleton');
                    };
                    img.onerror = () => {
                        console.error(`Không thể tải ảnh: ${img.dataset.src}`);
                        img.src = DEFAULT_POSTER;
                        img.classList.add('loaded');
                        parent.classList.remove('skeleton');
                    };
                    parent.classList.add('skeleton');
                });
            }
        }

        // Render Movies
        async function renderMovies(apiUrls, customMovies, seriesMovies, singleMovies, searchTerm = '') {
            console.log('Rendering movies with:', { apiUrls, customMovies, seriesMovies, singleMovies, searchTerm });
            const allMovies = [...customMovies, ...seriesMovies, ...singleMovies];
            let filteredMovies = searchTerm
                ? allMovies.filter(movie => movie.name.toLowerCase().includes(searchTerm.toLowerCase()))
                : allMovies;

            if (apiUrls.length > 0) {
                console.log('Fetching API movies...');
                const apiMovies = await processApiQueue(apiUrls);
                console.log(`Fetched ${apiMovies.length} API movies:`, apiMovies);
                filteredMovies = filteredMovies.concat(
                    searchTerm
                        ? apiMovies.filter(movie => movie.name.toLowerCase().includes(searchTerm.toLowerCase()))
                        : apiMovies
                );
            } else {
                console.log('No API URLs to fetch.');
            }

            console.log(`Total filtered movies: ${filteredMovies.length}`);
            if (filteredMovies.length === 0) {
                elements.recommendedList.innerHTML = '<p class="error-message">Không tìm thấy phim nào.</p>';
                showErrorToast('Không tìm thấy phim phù hợp');
                return;
            }

            const fragment = document.createDocumentFragment();
            for (const movie of filteredMovies) {
                const movieItem = await renderMovieItem(movie, elements.recommendedList);
                if (movieItem) {
                    fragment.appendChild(movieItem);
                } else {
                    console.warn(`Failed to render movie: ${movie.name}`);
                }
            }

            elements.recommendedList.innerHTML = '';
            elements.recommendedList.appendChild(fragment);
            observeImages();
            console.log('Movies rendered successfully');
        }

        // Adjust Main Content Padding
        function adjustMainContentPadding() {
            const headerHeight = document.querySelector('.header').offsetHeight;
            document.querySelector('.main-content').style.paddingTop = `${headerHeight + 20}px`;
        }

        // Highlight Active Menu
        function highlightActiveMenu() {
            const navLinks = document.querySelectorAll('.nav-menu a');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === 'truyen-hinh.html') {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // Search Functionality
        elements.searchInput.addEventListener('input', async () => {
            const searchTerm = elements.searchInput.value.trim();
            elements.clearSearch.classList.toggle('visible', searchTerm.length > 0);

            if (!searchTerm) {
                elements.searchSuggestions.classList.remove('visible');
                elements.searchSuggestions.innerHTML = '';
                await renderMovies(allApiUrls, customMovies, seriesMovies, singleMovies);
                return;
            }

            const allMovies = [...customMovies, ...seriesMovies, ...singleMovies];
            const apiMovies = await processApiQueue(allApiUrls, 3);
            allMovies.push(...apiMovies);

            const suggestions = allMovies
                .filter(movie => movie.name.toLowerCase().includes(searchTerm.toLowerCase()))
                .slice(0, 5)
                .map(movie => ({
                    name: movie.name,
                    url: `detail.html?slug=${encodeURIComponent(movie.slug)}&apiSource=${encodeURIComponent(movie.apiSource)}&name=${encodeURIComponent(movie.name || '')}&episodes=${encodeURIComponent(JSON.stringify(movie.episodes))}&poster=${encodeURIComponent(movie.poster_url)}&quality=${encodeURIComponent(movie.quality)}&content=${encodeURIComponent(movie.content)}&actors=${encodeURIComponent(movie.actors)}&directors=${encodeURIComponent(movie.directors)}&countries=${encodeURIComponent(movie.countries)}&categories=${encodeURIComponent(movie.categories)}&year=${encodeURIComponent(movie.year)}&time=${encodeURIComponent(movie.time)}&lang=${encodeURIComponent(movie.lang)}&origin_name=${encodeURIComponent(movie.origin_name)}&status=${encodeURIComponent(movie.status)}&episode_total=${encodeURIComponent(movie.episode_total)}&type=${encodeURIComponent(movie.type)}`
                }));

            elements.searchSuggestions.innerHTML = suggestions.length > 0
                ? suggestions.map(s => `<div onclick="window.location.href='${s.url}'">${s.name}</div>`).join('')
                : '<div>Không tìm thấy kết quả</div>';
            elements.searchSuggestions.classList.toggle('visible', suggestions.length > 0);

            await renderMovies(allApiUrls, customMovies, seriesMovies, singleMovies, searchTerm);
        });

        elements.searchInput.addEventListener('keypress', async e => {
            if (e.key === 'Enter') {
                const searchTerm = elements.searchInput.value.trim();
                if (searchTerm) {
                    elements.searchSuggestions.classList.remove('visible');
                    await renderMovies(allApiUrls, customMovies, seriesMovies, singleMovies, searchTerm);
                }
            }
        });

        elements.clearSearch.addEventListener('click', async () => {
            elements.searchInput.value = '';
            elements.clearSearch.classList.remove('visible');
            elements.searchSuggestions.classList.remove('visible');
            await renderMovies(allApiUrls, customMovies, seriesMovies, singleMovies);
        });

        // Initialize
        async function initialize() {
            try {
                console.log('Initializing page...');
                if (!(await checkFileExists('detail.html'))) {
                    console.error('Trang detail.html không tồn tại');
                    showErrorToast('Trang chi tiết không khả dụng. Vui lòng kiểm tra file detail.html');
                }

                showSkeleton(elements.recommendedList);
                elements.loadingSpinner.classList.add('visible');

                const [apiUrls, customMoviesData, seriesMoviesData, singleMoviesData] = await Promise.all([
                    loadApiUrls(),
                    loadCustomMovies('customapi.txt'),
                    loadCustomMovies('bo.txt'),
                    loadCustomMovies('le.txt')
                ]);

                allApiUrls = Array.isArray(apiUrls) ? apiUrls : [];
                customMovies = Array.isArray(customMoviesData) ? customMoviesData.filter(m => m.pageTag === currentPage) : [];
                seriesMovies = Array.isArray(seriesMoviesData) ? seriesMoviesData.filter(m => m.pageTag === currentPage) : [];
                singleMovies = Array.isArray(singleMoviesData) ? singleMoviesData.filter(m => m.pageTag === currentPage) : [];

                console.log('Initialization data:', {
                    apiUrls: allApiUrls.length,
                    customMovies: customMovies.length,
                    seriesMovies: seriesMovies.length,
                    singleMovies: singleMovies.length
                });

                const urlParams = new URLSearchParams(window.location.search);
                const searchTerm = urlParams.get('search') || '';
                elements.searchInput.value = searchTerm;
                elements.clearSearch.classList.toggle('visible', searchTerm.length > 0);

                await renderMovies(allApiUrls, customMovies, seriesMovies, singleMovies, searchTerm);

                adjustMainContentPadding();
                highlightActiveMenu();
            } catch (error) {
                console.error('Lỗi khi khởi tạo dữ liệu:', error);
                elements.recommendedList.innerHTML = '<p class="error-message">Lỗi tải dữ liệu phim. Vui lòng thử lại.</p>';
                showErrorToast('Không thể tải dữ liệu phim');
            } finally {
                isLoading = false;
                elements.loadingSpinner.classList.remove('visible');
            }
        }

        initialize();
        window.addEventListener('resize', adjustMainContentPadding);
    </script>
</body>
</html>