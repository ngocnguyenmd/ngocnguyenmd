<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Phim Hay - Xem chi tiết phim online miễn phí, chất lượng cao">
    <meta name="keywords" content="phim truyền hình, phim bộ, phim lẻ, xem phim online, phim chất lượng cao">
    <meta name="author" content="Phim Hay">
    <title>Phim Hay - Chi Tiết Phim</title>
    <link rel="icon" href="" type="image/png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #e50914;
            --lprimary-hover: #b20710;
            --bg-dark: #181818;
            --bg-section: #222;
            --text-white: #fff;
            --text-gray: #b3b3b3;
            --accent-color: #00aaff;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --green-check: #28a745;
        }

        [data-theme="light"] {
            --bg-dark: #f4f4f4;
            --bg-section: #e0e0e0;
            --text-white: #333;
            --text-gray: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-dark);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            max-height: 50px;
        }

        .nav-menu a {
            color: var(--text-white);
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 5px;
            margin-left: 10px;
            transition: var(--transition);
        }

        .nav-menu a:hover {
            background-color: var(--primary-hover);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            flex: 1;
        }

        .movie-detail {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .movie-poster img {
            width: 300px;
            height: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            object-fit: cover;
        }

        .movie-info {
            flex: 1;
            min-width: 300px;
        }

        .movie-info h1 {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .movie-info p {
            margin-bottom: 10px;
            color: var(--text-gray);
        }

        .movie-info strong {
            color: var(--text-white);
        }

        .episode-list {
            margin-top: 20px;
        }

        .episode-list h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .episode-item {
            background: var(--bg-section);
            padding: 10px;
            text-align: center;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .episode-item:hover {
            background: var(--primary-color);
            color: var(--text-white);
        }

        .video-player {
            margin-top: 20px;
        }

        .video-player iframe,
        .video-player video {
            width: 100%;
            max-height: 500px;
            border-radius: var(--border-radius);
        }

        .error-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #d32f2f;
            color: #fff;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 2000;
            display: none;
        }

        .error-toast.visible {
            display: block;
            animation: slideUp 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        @media (max-width: specimen {
            .movie-detail {
                flex-direction: column;
            }

            .movie-poster img {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://www.freeiconspng.com/uploads/star-icon-11.png" alt="Phim Hay" class="logo" onerror="this.src='https://placehold.co/50x50';">
            <div class="nav-menu">
                <a href="index.html">Trang chủ</a>
                <a href="truyen-hinh.html">Truyền hình</a>
            </div>
        </div>
    </header>
    <div class="error-toast" id="error-toast"></div>
    <main class="main-content">
        <div class="movie-detail" id="movie-detail">
            <div class="movie-poster">
                <img id="poster" src="https://placehold.co/300x450" alt="Phim">
            </div>
            <div class="movie-info">
                <h1 id="title">Đang tải...</h1>
                <p><strong>Thể loại:</strong> <span id="categories">Đang tải...</span></p>
                <p><strong>Quốc gia:</strong> <span id="countries">Đang tải...</span></p>
                <p><strong>Năm:</strong> <span id="year">Đang tải...</span></p>
                <p><strong>Đạo diễn:</strong> <span id="directors">Đang tải...</span></p>
                <p><strong>Diễn viên:</strong> <span id="actors">Đang tải...</span></p>
                <p><strong>Chất lượng:</strong> <span id="quality">Đang tải...</span></p>
                <p><strong>Ngôn ngữ:</strong> <span id="lang">Đang tải...</span></p>
                <p><strong>Trạng thái:</strong> <span id="status">Đang tải...</span></p>
                <p><strong>Nội dung:</strong> <span id="content">Đang tải...</span></p>
            </div>
        </div>
        <div class="episode-list" id="episode-list">
            <h2>Danh sách tập</h2>
            <div class="episode-grid" id="episode-grid"></div>
        </div>
        <div class="video-player" id="video-player"></div>
    </main>
    <script>
        const elements = {
            poster: document.getElementById('poster'),
            title: document.getElementById('title'),
            categories: document.getElementById('categories'),
            countries: document.getElementById('countries'),
            year: document.getElementById('year'),
            directors: document.getElementById('directors'),
            actors: document.getElementById('actors'),
            quality: document.getElementById('quality'),
            lang: document.getElementById('lang'),
            status: document.getElementById('status'),
            content: document.getElementById('content'),
            episodeGrid: document.getElementById('episode-grid'),
            videoPlayer: document.getElementById('video-player'),
            errorToast: document.getElementById('error-toast')
        };

        const DEFAULT_POSTER = 'https://placehold.co/300x450';
        const FETCH_TIMEOUT = 10000;

        function showErrorToast(message) {
            elements.errorToast.textContent = message;
            elements.errorToast.classList.add('visible');
            setTimeout(() => elements.errorToast.classList.remove('visible'), 3000);
        }

        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), FETCH_TIMEOUT);
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        function normalizeLanguage(lang) {
            if (!lang) return 'Vietsub';
            const lower = lang.toLowerCase().trim();
            if (lower.includes('thuyết minh') || lower.includes('thuyet minh') || lower.includes('tm')) return 'Thuyết Minh';
            if (lower.includes('lồng tiếng') || lower.includes('long tieng') || lower.includes('lt')) return 'Lồng Tiếng';
            return 'Vietsub';
        }

        async function loadMovieDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            const apiSource = urlParams.get('apiSource');
            const name = urlParams.get('name');

            if (!slug || !apiSource) {
                showErrorToast('Thiếu thông tin phim!');
                return;
            }

            const movieKey = `movie_${slug}_${apiSource}`;
            let movie = null;

            // Kiểm tra localStorage trước
            try {
                const storedMovie = localStorage.getItem(movieKey);
                if (storedMovie) {
                    movie = JSON.parse(storedMovie);
                }
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu từ localStorage:', error);
            }

            // Nếu không có dữ liệu trong localStorage và có apiUrl, fetch từ API
            if (!movie && apiSource !== 'custom' && movie?.apiUrl) {
                try {
                    const response = await fetchWithTimeout(movie.apiUrl, { mode: 'cors', cache: 'no-store' });
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    const data = await response.json();
                    if (data && data.movie && (data.status === true || data.status === 'success')) {
                        movie = {
                            id: data.movie.id || data.movie._id || `id-${Date.now()}`,
                            name: data.movie.name || name || 'Không có tên',
                            slug: data.movie.slug || slug,
                            origin_name: data.movie.original_name || data.movie.origin_name || 'Không có',
                            poster_url: data.movie.poster_url || data.movie.thumb_url || DEFAULT_POSTER,
                            content: data.movie.description || data.movie.content || 'Không có nội dung',
                            type: data.movie.type || (data.movie.total_episodes > 1 ? 'series' : 'movie'),
                            status: data.movie.current_episode || data.movie.status || 'unknown',
                            episode_total: data.movie.total_episodes || data.episodes?.length || 1,
                            time: data.movie.time || 'Không rõ',
                            quality: data.movie.quality || 'HD',
                            lang: normalizeLanguage(data.movie.language || data.movie.lang || data.movie.sub_docquyen || data.movie.status || data.movie.quality),
                            year: data.movie.year || 'Không rõ',
                            actors: Array.isArray(data.movie.casts) && data.movie.casts.length ? data.movie.casts.join(', ') : (typeof data.movie.casts === 'string' ? data.movie.casts : (data.movie.actor || 'Không có thông tin')),
                            directors: Array.isArray(data.movie.director) && data.movie.director.length ? data.movie.director.join(', ') : (typeof data.movie.director === 'string' ? data.movie.director : (data.movie.director || 'Không có thông tin')),
                            categories: Array.isArray(data.movie.category) ? data.movie.category.map(c => c.name || 'Không rõ').join(', ') : 'Không rõ',
                            countries: Array.isArray(data.movie.country) ? data.movie.country.map(c => c.name || 'Không rõ').join(', ') : 'Không rõ',
                            episodes: data.episodes?.flatMap(server => Array.isArray(server.server_data) ? server.server_data.map(ep => ({
                                name: (ep.name || 'Tập 1').replace('Tập ', '').trim(),
                                link_m3u8: ep.link_m3u8 || '',
                                link_embed: ep.link_embed || '',
                                link_video: ep.link_video || ''
                            })) : []) || [],
                            servers: Array.isArray(data.episodes) ? data.episodes.map((server, index) => ({
                                server_name: server.server_name || `Server ${index + 1}`,
                                server_data: Array.isArray(server.server_data) ? server.server_data : []
                            })) : [],
                            apiSource,
                            apiUrl: data.apiUrl || null
                        };
                    }
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu API:', error);
                    showErrorToast('Không thể tải chi tiết phim từ API');
                }
            }

            if (!movie) {
                showErrorToast('Không tìm thấy thông tin phim!');
                return;
            }

            // Hiển thị thông tin phim
            elements.poster.src = movie.poster_url || DEFAULT_POSTER;
            elements.poster.onerror = () => { elements.poster.src = DEFAULT_POSTER; };
            elements.title.textContent = movie.name || 'Không có tên';
            elements.categories.textContent = movie.categories || 'Không rõ';
            elements.countries.textContent = movie.countries || 'Không rõ';
            elements.year.textContent = movie.year || 'Không rõ';
            elements.directors.textContent = movie.directors || 'Không có thông tin';
            elements.actors.textContent = movie.actors || 'Không có thông tin';
            elements.quality.textContent = movie.quality || 'HD';
            elements.lang.textContent = movie.lang || 'Vietsub';
            elements.status.textContent = movie.status || 'Không rõ';
            elements.content.textContent = movie.content || 'Không có nội dung';

            // Hiển thị danh sách tập
            if (movie.episodes && movie.episodes.length > 0) {
                const fragment = document.createDocumentFragment();
                movie.episodes.forEach((episode, index) => {
                    const episodeItem = document.createElement('div');
                    episodeItem.classList.add('episode-item');
                    episodeItem.textContent = episode.name || `Tập ${index + 1}`;
                    episodeItem.addEventListener('click', () => playEpisode(episode));
                    fragment.appendChild(episodeItem);
                });
                elements.episodeGrid.appendChild(fragment);

                // Phát tập đầu tiên mặc định
                playEpisode(movie.episodes[0]);
            } else {
                elements.episodeGrid.innerHTML = '<p>Không có tập nào.</p>';
            }
        }

        function playEpisode(episode) {
            if (!episode) {
                showErrorToast('Không có link phát!');
                return;
            }

            const link = episode.link_m3u8 || episode.link_embed || episode.link_video || '';
            if (!link) {
                showErrorToast('Link phát không hợp lệ!');
                return;
            }

            elements.videoPlayer.innerHTML = '';
            if (link.endsWith('.m3u8')) {
                // Sử dụng video.js hoặc hls.js để phát m3u8
                const video = document.createElement('video');
                video.classList.add('video-js');
                video.controls = true;
                elements.videoPlayer.appendChild(video);

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(link);
                    hls.attachMedia(video);
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = link;
                } else {
                    showErrorToast('Trình duyệt không hỗ trợ phát HLS!');
                }
            } else if (link.includes('youtube.com') || link.includes('vimeo.com') || link.includes('drive.google.com')) {
                const iframe = document.createElement('iframe');
                iframe.src = link;
                iframe.allow = 'autoplay; fullscreen';
                iframe.frameborder = '0';
                elements.videoPlayer.appendChild(iframe);
            } else {
                const video = document.createElement('video');
                video.controls = true;
                video.src = link;
                elements.videoPlayer.appendChild(video);
            }
        }

        // Load thư viện HLS nếu cần
        const hlsScript = document.createElement('script');
        hlsScript.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
        hlsScript.onload = loadMovieDetails;
        hlsScript.onerror = () => {
            console.error('Không thể tải HLS.js');
            loadMovieDetails();
        };
        document.head.appendChild(hlsScript);
    </script>
</body>
</html>