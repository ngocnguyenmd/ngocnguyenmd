<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Phim Hay - Chi tiết phim">
    <meta name="keywords" content="phim Hàn, phim bộ, phim lẻ, xem phim online">
    <meta name="author" content="Phim Hay">
    <title>Phim Hay - Chi tiết phim</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --primary-color: #ff1a1a;
            --primary-hover: #cc0000;
            --bg-dark: #141414;
            --bg-section: #221F1F;
            --text-gray: #B3B3B3;
            --text-white: #FFF;
            --active-bg: #000;
            --active-text: #FFF;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: pan-x pan-y;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-dark);
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            flex-wrap: wrap;
        }

        .logo {
            max-height: 45px;
            flex-shrink: 0;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .nav-menu a {
            color: var(--text-white);
            text-decoration: none;
            font-size: 1.1em;
            padding: 10px 15px;
            transition: color 0.3s ease;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            flex: 1;
        }

        .movie-detail {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .movie-poster {
            flex: 0 0 300px;
            max-width: 100%;
        }

        .movie-poster img {
            width: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        .movie-info {
            flex: 1;
            min-width: 300px;
        }

        .movie-info h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .movie-info p {
            font-size: 1.1em;
            color: var(--text-gray);
            margin-bottom: 10px;
        }

        .movie-info strong {
            color: var(--text-white);
        }

        .watch-btn {
            display: inline-block;
            background: var(--primary-color);
            color: var(--text-white);
            padding: 12px 24px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 1.2em;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .watch-btn:hover {
            background: var(--primary-hover);
        }

        .episode-list {
            margin-top: 40px;
        }

        .episode-list h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: center;
        }

        .episode-list h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: var(--text-white);
        }

        .episode-list ul {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .episode-list li {
            list-style: none;
            flex: 0 0 auto;
        }

        .episode-list a {
            display: inline-block;
            padding: 12px 18px;
            background: var(--primary-color);
            color: var(--text-white);
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s ease;
            font-size: 1.1em;
            min-width: 70px;
            text-align: center;
        }

        .episode-list a:hover {
            background: var(--primary-hover);
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            font-size: 1.2em;
            margin: 20px 0;
        }

        footer {
            background: var(--bg-section);
            padding: 20px;
            text-align: center;
        }

        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .footer-btn {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background 0.3s ease;
        }

        .footer-btn:hover {
            background: var(--primary-hover);
        }

        @media (max-width: 1024px) {
            .movie-detail {
                flex-direction: column;
                align-items: center;
            }

            .movie-poster {
                flex: 0 0 100%;
                max-width: 400px;
            }

            .movie-info h1 {
                font-size: 2em;
            }

            .watch-btn {
                font-size: 1.1em;
                padding: 10px 20px;
            }

            .episode-list a {
                padding: 10px 15px;
                font-size: 1em;
                min-width: 60px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }

            .header-content {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .logo {
                max-height: 40px;
            }

            .nav-menu {
                gap: 10px;
                justify-content: center;
            }

            .nav-menu a {
                font-size: 1em;
                padding: 8px 12px;
            }

            .main-content {
                padding: 100px 15px 30px;
            }

            .movie-info h1 {
                font-size: 1.8em;
            }

            .movie-info p {
                font-size: 1em;
            }

            .watch-btn {
                font-size: 1em;
                padding: 8px 16px;
            }

            .episode-list a {
                padding: 8px 12px;
                font-size: 0.95em;
                min-width: 50px;
            }
        }

        @media (max-width: 600px) {
            .header {
                padding: 8px 10px;
            }

            .logo {
                max-height: 35px;
            }

            .nav-menu a {
                font-size: 0.9em;
                padding: 6px 10px;
            }

            .main-content {
                padding: 120px 10px 20px;
            }

            .movie-poster {
                max-width: 300px;
            }

            .movie-info h1 {
                font-size: 1.5em;
            }

            .movie-info p {
                font-size: 0.95em;
            }

            .watch-btn {
                font-size: 0.95em;
                padding: 6px 12px;
            }

            .episode-list a {
                padding: 6px 10px;
                font-size: 0.9em;
                min-width: 45px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img src="https://pngimg.com/d/free_PNG90750.png" alt="Phim Hay" class="logo">
            <div class="nav-menu">
                <a href="index.html">Trang chủ</a>
                <a href="phim-han.html">Phim Hàn</a>
                <a href="phim-trung.html">Phim Trung</a>
                <a href="phim-viet.html">Phim Việt</a>
                <a href="phim-my.html">Phim Mỹ</a>
                <a href="truyen-hinh.html">Truyền hình</a>
                <a href="hoat-hinh.html">Hoạt hình</a>
                <a href="khac.html">Khác</a>
            </div>
        </div>
    </header>
    <main class="main-content">
        <section class="movie-detail">
            <div class="movie-poster">
                <img id="movie-poster" src="poster-not-found.jpg" alt="Poster phim">
            </div>
            <div class="movie-info">
                <h1 id="movie-title">Đang tải...</h1>
                <p><strong>Mô tả:</strong> <span id="movie-description">Đang tải...</span></p>
                <p><strong>Tên gốc:</strong> <span id="movie-origin-name">Đang tải...</span></p>
                <p><strong>Đạo diễn:</strong> <span id="movie-directors">Đang tải...</span></p>
                <p><strong>Diễn viên:</strong> <span id="movie-actors">Đang tải...</span></p>
                <p><strong>Thể loại:</strong> <span id="movie-categories">Đang tải...</span></p>
                <p><strong>Quốc gia:</strong> <span id="movie-countries">Đang tải...</span></p>
                <p><strong>Năm:</strong> <span id="movie-year">Đang tải...</span></p>
                <p><strong>Thời lượng:</strong> <span id="movie-time">Đang tải...</span></p>
                <p><strong>Chất lượng:</strong> <span id="movie-quality">Đang tải...</span></p>
                <p><strong>Ngôn ngữ:</strong> <span id="movie-language">Đang tải...</span></p>
                <p><strong>Trạng thái:</strong> <span id="movie-status">Đang tải...</span></p>
                <a id="watch-movie-btn" href="#" class="watch-btn">Xem phim</a>
            </div>
        </section>
        <section class="episode-list" id="episode-servers">
            <h2>Danh sách tập</h2>
            <div id="episode-list-content"></div>
        </section>
    </main>
    <footer>
        <div class="footer-buttons">
            <button class="footer-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                <i class="fas fa-arrow-up"></i> Lên đầu
            </button>
            <button class="footer-btn">
                <i class="fas fa-info-circle"></i> Liên hệ
            </button>
        </div>
    </footer>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        const apiSource = urlParams.get('apiSource');
        const movieName = urlParams.get('name');
        const customEpisodesParam = urlParams.get('episodes');
        let customEpisodes = [];

        const moviePoster = document.getElementById('movie-poster');
        const movieTitle = document.getElementById('movie-title');
        const movieDescription = document.getElementById('movie-description');
        const movieOriginName = document.getElementById('movie-origin-name');
        const movieDirectors = document.getElementById('movie-directors');
        const movieActors = document.getElementById('movie-actors');
        const movieCategories = document.getElementById('movie-categories');
        const movieCountries = document.getElementById('movie-countries');
        const movieYear = document.getElementById('movie-year');
        const movieTime = document.getElementById('movie-time');
        const movieQuality = document.getElementById('movie-quality');
        const movieLanguage = document.getElementById('movie-language');
        const movieStatus = document.getElementById('movie-status');
        const watchMovieBtn = document.getElementById('watch-movie-btn');
        const episodeListContent = document.getElementById('episode-list-content');

        // Parse customEpisodes từ URL
        if (customEpisodesParam) {
            try {
                customEpisodes = JSON.parse(decodeURIComponent(customEpisodesParam));
            } catch (error) {
                console.error('Lỗi khi parse customEpisodes:', error);
                customEpisodes = [];
            }
        }

        function normalizeMovieData(data, apiSource) {
            const movie = data.movie;
            let categories = [], countries = [], year = movie.year, episodes = [], servers = [];

            if (apiSource === 'phimnguonc') {
                if (movie.category && typeof movie.category === 'object') {
                    Object.values(movie.category).forEach(group => {
                        if (group.group.name === 'Thể loại') {
                            categories = group.list.map(item => item.name);
                        } else if (group.group.name === 'Quốc gia') {
                            countries = group.list.map(item => item.name);
                        } else if (group.group.name === 'Năm') {
                            year = group.list[0]?.name || year;
                        }
                    });
                }
                servers = movie.episodes?.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: (server.items || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.m3u8 || '',
                        link_embed: ep.embed || '',
                        link_video: ep.link_video || ''
                    }))
                })) || [];
            } else if (apiSource === 'ophim1') {
                categories = movie.category?.map(c => c.name) || [];
                countries = movie.country?.map(c => c.name) || [];
                servers = data.episodes?.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: (server.server_data || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    }))
                })) || [];
            } else if (apiSource === 'phimapi') {
                categories = movie.category?.map(c => c.name) || [];
                countries = movie.country?.map(c => c.name) || [];
                servers = data.episodes?.map((server, index) => ({
                    server_name: server.server_name || `Server ${index + 1}`,
                    server_data: (server.server_data || []).map(ep => ({
                        name: ep.name.replace('Tập ', '').trim() || 'Tập 1',
                        link_m3u8: ep.link_m3u8 || '',
                        link_embed: ep.link_embed || '',
                        link_video: ep.link_video || ''
                    }))
                })) || [];
            }

            episodes = servers.flatMap(server => server.server_data);

            const uniqueEpisodes = [];
            const seen = new Set();
            episodes.forEach(ep => {
                const key = `${ep.name}|${ep.link_m3u8}|${ep.link_embed}|${ep.link_video}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueEpisodes.push(ep);
                }
            });

            return {
                id: movie._id || movie.id,
                name: movie.name,
                slug: movie.slug,
                origin_name: movie.origin_name || movie.original_name,
                poster_url: movie.poster_url || movie.thumb_url || 'poster-not-found.jpg',
                content: movie.content || movie.description || 'Không có nội dung',
                type: movie.type || (uniqueEpisodes.length > 1 ? 'series' : 'movie'),
                status: movie.status || movie.current_episode || 'unknown',
                episode_total: parseInt((movie.total_episodes || movie.episode_total || uniqueEpisodes.length || '1').toString().replace('Tập', '').trim()) || 1,
                time: movie.time || 'Không rõ',
                quality: movie.quality || 'HD',
                lang: movie.lang || movie.language || 'Vietsub',
                year: year || 'Không rõ',
                actors: Array.isArray(movie.actor) ? movie.actor.join(', ') : (movie.casts || 'Không có thông tin'),
                directors: Array.isArray(movie.director) ? movie.director.join(', ') : (movie.director || 'Không có thông tin'),
                categories: categories.join(', '),
                countries: countries.join(', '),
                created: movie.created?.time || movie.created || 'Không rõ',
                modified: movie.modified?.time || movie.modified || 'Không rõ',
                episodes: uniqueEpisodes,
                servers,
            };
        }

        async function fetchMovieData() {
            let movieData = {};

            if (apiSource === 'custom' && customEpisodes.length > 0) {
                movieData = {
                    name: movieName || 'Không xác định',
                    poster_url: 'poster-not-found.jpg',
                    quality: 'HD',
                    content: 'Không có nội dung',
                    actors: 'Không có thông tin',
                    directors: 'Không có thông tin',
                    countries: 'Không rõ',
                    episodes: customEpisodes,
                    episode_total: customEpisodes.length,
                    type: customEpisodes.length > 1 ? 'series' : 'movie',
                    slug: slug || movieName?.toLowerCase().replace(/\s+/g, '-') || 'unknown',
                    servers: [{
                        server_name: 'Server Custom',
                        server_data: customEpisodes
                    }],
                    categories: 'Không rõ',
                    year: 'Không rõ',
                    time: 'Không rõ',
                    lang: 'Vietsub',
                    origin_name: 'Không có',
                    status: 'unknown'
                };
            } else {
                const apiUrl = apiSource === 'ophim1' ? `https://ophim1.com/phim/${slug}`
                    : apiSource === 'phimapi' ? `https://phimapi.com/phim/${slug}`
                    : `https://phim.nguonc.com/api/film/${slug}`;
                try {
                    const response = await fetch(apiUrl, { mode: 'cors' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.status === true || data.status === 'success') {
                        movieData = normalizeMovieData(data, apiSource);
                    } else {
                        throw new Error('Invalid API response');
                    }
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu phim:', error);
                    movieTitle.textContent = 'Lỗi tải phim';
                    movieDescription.textContent = 'Không thể tải thông tin phim. Vui lòng kiểm tra kết nối hoặc URL.';
                    episodeListContent.innerHTML = '<p class="error-message">Không thể tải danh sách tập.</p>';
                    watchMovieBtn.style.display = 'none';
                    return;
                }
                if (customEpisodes.length > 0) {
                    movieData.servers.push({
                        server_name: 'Server Custom',
                        server_data: customEpisodes
                    });
                    movieData.episodes = movieData.episodes.concat(customEpisodes);
                }
            }

            // Cập nhật thông tin phim
            moviePoster.src = movieData.poster_url;
            movieTitle.textContent = movieName || movieData.name || 'Không xác định';
            movieDescription.textContent = movieData.content;
            movieOriginName.textContent = movieData.origin_name || 'Không có';
            movieDirectors.textContent = movieData.directors;
            movieActors.textContent = movieData.actors;
            movieCategories.textContent = movieData.categories || 'Không có';
            movieCountries.textContent = movieData.countries || 'Không có';
            movieYear.textContent = movieData.year || 'Không rõ';
            movieTime.textContent = movieData.time;
            movieQuality.textContent = movieData.quality;
            movieLanguage.textContent = movieData.lang;
            movieStatus.textContent = movieData.status;

            // Cập nhật nút "Xem phim"
            const firstEpisode = movieData.episodes[0] || { name: 'Tập 1', link_m3u8: '', link_embed: '', link_video: '' };
            const linkType = firstEpisode.link_m3u8 ? 'm3u8' : firstEpisode.link_embed ? 'embed' : 'video';
            const linkUrl = firstEpisode.link_m3u8 || firstEpisode.link_embed || firstEpisode.link_video || '';
            const customEpisodesQuery = apiSource === 'custom' || customEpisodes.length > 0 ? `&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}` : '';
            watchMovieBtn.href = `watch.html?slug=${encodeURIComponent(slug || movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(firstEpisode.name)}&type=${linkType}&url=${encodeURIComponent(linkUrl)}&name=${encodeURIComponent(movieName || movieData.name)}${customEpisodesQuery}`;

            // Hiển thị danh sách tập
            episodeListContent.innerHTML = '';
            if (movieData.episodes && movieData.episodes.length > 0) {
                const episodeList = document.createElement('div');
                episodeList.classList.add('episode-list');
                const customEpisodesQuery = apiSource === 'custom' || customEpisodes.length > 0 ? `&customEpisodes=${encodeURIComponent(JSON.stringify(customEpisodes))}` : '';
                episodeList.innerHTML = `
                    <h3>Tất cả tập</h3>
                    <ul>
                        ${movieData.episodes.map(ep => {
                            const displayName = ep.name === 'Tập 1' ? '1' : ep.name;
                            const linkType = ep.link_m3u8 ? 'm3u8' : ep.link_embed ? 'embed' : 'video';
                            const linkUrl = ep.link_m3u8 || ep.link_embed || ep.link_video || '';
                            return `<li><a href="watch.html?slug=${encodeURIComponent(slug || movieData.slug)}&apiSource=${encodeURIComponent(apiSource)}&episode=${encodeURIComponent(ep.name)}&type=${linkType}&url=${encodeURIComponent(linkUrl)}&name=${encodeURIComponent(movieName || movieData.name)}${customEpisodesQuery}">${displayName}</a></li>`;
                        }).join('')}
                    </ul>
                `;
                episodeListContent.appendChild(episodeList);
            } else {
                episodeListContent.innerHTML = '<p class="error-message">Không có tập phim nào khả dụng.</p>';
            }
        }

        fetchMovieData();
    </script>
</body>
</html>