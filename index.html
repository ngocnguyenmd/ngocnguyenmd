<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trang Chủ Phim</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #160822; font-family: 'Segoe UI', sans-serif; color: #e0e0e0; }
        header { background: #3a185e; padding: 8px 0; position: fixed; width: 100%; top: 0; z-index: 1000; }
        nav { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 3px; }
        nav a { color: #e0e0e0; text-decoration: none; font-size: 0.9rem; padding: 6px 8px; cursor: pointer; }
        nav a:hover { background: #4e1b88; border-radius: 5px; }
        nav a.active { background: #6b48a3; border-radius: 5px; font-weight: bold; }
        .container { margin-top: 60px; padding: 5px; max-width: 100vw; }
        .search-bar { display: flex; justify-content: center; margin-bottom: 15px; }
        .search-bar input { width: 65%; max-width: 300px; padding: 6px; font-size: 0.9rem; border: none; border-radius: 5px 0 0 5px; background: #3a2a4a; color: #e0e0e0; outline: none; }
        .search-bar button { padding: 6px 10px; font-size: 0.9rem; border: none; border-radius: 0 5px 5px 0; background: #6b48a3; color: #fff; cursor: pointer; }
        .search-bar button:hover { background: #3d1570; }
        h1 { font-size: 1.3rem; text-align: center; margin-bottom: 8px; color: #3f1d66; }
        .movie-section { margin-bottom: 20px; }
        .movie-section h2 {
    font-size: 0.99rem; /* Slightly larger */
    color: #dbe95a; /* Brighter white */
    margin: 10px 0; /* More spacing */
    text-align: center;
    background: linear-gradient(90deg, #512188, #473f8d); /* Gradient background */
    padding: 3px; /* Inner padding */
    border-radius: 10px; /* Rounded corners */
    text-transform: uppercase; /* Bold look */
    letter-spacing: 3px; /* Slight spacing */
}
        .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
        .movie-card { background: #2c1644; padding: 5px; border-radius: 5px; text-align: center; cursor: pointer; }
        .movie-card:hover { transform: scale(1.03); }
        .movie-card img { width: 100%; height: 160px; object-fit: cover; border-radius: 5px; }
        .movie-card h3 { font-size: 0.8rem; margin: 3px 0; color: #2e2d83; }
        .episode-tag { position: absolute; top: 3px; right: 3px; background: rgba(0, 0, 0, 0.7); color: #fff; padding: 2px 4px; border-radius: 3px; font-size: 0.6rem; }
        @media (max-width: 720px) {
            nav a { font-size: 0.8rem; padding: 5px 8px; }
            .container { margin-top: 50px; }
            .movie-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .movie-card img { height: 140px; }
            .movie-card h3 { font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a onclick="loadMovies('trungquoc')" id="trungquoc">Phim Trung Quốc</a>
            <a onclick="loadMovies('hanquoc')" id="hanquoc">Phim Hàn Quốc</a>
            <a onclick="loadMovies('my')" id="my">Phim Mỹ</a>
            <a onclick="loadMovies('vietnam')" id="vietnam">Phim Việt</a>
            <a onclick="loadMovies('truyenhinh')" id="truyenhinh">Truyền Hình</a>
            <a onclick="loadMovies('hoathinh')" id="hoathinh">Hoạt Hình</a>
        </nav>
    </header>

    <div class="container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Tìm kiếm phim...">
            <button onclick="searchMovies()">Tìm</button>
        </div>
        <h1 id="categoryTitle">Phim Trung Quốc</h1>
        <div class="movie-section" id="api-movies">
            <h2>Phim Nhà Bánh Mì</h2>
            <div class="movie-grid" id="apiMovieList"></div>
        </div>
        <div class="movie-section" id="custom-movies">
            <h2>Xưởng bánh mì</h2>
            <div class="movie-grid" id="customMovieList"></div>
        </div>
    </div>

    <script>
        let apiUrls = {};
        let customMovies = {};
        let allMovies = { apiMovies: [], customMovies: [] };

        async function loadApiUrls() {
            try {
                const response = await fetch('apiurl.json');
                apiUrls = await response.json();
            } catch (error) {
                apiUrls = { trungquoc: ["https://ophim1.com/phim/yeu-em"] };
            }
        }

        async function loadCustomMovies() {
            try {
                const response = await fetch('custom_movies.txt');
                const text = await response.text();
                customMovies = text.split('\n').reduce((acc, line) => {
                    const [category, title, image, urls, tag] = line.split('|');
                    if (!acc[category]) acc[category] = [];
                    const episodes = urls.split(';').map((url, index) => ({
                        episode: `Tập ${index + 1}`,
                        m3u8: url
                    }));
                    acc[category].push({ title, image, episodes, tag, source: 'creator' });
                    return acc;
                }, {});
            } catch (error) {
                customMovies = { trungquoc: [], hanquoc: [], my: [], vietnam: [], truyenhinh: [], hoathinh: [] };
            }
        }

        async function fetchMovie(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status && data.movie) {
                    return {
                        title: data.movie.name,
                        image: data.movie.thumb_url,
                        description: data.movie.content,
                        episode_current: data.movie.episode_current,
                        episodes: data.episodes[0].server_data.map(ep => ({ episode: ep.name, m3u8: ep.link_m3u8 })),
                        source: 'api'
                    };
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        async function fetchMovies(category) {
            const urls = apiUrls[category] || [];
            const apiMovies = (await Promise.all(urls.map(fetchMovie))).filter(m => m);
            const customCategoryMovies = (customMovies[category] || []).map(movie => ({
                ...movie,
                description: movie.title
            }));
            return { apiMovies, customMovies: customCategoryMovies };
        }

        function highlightCategory(category) {
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            document.getElementById(category)?.classList.add('active');
        }

        async function loadMovies(category) {
            document.getElementById('categoryTitle').textContent = {
                trungquoc: 'Phim Trung Quốc', hanquoc: 'Phim Hàn Quốc', my: 'Phim Mỹ',
                vietnam: 'Phim Việt', truyenhinh: 'Truyền Hình', hoathinh: 'Hoạt Hình'
            }[category];
            highlightCategory(category);
            allMovies = await fetchMovies(category);
            displayMovies(allMovies.apiMovies, allMovies.customMovies);
        }

        function displayMovies(apiMovies, customMovies) {
            const apiMovieList = document.getElementById('apiMovieList');
            const customMovieList = document.getElementById('customMovieList');
            apiMovieList.innerHTML = '';
            customMovieList.innerHTML = '';

            apiMovies.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `<img src="${movie.image}" alt="${movie.title}"><span class="episode-tag">${movie.episode_current}</span><h3>${movie.title}</h3>`;
                card.onclick = () => window.location.href = `detail.html?movie=${encodeURIComponent(JSON.stringify(movie))}`;
                apiMovieList.appendChild(card);
            });

            customMovies.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                const episodeCount = movie.episodes.length > 1 ? `${movie.episodes.length} tập` : movie.tag;
                card.innerHTML = `<img src="${movie.image}" alt="${movie.title}"><span class="episode-tag">${episodeCount}</span><h3>${movie.title}</h3>`;
                card.onclick = () => window.location.href = `detail.html?movie=${encodeURIComponent(JSON.stringify(movie))}`;
                customMovieList.appendChild(card);
            });

            document.getElementById('api-movies').style.display = apiMovies.length ? 'block' : 'none';
            document.getElementById('custom-movies').style.display = customMovies.length ? 'block' : 'none';
        }

        function searchMovies() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filteredApi = allMovies.apiMovies.filter(m => m.title.toLowerCase().includes(query));
            const filteredCustom = allMovies.customMovies.filter(m => m.title.toLowerCase().includes(query));
            displayMovies(filteredApi, filteredCustom);
        }

        window.onload = async () => {
            await Promise.all([loadApiUrls(), loadCustomMovies()]);
            loadMovies(new URLSearchParams(window.location.search).get('category') || 'trungquoc');
            document.getElementById('searchInput').addEventListener('keypress', e => e.key === 'Enter' && searchMovies());
        };
    </script>
</body>
</html>